<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://idrawone.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="knowledge is power">
<meta property="og:type" content="website">
<meta property="og:title" content="David&#39;s Blog">
<meta property="og:url" content="https://idrawone.github.io/index.html">
<meta property="og:site_name" content="David&#39;s Blog">
<meta property="og:description" content="knowledge is power">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="David Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://idrawone.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>David's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="David's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">David's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">knowledge is power</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">11</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/10/23/Heap-freespace-in-details/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/23/Heap-freespace-in-details/" class="post-title-link" itemprop="url">Heap free space in details</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-23 01:00:00 / Modified: 15:01:41" itemprop="dateCreated datePublished" datetime="2020-10-23T01:00:00-07:00">2020-10-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/" itemprop="url" rel="index">
                    <span itemprop="name">Heap</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/Page/" itemprop="url" rel="index">
                    <span itemprop="name">Page</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/Page/Extension/" itemprop="url" rel="index">
                    <span itemprop="name">Extension</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/Page/Extension/Freespace/" itemprop="url" rel="index">
                    <span itemprop="name">Freespace</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-heap-page.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>Previously, we discussed the <code>MAIN</code> fork file and corresponding extension <a href="https://www.highgo.ca/2020/10/09/heap-file-and-page-in-details" target="_blank" rel="noopener">Heap file and page in details</a>. This blog will explain a little bit more about the Free Space File and corresponding extension.</p>
<h4 id="2-What-is-a-Free-Space-Mapping-file"><a href="#2-What-is-a-Free-Space-Mapping-file" class="headerlink" title="2. What is a Free Space Mapping file"></a>2. What is a Free Space Mapping file</h4><p>A Free Space Mapping, FSM, file is a file that keeps tracking the availability of free space inside a page. The FSM file is used to quickly locate a page with enough<br>free space to hold a record to be stored during insertion, and it will be updated during an insertion or a vacuum on the table.</p>
<p>Start from PostgreSQL 8.4 each relation has its own extensible FSM files stored on disk. The FSM file is stored under its relation folder. From previous example, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create table orders1 (id int4, test text) using heap;</span><br><span class="line">postgres&#x3D;# insert into orders1 values(1, &#39;hello world!&#39;);</span><br></pre></td></tr></table></figure>
<p>You will see the heap files under the database folder like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltrh &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384*</span><br><span class="line">-rw------- 1 user user  24K Oct  8 14:33 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384_fsm</span><br><span class="line">-rw------- 1 user user 8.0K Oct  8 14:34 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384_vm</span><br><span class="line">-rw------- 1 user user 512K Oct  8 14:34 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384</span><br></pre></td></tr></table></figure>
<p>Where <code>16384</code> is the table orders1’s oid, and <code>16384_fsm</code> is the corresponding <code>Free Space Mapping</code> file.</p>
<h4 id="3-How-the-Free-Space-Mapping-files-are-managed"><a href="#3-How-the-Free-Space-Mapping-files-are-managed" class="headerlink" title="3. How the Free Space Mapping files are managed"></a>3. How the Free Space Mapping files are managed</h4><p>Before PostgreSQL 8.4, the FSM is maintained in memory with the limitation of fixed-size. Now, all FSM files are on disk and can be extended in the same way as heap segmentation files. The FSM files will be updated during an insertion and a Vacuum process either periodically or triggered manually. In some conditions, the FSM may need to be rebuilt, for example, if a leaf node’s value is less than the root node or if there is truncate operation.</p>
<p>FSM file is mainly used to quickly locate a page for insert operation and in the meantime it helps to speed up the insertion by trying to inert records in existing pages instead of extend a new page. By doing this, it not only help speed up the insertion but also help improve the selection performance. Moreover, the user to implement various strategies, like preferring pages closer to a given page, or spreading the load across the table. </p>
<h4 id="4-What-is-inside-in-an-FSM-page"><a href="#4-What-is-inside-in-an-FSM-page" class="headerlink" title="4. What is inside in an FSM page"></a>4. What is inside in an FSM page</h4><p>Inside the FSM page, there are two binary tree structure are used: low-level binary tree is used to record the amount of free space on each heap page; high-level binary tree is used scale up the low-level data structure. For details, please reference the <a href="https://github.com/postgres/postgres/blob/master/src/backend/storage/freespace/README" target="_blank" rel="noopener">README</a>.</p>
<h4 id="5-The-extension-for-FSM"><a href="#5-The-extension-for-FSM" class="headerlink" title="5. The extension for FSM"></a>5. The extension for FSM</h4><p>The <code>pg_freespacemap</code> extension provides the functions that allow you to inspect the free space in each page for a given relation/table. So far, there is only one function provide in <code>pg_freespacemap</code>, i.e. <code>pg_freespace</code>. This function can be used retrieve the amount of free space on each page by giving different parameters. To use this extension, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create extension pg_freespacemap;</span><br><span class="line">CREATE EXTENSION</span><br><span class="line">postgres&#x3D;# create table orders1 (id int4, test text);</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# insert into orders1 values(generate_series(1,1000), &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 1000</span><br></pre></td></tr></table></figure>

<ul>
<li>retrieve free space for all pages <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# vacuum orders1;</span><br><span class="line">VACUUM</span><br><span class="line">postgres&#x3D;# SELECT * FROM pg_freespace(&#39;orders1&#39;);</span><br><span class="line"> blkno | avail </span><br><span class="line">-------+-------</span><br><span class="line">     0 |     0</span><br><span class="line">     1 |     0</span><br><span class="line">     2 |     0</span><br><span class="line">     3 |     0</span><br><span class="line">     4 |     0</span><br><span class="line">     5 |     0</span><br><span class="line">     6 |  5120</span><br><span class="line">(7 rows)</span><br></pre></td></tr></table></figure>
From the above results, it tells that the first 5 pages are all full, only the last page, page6, has some free space are available. </li>
</ul>
<p>Let’s delete different number of records in each page, and then check free space again to what is happening inside.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# delete from orders1 where id%2&#x3D;1 and id &lt; 158;</span><br><span class="line">DELETE 79</span><br><span class="line">postgres&#x3D;# delete from orders1 where id%4&#x3D;1 and id &gt;&#x3D; 158 and id &lt; 315;</span><br><span class="line">DELETE 39</span><br><span class="line">postgres&#x3D;# delete from orders1 where id%8&#x3D;1 and id &gt;&#x3D; 315 and id &lt; 472;</span><br><span class="line">DELETE 19</span><br><span class="line">postgres&#x3D;# delete from orders1 where id%16&#x3D;1 and id &gt;&#x3D; 472 and id &lt; 629;</span><br><span class="line">DELETE 10</span><br><span class="line">postgres&#x3D;# delete from orders1 where id%32&#x3D;1 and id &gt;&#x3D; 629 and id &lt; 786;</span><br><span class="line">DELETE 5</span><br><span class="line">postgres&#x3D;# delete from orders1 where id%64&#x3D;1 and id &gt;&#x3D; 786;</span><br><span class="line">DELETE 3</span><br><span class="line">postgres&#x3D;# vacuum orders1;</span><br><span class="line">VACUUM</span><br><span class="line">postgres&#x3D;# SELECT * FROM pg_freespace(&#39;orders1&#39;);</span><br><span class="line"> blkno | avail </span><br><span class="line">-------+-------</span><br><span class="line">     0 |  3776</span><br><span class="line">     1 |  1856</span><br><span class="line">     2 |   896</span><br><span class="line">     3 |   480</span><br><span class="line">     4 |   224</span><br><span class="line">     5 |    96</span><br><span class="line">     6 |  5184</span><br><span class="line">(7 rows)</span><br></pre></td></tr></table></figure>
<p>Now, we see can the amount of free space is different and it depends on how many records has been deleted.</p>
<ul>
<li><p>retrieve free space for a specific page<br>The <code>pg_freespace</code> also allow you to check the amount of free space available in a specified page, for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT * FROM pg_freespace(&#39;orders1&#39;, 3);</span><br><span class="line"> pg_freespace </span><br><span class="line">--------------</span><br><span class="line">          480</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
</li>
<li><p>insert using free space<br>From the above delete examples, we know how many records deleted in each page, in other words, the maximum records can fit in for each page. Let’s perform some insertion test.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# insert into orders1 values(generate_series(1,65), &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 65</span><br><span class="line">postgres&#x3D;# vacuum orders1;</span><br><span class="line">VACUUM</span><br><span class="line">postgres&#x3D;# SELECT * FROM pg_freespace(&#39;orders1&#39;);</span><br><span class="line"> blkno | avail </span><br><span class="line">-------+-------</span><br><span class="line">     0 |   672</span><br><span class="line">     1 |  1856</span><br><span class="line">     2 |   896</span><br><span class="line">     3 |   480</span><br><span class="line">     4 |   224</span><br><span class="line">     5 |    96</span><br><span class="line">     6 |  5184</span><br><span class="line">(7 rows)</span><br></pre></td></tr></table></figure>
<p>From the results above, we can see the records was inserted to the first page, instead of allocating a new page.</p>
</li>
</ul>
<h4 id="6-Summary"><a href="#6-Summary" class="headerlink" title="6.    Summary"></a>6.    Summary</h4><p>We explained why there is a free space mapping file under corresponding relation folder, how the free space mapping files are managed, and demonstrated how to use the extension <code>pg_freespacemap</code> to check what happens when user performed some insert, delete and vacuum. In next blog, I will explain the visibility mapping files.</p>
<p>Ref: <a href="https://www.postgresql.org/docs/current/storage-file-layout.html" target="_blank" rel="noopener">PG Database File Layout</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/10/09/Heap-Page-in-details/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/09/Heap-Page-in-details/" class="post-title-link" itemprop="url">Heap file and page in details</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-09 01:00:00 / Modified: 16:47:06" itemprop="dateCreated datePublished" datetime="2020-10-09T01:00:00-07:00">2020-10-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/" itemprop="url" rel="index">
                    <span itemprop="name">Heap</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/Page/" itemprop="url" rel="index">
                    <span itemprop="name">Page</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Heap/Page/Extension/" itemprop="url" rel="index">
                    <span itemprop="name">Extension</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-heap-page.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL is a great open source database, and many users chose it because of the efficiency of its central algorithms and data structures. As a software developer, I was always curious about how each part was done, such as the physical files storage. The reason is that I always see a lot of files and folders were created after a simple initdb command. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltr &#x2F;home&#x2F;user&#x2F;pgdata</span><br><span class="line">drwx------ 4 user user  4096 Oct  8 13:38 pg_logical</span><br><span class="line">drwx------ 5 user user  4096 Oct  8 13:38 base</span><br><span class="line">drwx------ 2 user user  4096 Oct  8 13:38 global</span><br><span class="line">…. …</span><br><span class="line">-rw------- 1 user user     3 Oct  8 13:38 PG_VERSION</span><br></pre></td></tr></table></figure>
<p>I can do a simple command like below to check the file <code>PG_VERSION</code>, but what about the rest of the files and folders? </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;PG_VERSION </span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<p>In this blog, I am going to share what I learned about the <code>heap files</code> under <code>base</code> folder.</p>
<h4 id="1-How-the-Heap-files-are-created"><a href="#1-How-the-Heap-files-are-created" class="headerlink" title="1. How the Heap files are created?"></a>1. How the Heap files are created?</h4><p>To explain this, let’s take a look at two key data structures. </p>
<ul>
<li><code>RelFileNode</code> defined in <code>src/include/storage/felfilenode.h</code>. <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct RelFileNode</span><br><span class="line">&#123;</span><br><span class="line">  Oid     spcNode;    &#x2F;* tablespace *&#x2F;</span><br><span class="line">  Oid     dbNode;     &#x2F;* database *&#x2F;</span><br><span class="line">  Oid     relNode;    &#x2F;* relation *&#x2F;</span><br><span class="line">&#125; RelFileNode;</span><br></pre></td></tr></table></figure>
Where, <code>spcNode</code> is the tablespace oid, <code>dbNode</code> is the database oid, and <code>relNode</code> is table oid. The table oid will be used as the file name to create the corresponding heap file. However, the Heap files will not be created unless you insert the first record to the table. For example, <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create table orders1 (id int4, test text) using heap;</span><br><span class="line">postgres&#x3D;# insert into orders1 values(1, &#39;hello world!&#39;);</span><br></pre></td></tr></table></figure>
You will see the heap files under the database folder like below,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ltrh &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384*</span><br><span class="line">-rw------- 1 user user  24K Oct  8 14:33 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384_fsm</span><br><span class="line">-rw------- 1 user user 8.0K Oct  8 14:34 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384_vm</span><br><span class="line">-rw------- 1 user user 512K Oct  8 14:34 &#x2F;home&#x2F;user&#x2F;pgdata&#x2F;base&#x2F;12705&#x2F;16384</span><br></pre></td></tr></table></figure>
Where 16384 is the table orders1’s oid. To verify it, there is a built-in function <code>pg_relation_filepath</code> which returns the first heap file segment with a relative path to the environment variable PGDATA. For example,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT pg_relation_filepath(&#39;orders1&#39;);</span><br><span class="line"> pg_relation_filepath </span><br><span class="line">----------------------</span><br><span class="line"> base&#x2F;12705&#x2F;16384</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></li>
<li><code>ForkNumber</code> defined in src/include/common/relpath.h.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef enum ForkNumber</span><br><span class="line">&#123;</span><br><span class="line">  InvalidForkNumber &#x3D; -1,</span><br><span class="line">  MAIN_FORKNUM &#x3D; 0,</span><br><span class="line">  FSM_FORKNUM,</span><br><span class="line">  VISIBILITYMAP_FORKNUM,</span><br><span class="line">  INIT_FORKNUM</span><br><span class="line">&#125; ForkNumber;</span><br></pre></td></tr></table></figure>
Where, <code>MAIN_FORKNUM</code> represents heap files, <code>FSM_FORKNUM</code> represents free space mapping files, and <code>VISIBILITYMAP_FORKNUM</code> represents visibility mapping files. In above example, the physical files map to the enum values <code>MAIN_FORKNUM</code>, <code>FSM_FORKNUM</code> and <code>VISIBILITYMAP_FORKNUM</code> are 16384, 16384_fsm and 16384_vm correspondingly. The rest of this blog will focus on <code>heap file</code>. </li>
</ul>
<h4 id="2-How-the-Heap-files-are-managed"><a href="#2-How-the-Heap-files-are-managed" class="headerlink" title="2. How the Heap files are managed?"></a>2. How the Heap files are managed?</h4><p>Heap file, as the fork name <code>MAIN_FORKNUM</code> indicated, is the main file used to store all the data records. The heap file will be divided into different segments when it exceeds 1GB that is the default settings. The first file is always named using the filenode (table oid), and subsequent segments will be named as filenode.1, filenode.2 etc. In theory, the segmentation rule also applies to free space mapping and visibility mapping files, but it seldom happens since free space mapping file and visibility mapping file are not increasing as fast as heap files.</p>
<h4 id="3-How-does-a-Page-look-like"><a href="#3-How-does-a-Page-look-like" class="headerlink" title="3. How does a Page look like?"></a>3. How does a Page look like?</h4><p>To make the data management easier, each heap file is splitted into different pages with a default size 8KB. The data structure for each page is defined by below data structures:</p>
<ul>
<li><p>ItemIdData</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct ItemIdData</span><br><span class="line">&#123;</span><br><span class="line">  unsigned  lp_off:15,  &#x2F;* offset to tuple (from start of page) *&#x2F;</span><br><span class="line">      lp_flags:2, &#x2F;* state of line pointer, see below *&#x2F;</span><br><span class="line">      lp_len:15;  &#x2F;* byte length of tuple *&#x2F;</span><br><span class="line">&#125; ItemIdData;</span><br></pre></td></tr></table></figure>
<p>ItemIdData is the line pointer in a page, which is defined in <code>src/include/storage/itemid.h</code>.</p>
</li>
<li><p>HeapTupleFields</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef struct HeapTupleFields</span><br><span class="line">&#123;</span><br><span class="line">  TransactionId t_xmin;   &#x2F;* inserting xact ID *&#x2F;</span><br><span class="line">  TransactionId t_xmax;   &#x2F;* deleting or locking xact ID *&#x2F;</span><br><span class="line"></span><br><span class="line">  union</span><br><span class="line">  &#123;</span><br><span class="line">    CommandId t_cid;    &#x2F;* inserting or deleting command ID, or both *&#x2F;</span><br><span class="line">    TransactionId t_xvac; &#x2F;* old-style VACUUM FULL xact ID *&#x2F;</span><br><span class="line">  &#125;     t_field3;</span><br><span class="line">&#125; HeapTupleFields;</span><br></pre></td></tr></table></figure>
<p>HeapTupleFields is part of the header for each tuple, defined in <code>src/include/access/htup_details.h</code>.</p>
</li>
<li><p>HeapTupleHeaderData</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">struct HeapTupleHeaderData</span><br><span class="line">&#123;</span><br><span class="line">  union</span><br><span class="line">  &#123;</span><br><span class="line">    HeapTupleFields t_heap;</span><br><span class="line">    DatumTupleFields t_datum;</span><br><span class="line">  &#125; t_choice;</span><br><span class="line"></span><br><span class="line">  ItemPointerData t_ctid;   &#x2F;* current TID of this or newer tuple (or a</span><br><span class="line">                 * speculative insertion token) *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;* Fields below here must match MinimalTupleData! *&#x2F;</span><br><span class="line"></span><br><span class="line">#define FIELDNO_HEAPTUPLEHEADERDATA_INFOMASK2 2</span><br><span class="line">  uint16    t_infomask2;  &#x2F;* number of attributes + various flags *&#x2F;</span><br><span class="line"></span><br><span class="line">#define FIELDNO_HEAPTUPLEHEADERDATA_INFOMASK 3</span><br><span class="line">  uint16    t_infomask;   &#x2F;* various flag bits, see below *&#x2F;</span><br><span class="line"></span><br><span class="line">#define FIELDNO_HEAPTUPLEHEADERDATA_HOFF 4</span><br><span class="line">  uint8   t_hoff;     &#x2F;* sizeof header incl. bitmap, padding *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;* ^ - 23 bytes - ^ *&#x2F;</span><br><span class="line"></span><br><span class="line">#define FIELDNO_HEAPTUPLEHEADERDATA_BITS 5</span><br><span class="line">  bits8   t_bits[FLEXIBLE_ARRAY_MEMBER];  &#x2F;* bitmap of NULLs *&#x2F;</span><br><span class="line"></span><br><span class="line">  &#x2F;* MORE DATA FOLLOWS AT END OF STRUCT *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>HeapTupleHeaderData is the tuple data structure, defined in defined in <code>src/include/access/htup_details.h</code>.</p>
</li>
</ul>
<p>A high level picture for a tuple looks like the picture below. <img src="/images/img/tuple.png" alt="tuple image"></p>
<p>But, this may be still hard to understand for an end user. Don’t worry, PG provides an extension <code>pageinspect</code>. </p>
<h4 id="4-The-extension-for-Page"><a href="#4-The-extension-for-Page" class="headerlink" title="4. The extension for Page"></a>4. The extension for Page</h4><p>The <code>pageinspect</code> extension provides the functions that allow you to inspect the contents of database pages at a low level, which is very useful for debugging purposes. Here are the main functions provided by <code>pageinspect</code>. To use this extension, you have to install it first, and then add it to your PG server. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create extension pageinspect;</span><br><span class="line">CREATE EXTENSION</span><br></pre></td></tr></table></figure>

<p>Here are the functions for heap page:</p>
<ul>
<li>heap_page_items<br><code>heap_page_items</code> returns all the records within given page. It includes line pointers, tuple headers as well as tuple raw data, i.e. <code>lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |  t_data</code>.<br>All the tuples will be displayed at the moment when the page is loaded from heap file into buffer manager, no matter whether the tuple is visible or not. For example,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# insert into orders1 values(generate_series(1, 200), &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 200</span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_items(get_raw_page(&#39;orders1&#39;, 0));</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                t_data                </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+--------------------------------------</span><br><span class="line">   1 |   8144 |        1 |     41 |    691 |      0 |        0 | (0,1)   |           2 |       2050 |     24 |        |       | \x010000001b68656c6c6f20776f726c6421</span><br><span class="line">   2 |   8096 |        1 |     41 |    691 |      0 |        0 | (0,2)   |           2 |       2050 |     24 |        |       | \x020000001b68656c6c6f20776f726c6421</span><br><span class="line">   3 |   8048 |        1 |     41 |    691 |      0 |        0 | (0,3)   |           2 |       2050 |     24 |        |       | \x030000001b68656c6c6f20776f726c6421</span><br><span class="line">   4 |   8000 |        1 |     41 |    691 |      0 |        0 | (0,4)   |           2 |       2050 |     24 |        |       | \x040000001b68656c6c6f20776f726c6421</span><br><span class="line">   5 |   7952 |        1 |     41 |    691 |      0 |        0 | (0,5)   |           2 |       2050 |     24 |        |       | \x050000001b68656c6c6f20776f726c6421</span><br><span class="line">   6 |   7904 |        1 |     41 |    691 |      0 |        0 | (0,6)   |           2 |       2050 |     24 |        |       | \x060000001b68656c6c6f20776f726c6421</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>tuple_data_split<br><code>tuple_data_split</code> splits tuple data into attributes and returns bytea array. For example,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT tuple_data_split(&#39;orders1&#39;::regclass, t_data, t_infomask, t_infomask2, t_bits) FROM heap_page_items(get_raw_page(&#39;orders1&#39;, 0));</span><br><span class="line">                tuple_data_split                 </span><br><span class="line">-------------------------------------------------</span><br><span class="line"> &#123;&quot;\\x01000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> &#123;&quot;\\x03000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>heap_page_item_attrs</li>
</ul>
<p><code>heap_page_item_attrs</code> is equivalent to <code>heap_page_items</code> except that it returns tuple raw data as an array of attributes. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   8144 |        1 |     41 |    591 |      0 |        0 | (0,1)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x01000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8096 |        1 |     41 |    591 |      0 |        0 | (0,2)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |   8048 |        1 |     41 |    591 |      0 |        0 | (0,3)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x03000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   ... ...</span><br></pre></td></tr></table></figure>

<ul>
<li>heap_tuple_infomask_flags<br><code>heap_tuple_infomask_flags</code> will help decode the tuple header attributes, i.e. <code>t_infomask</code> and <code>t_infomask2</code> into a human-readable set of arrays made of flag names, with one column for all the flags and one column for combined flags. For example,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT t_ctid, raw_flags, combined_flags FROM heap_page_items(get_raw_page(&#39;orders1&#39;, 0)), LATERAL heap_tuple_infomask_flags(t_infomask, t_infomask2) WHERE t_infomask IS NOT NULL OR t_infomask2 IS NOT NULL;</span><br><span class="line"> t_ctid  |                        raw_flags                         | combined_flags </span><br><span class="line">---------+----------------------------------------------------------+----------------</span><br><span class="line"> (0,1)   | &#123;HEAP_HASVARWIDTH,HEAP_XMIN_COMMITTED,HEAP_XMAX_INVALID&#125; | &#123;&#125;</span><br><span class="line"> (0,2)   | &#123;HEAP_HASVARWIDTH,HEAP_XMIN_COMMITTED,HEAP_XMAX_INVALID&#125; | &#123;&#125;</span><br><span class="line"> (0,3)   | &#123;HEAP_HASVARWIDTH,HEAP_XMIN_COMMITTED,HEAP_XMAX_INVALID&#125; | &#123;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="5-What-happens-on-heap-page-when-performing-insert-delete-and-vacuum"><a href="#5-What-happens-on-heap-page-when-performing-insert-delete-and-vacuum" class="headerlink" title="5. What happens on heap page when performing insert, delete and vacuum"></a>5. What happens on heap page when performing insert, delete and vacuum</h4><p>Now, we have learned something about heap file and the page inspect extension. Let’s see how the tuples are managed when user performs some insert, delete and vacuum on a table.</p>
<ul>
<li><p>Insert<br>First, let insert 200 records to a brand new table orders1,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# insert into orders1 values(generate_series(1, 200), &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 200</span><br></pre></td></tr></table></figure>
<p>then use the function <code>heap_page_item_attrs</code> to see how the page looks like,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   8144 |        1 |     41 |    591 |      0 |        0 | (0,1)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x01000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8096 |        1 |     41 |    591 |      0 |        0 | (0,2)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |   8048 |        1 |     41 |    591 |      0 |        0 | (0,3)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x03000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">... ...</span><br><span class="line"> 155 |    752 |        1 |     41 |    591 |      0 |        0 | (0,155) |           2 |       2306 |     24 |        |       | &#123;&quot;\\x9b000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 156 |    704 |        1 |     41 |    591 |      0 |        0 | (0,156) |           2 |       2306 |     24 |        |       | &#123;&quot;\\x9c000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 157 |    656 |        1 |     41 |    591 |      0 |        0 | (0,157) |           2 |       2306 |     24 |        |       | &#123;&quot;\\x9d000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">(157 rows)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 1), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">  1 |   8144 |        1 |     41 |    591 |      0 |        0 | (1,1)  |           2 |       2306 |     24 |        |       | &#123;&quot;\\x9e000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">  2 |   8096 |        1 |     41 |    591 |      0 |        0 | (1,2)  |           2 |       2306 |     24 |        |       | &#123;&quot;\\x9f000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">  3 |   8048 |        1 |     41 |    591 |      0 |        0 | (1,3)  |           2 |       2306 |     24 |        |       | &#123;&quot;\\xa0000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> ... ... </span><br><span class="line"> 41 |   6224 |        1 |     41 |    591 |      0 |        0 | (1,41) |           2 |       2306 |     24 |        |       | &#123;&quot;\\xc6000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 42 |   6176 |        1 |     41 |    591 |      0 |        0 | (1,42) |           2 |       2306 |     24 |        |       | &#123;&quot;\\xc7000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 43 |   6128 |        1 |     41 |    591 |      0 |        0 | (1,43) |           2 |       2306 |     24 |        |       | &#123;&quot;\\xc8000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">(43 rows)</span><br></pre></td></tr></table></figure>
<p>As you can see, after 200 records were inserted, PG created two pages: the 1st page has 157 tuples, and the 2nd page has 43 tuples. If you try to access the 3rd page, then you will some errors like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 2), &#39;orders1&#39;::regclass);</span><br><span class="line">ERROR:  block number 2 is out of range for relation &quot;orders1&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Delete</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# delete from orders1 where id%2&#x3D;1;</span><br><span class="line">DELETE 100</span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   8144 |        1 |     41 |    598 |    599 |        0 | (0,1)   |        8194 |        258 |     24 |        |       | &#123;&quot;\\x01000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8096 |        1 |     41 |    598 |      0 |        0 | (0,2)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |   8048 |        1 |     41 |    598 |    599 |        0 | (0,3)   |        8194 |        258 |     24 |        |       | &#123;&quot;\\x03000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   4 |   8000 |        1 |     41 |    598 |      0 |        0 | (0,4)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x04000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   5 |   7952 |        1 |     41 |    598 |    599 |        0 | (0,5)   |        8194 |        258 |     24 |        |       | &#123;&quot;\\x05000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   6 |   7904 |        1 |     41 |    598 |      0 |        0 | (0,6)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x06000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>Now, for all the odd records, the <code>t_max</code> points to a different transaction (delete) id, and <code>t_infomask2</code> indicates the tuple has been deleted. For more detailed information, please check <code>t_infomask2</code> definition.</p>
</li>
<li><p>Insert a new record<br>If you insert a record now, you will find the new record is inserted into the first empty slot. In this example, the first line <code>\\xe8030000</code> is the new record with <code>id=1000</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# insert into orders1 values(1000, &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   4400 |        1 |     41 |    601 |      0 |        0 | (0,1)   |           2 |       2050 |     24 |        |       | &#123;&quot;\\xe8030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8144 |        1 |     41 |    598 |      0 |        0 | (0,2)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |      0 |        0 |      0 |        |        |          |         |             |            |        |        |       | </span><br><span class="line">   4 |   8096 |        1 |     41 |    598 |      0 |        0 | (0,4)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x04000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   5 |      0 |        0 |      0 |        |        |          |         |             |            |        |        |       | </span><br><span class="line">   6 |   8048 |        1 |     41 |    598 |      0 |        0 | (0,6)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x06000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>The <code>t_min</code> points to the new transaction (insert) id, and <code>t_max</code> is cleared to indicate this is a valid record.</p>
<ul>
<li>Vacuum<br>Let’s perform a vacuum on this table only, and then insert another new record, <code>id=1001</code>.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# vacuum orders1;</span><br><span class="line">VACUUM</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# insert into orders1 values(1001, &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   4400 |        1 |     41 |    601 |      0 |        0 | (0,1)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\xe8030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8144 |        1 |     41 |    598 |      0 |        0 | (0,2)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |   4352 |        1 |     41 |    602 |      0 |        0 | (0,3)   |           2 |       2050 |     24 |        |       | &#123;&quot;\\xe9030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   4 |   8096 |        1 |     41 |    598 |      0 |        0 | (0,4)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x04000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   5 |      0 |        0 |      0 |        |        |          |         |             |            |        |        |       | </span><br><span class="line">   6 |   8048 |        1 |     41 |    598 |      0 |        0 | (0,6)   |           2 |       2306 |     24 |        |       | &#123;&quot;\\x06000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>The result shows the 2nd new record <code>id=1001</code> is inserted to the 3rd place, and we don’t see any different after <code>vacuum orders1</code> was executed.</p>
<ul>
<li>Vacuum full<br>Now, let’s run a vacuum full, and insert the 3rd new record,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# vacuum full;</span><br><span class="line">VACUUM</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# insert into orders1 values(1002, &#39;hello world!&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 0), &#39;orders1&#39;::regclass);</span><br><span class="line"> lp  | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid  | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid |                     t_attrs                     </span><br><span class="line">-----+--------+----------+--------+--------+--------+----------+---------+-------------+------------+--------+--------+-------+-------------------------------------------------</span><br><span class="line">   1 |   8144 |        1 |     41 |    601 |      0 |        0 | (0,1)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\xe8030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   2 |   8096 |        1 |     41 |    598 |      0 |        0 | (0,2)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\x02000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   3 |   8048 |        1 |     41 |    602 |      0 |        0 | (0,3)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\xe9030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   4 |   8000 |        1 |     41 |    598 |      0 |        0 | (0,4)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\x04000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   5 |   7952 |        1 |     41 |    598 |      0 |        0 | (0,5)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\x06000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">   6 |   7904 |        1 |     41 |    598 |      0 |        0 | (0,6)   |           2 |       2818 |     24 |        |       | &#123;&quot;\\x08000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">... ...    </span><br><span class="line"> 100 |   3392 |        1 |     41 |    598 |      0 |        0 | (0,100) |           2 |       2818 |     24 |        |       | &#123;&quot;\\xc4000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 101 |   3344 |        1 |     41 |    598 |      0 |        0 | (0,101) |           2 |       2818 |     24 |        |       | &#123;&quot;\\xc6000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 102 |   3296 |        1 |     41 |    598 |      0 |        0 | (0,102) |           2 |       2818 |     24 |        |       | &#123;&quot;\\xc8000000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line"> 103 |   3248 |        1 |     41 |    676 |      0 |        0 | (0,103) |           2 |       2050 |     24 |        |       | &#123;&quot;\\xea030000&quot;,&quot;\\x1b68656c6c6f20776f726c6421&quot;&#125;</span><br><span class="line">(103 rows)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT * FROM heap_page_item_attrs(get_raw_page(&#39;orders1&#39;, 2), &#39;orders1&#39;::regclass);</span><br><span class="line">ERROR:  block number 2 is out of range for relation &quot;orders1&quot;</span><br></pre></td></tr></table></figure>
After the <code>vacuum full</code>, there are some changes,<br>1) all dead tuples were removed, the rest tuples were shuffled and merged into the 1st page, and the 2nd page was deleted.<br>2) the new record 1id=10021 was inserted to the very end.<br>3) No access to the 2nd page, since it has been deleted.</li>
</ul>
<p>This extension provides an easy way to observe how a heap page is changed when performing insert, delete and vacuum. The same behaviour can be observed on the heap file when using hexdump command (<code>checkpoint</code> may require to force the memory page to be flushed to heap file after each operation).</p>
<h4 id="6-Summary"><a href="#6-Summary" class="headerlink" title="6.    Summary"></a>6.    Summary</h4><p>We explained how the heap files are created, the internal data structure of heap file and page (a segment of a heap file), and demonstrated how to use the extension <code>pageinspect</code> to check what happens when user performed some insert, delete and vacuum. In the coming blogs, I will explain the free space mapping file and the visibility mapping file in the same way.</p>
<p>Ref: <a href="https://www.postgresql.org/docs/current/storage-file-layout.html" target="_blank" rel="noopener">PG Database File Layout</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/08/21/How-to-setup-Postgresql-on-an-IPv6-enabled-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/21/How-to-setup-Postgresql-on-an-IPv6-enabled-network/" class="post-title-link" itemprop="url">How to setup Postgresql on an IPv6 enabled network</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-21 01:00:00 / Modified: 16:26:40" itemprop="dateCreated datePublished" datetime="2020-08-21T01:00:00-07:00">2020-08-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Debug/" itemprop="url" rel="index">
                    <span itemprop="name">Debug</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-ipv6.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL is a great open source database, not only because it supports lot of database features, but also because it supports different network setup. For example, you can set it up on an IPv6 enabled network in just a few steps. This blog will demonstrate how to setup PostgreSQL on an IPv6 network in Linux. </p>
<p>Before we dive into the detail, let’s discuss a little bit IPv6. IPv6 was developed by the Internet Engineering Task Force (IETF) in late 1998 and was intended to replace IPv4. With the IPv4 address exhaustion issue, after about two decades, IPv6 now is finally coming into the real picture. Below is the <a href="https://www.internetsociety.org/resources/2018/state-of-ipv6-deployment-2018/" target="_blank" rel="noopener">state of IPv6 Deployment in 2018</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* Over 25% of all Internet-connected networks advertise IPv6 connectivity.</span><br><span class="line">* Google reports 49 countries deliver more than 5% of traffic over IPv6, with new countries joining all the time.</span><br><span class="line">* Google reports 24 countries whose IPv6 traffic exceeds 15%.</span><br></pre></td></tr></table></figure>
<p>If you check your home internet modem/router and most likely you will find the IPv6 is already enabled. There are many documents and RFCs explain IPv6 in much more detail. For example, <code>IP Version 6 Addressing Architecture</code> defined in <a href="https://datatracker.ietf.org/doc/rfc4291/" target="_blank" rel="noopener">RFC 4291</a>. In this blog, I will just explain some simple concepts which is required in this demo.</p>
<h4 id="2-Setup-IPv6-network"><a href="#2-Setup-IPv6-network" class="headerlink" title="2. Setup IPv6 network"></a>2. Setup IPv6 network</h4><h5 id="Link-local-address"><a href="#Link-local-address" class="headerlink" title="Link-local address"></a>Link-local address</h5><p>Not like IPv4, all the interface of an IPv6 enabled host require a link-local address. The link-local address will always start with the prefix fe80:: and it is generated during TCP/IP stack boot up on that interface. The interesting part is that link-local address doesn’t request a DHCP server or any manual configuration. The link-local can be set to derive from the MAC address of the interface, in this case, if you know the MAC of the interface then you can create the link-local address by simply copy and paste the MAC to a <a href="https://ben.akrin.com/?p=1347" target="_blank" rel="noopener">link-local calculator</a>. </p>
<h5 id="Global-address"><a href="#Global-address" class="headerlink" title="Global address"></a>Global address</h5><p>However, there is a limitation as the name indicated, it only works between the hosts which are directly connected. To allow the communication cross the internet or multiple routers, the host needs to have a global address. There are many different ways to setup a global IPv6 address. Here, we introduce three typical ways: Manually, DHCPv6 and SLAAC.</p>
<ul>
<li><p>To manually setup an IPv6 global address, you can use either <code>ip</code> or <code>ifconfig</code>. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip -6 addr add 2020:1:0:0::db1&#x2F;64 dev eth0 </span><br><span class="line"></span><br><span class="line">sudo ifconfig eth0 inet6 add 2020:1:0:0::db1&#x2F;64</span><br></pre></td></tr></table></figure>
<p>Since IPv6 allows the HEX characters, you can make your own customized IPv6 address for fun. For example, configure a PostgreSQL server with IPv6 address like, <code>:db:feed</code>, <code>:da7a:ba5e</code>, <code>:db1</code>, <code>:db2</code> etc,.</p>
</li>
<li><p>Stateless address autoconfiguration (SLAAC) requires to have a router which broadcast the <code>router advertisement</code> periodically. The router should also response to <code>router solicitation</code> request from any host machine. Once the host receive the <code>router advertisement</code>, it will use the <code>prefix</code> to generate the global IPv6 address automatically. Below is an example,<br>Install the <code>Router Advertisement Daemon (radvd)</code> on PostgreSQL server side, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install radvd</span><br></pre></td></tr></table></figure>
<p>then configure the radvd conf file, for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface eno1</span><br><span class="line">&#123;</span><br><span class="line">   AdvSendAdvert on;</span><br><span class="line">   AdvManagedFlag off;</span><br><span class="line">   AdvOtherConfigFlag on;</span><br><span class="line">   prefix 2020:1:0:0::&#x2F;64</span><br><span class="line">   &#123;</span><br><span class="line">        AdvAutonomous on;</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Configure a new IPv6 address on Postgres server for radvd daemon to use</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip -6 addr add 2020:1:0:0::db1&#x2F;64 dev eno1</span><br></pre></td></tr></table></figure>
<p>Then start the <code>radvd</code> daemon, <code>sudo radvd -l /etc/radvd.conf</code><br>Now, if you check the ip address on the client machine side, you should see something like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enp0s3: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.20.14.27  netmask 255.255.255.0  broadcast 172.20.14.255</span><br><span class="line">        inet6 2020:1::8dcf:b8be:dbcc:26c6  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        inet6 fe80::8005:8b22:cd7d:ee39  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 08:00:27:29:ab:c9  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 118  bytes 38615 (38.6 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 181  bytes 26919 (26.9 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>where, <code>2020:1::8dcf:b8be:dbcc:26c6</code> is the global address generated after receive the <code>router advertisement</code>.</p>
</li>
<li><p>Stateful IPv6 address is done via a DHCPv6 server. The setup is similar to the IPv4 DHCP server setup. Below is an example on an Ubuntu machine, </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install isc-dhcp-server</span><br></pre></td></tr></table></figure>
<p>After the DHCP Server has been installed, edit the configuration file for IPv6 address assignment.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim &#x2F;etc&#x2F;dhcp&#x2F;dhcpd6.conf</span><br></pre></td></tr></table></figure>
<p>and add below information,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ddns-update-style none;</span><br><span class="line">default-lease-time 7200; # 12 hours</span><br><span class="line">max-lease-time 86400; # 12 hours</span><br><span class="line">authoritative;</span><br><span class="line"></span><br><span class="line">### Subnet</span><br><span class="line">subnet6 2020:2:0:0::&#x2F;64 &#123;</span><br><span class="line">    range6</span><br><span class="line">        2020:2:0:0::1001  2020:2:0:0::1005;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Configure a new IPv6 address on Postgres server for DHCPv6 server to use</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip -6 addr add 2020:2:0:0::db1&#x2F;64 dev eno1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dhcpd -6 -d -cf &#x2F;etc&#x2F;dhcp&#x2F;dhcpd6.conf eth0</span><br></pre></td></tr></table></figure>
<p>On the client machine side, run a dhcp request for IPv6 manually. <code>sudo dhclient -6 enp0s3</code>, and then perform an ip address check.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enp0s3: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.20.14.27  netmask 255.255.255.0  broadcast 172.20.14.255</span><br><span class="line">        inet6 2020:2::1004  prefixlen 128  scopeid 0x0&lt;global&gt;</span><br><span class="line">        inet6 2020:1::8dcf:b8be:dbcc:26c6  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        inet6 fe80::8005:8b22:cd7d:ee39  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 08:00:27:29:ab:c9  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 1118  bytes 253355 (253.3 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 495  bytes 76673 (76.6 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>where, <code>2020:2::1004</code> is the global IPv6 address assigned by the DHCPv6 server.</p>
<h4 id="3-Connetivity-test-using-ping6"><a href="#3-Connetivity-test-using-ping6" class="headerlink" title="3. Connetivity test using ping6"></a>3. Connetivity test using ping6</h4><ul>
<li>PostgreSQL server<ul>
<li>Network interface: eno1</li>
<li>link-local: fe80::1c79:293f:1b6e:c826</li>
<li>IPv6 global address(SLAAC): 2020:1::db1</li>
<li>IPv6 global address(DHCPv6): 2020:2::db1</li>
</ul>
</li>
</ul>
<ul>
<li>psql client IPs<ul>
<li>Network interface: enp0s3</li>
<li>link-local: fe80::8005:8b22:cd7d:ee39</li>
<li>IPv6 global address generated(SLAAC): 2020:1::8dcf:b8be:dbcc:26c6</li>
<li>IPv6 global address assigned(DHCPv6): 2020:2::1004</li>
</ul>
</li>
</ul>
<h5 id="ping6-test-from-server-to-client"><a href="#ping6-test-from-server-to-client" class="headerlink" title="ping6 test from server to client"></a>ping6 test from server to client</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ping6 fe80::8005:8b22:cd7d:ee39%eno1</span><br><span class="line">PING fe80::8005:8b22:cd7d:ee39%eno1(fe80::8005:8b22:cd7d:ee39%eno1) 56 data bytes</span><br><span class="line">64 bytes from fe80::8005:8b22:cd7d:ee39%eno1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.582 ms</span><br><span class="line">64 bytes from fe80::8005:8b22:cd7d:ee39%eno1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.572 ms</span><br><span class="line"></span><br><span class="line">$ ping6 2020:1::8dcf:b8be:dbcc:26c6</span><br><span class="line">PING 2020:1::8dcf:b8be:dbcc:26c6(2020:1::8dcf:b8be:dbcc:26c6) 56 data bytes</span><br><span class="line">64 bytes from 2020:1::8dcf:b8be:dbcc:26c6: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.576 ms</span><br><span class="line">64 bytes from 2020:1::8dcf:b8be:dbcc:26c6: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.601 ms</span><br><span class="line"></span><br><span class="line">$ ping6 2020:2::1004</span><br><span class="line">PING 2020:2::1004(2020:2::1004) 56 data bytes</span><br><span class="line">64 bytes from 2020:2::1004: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.896 ms</span><br><span class="line">64 bytes from 2020:2::1004: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.631 ms</span><br></pre></td></tr></table></figure>

<h5 id="ping6-test-from-client-to-server"><a href="#ping6-test-from-client-to-server" class="headerlink" title="ping6 test from client to server"></a>ping6 test from client to server</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ping6 fe80::1c79:293f:1b6e:c826%enp0s3</span><br><span class="line">PING fe80::1c79:293f:1b6e:c826%enp0s3(fe80::1c79:293f:1b6e:c826%enp0s3) 56 data bytes</span><br><span class="line">64 bytes from fe80::1c79:293f:1b6e:c826%enp0s3: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.144 ms</span><br><span class="line">64 bytes from fe80::1c79:293f:1b6e:c826%enp0s3: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.220 ms</span><br><span class="line"></span><br><span class="line">$ ping6 2020:1::db1</span><br><span class="line">PING 2020:1::db1(2020:1::db1) 56 data bytes</span><br><span class="line">64 bytes from 2020:1::db1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.825 ms</span><br><span class="line">64 bytes from 2020:1::db1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.520 ms</span><br><span class="line"></span><br><span class="line">$ ping6 2020:2::db1</span><br><span class="line">PING 2020:2::db1(2020:2::db1) 56 data bytes</span><br><span class="line">64 bytes from 2020:2::db1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.508 ms</span><br><span class="line">64 bytes from 2020:2::db1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.486 ms</span><br></pre></td></tr></table></figure>

<h4 id="4-Configure-PostgreSQL-for-IPv6"><a href="#4-Configure-PostgreSQL-for-IPv6" class="headerlink" title="4. Configure PostgreSQL for IPv6"></a>4. Configure PostgreSQL for IPv6</h4><p>Edit the postgresql.conf file to allow Postgres listen on different interfaces</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses &#x3D; &#39;*&#39;</span><br></pre></td></tr></table></figure>

<p>Edit the host-based authentication file to allow client machine to connect with different source IPs.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># IPv6 local connections:</span><br><span class="line">host    all             all             fe80::8005:8b22:cd7d:ee39&#x2F;128           trust</span><br><span class="line">host    all             all             2020:1::8dcf:b8be:dbcc:26c6&#x2F;128         trust</span><br><span class="line">host    all             all             2020:2::1004&#x2F;128                        trust</span><br></pre></td></tr></table></figure>

<h5 id="psql-client-connect-to-Postgres-server-using-link-local-address-with-interface-name"><a href="#psql-client-connect-to-Postgres-server-using-link-local-address-with-interface-name" class="headerlink" title="psql client connect to Postgres server using link-local address with interface name"></a>psql client connect to Postgres server using link-local address with interface name</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -U david -h fe80::1c79:293f:1b6e:c826%enp0s3</span><br><span class="line">psql (14devel)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT datname,pid, usename, client_addr FROM pg_stat_activity where usename&#x3D;&#39;david&#39;;</span><br><span class="line"> datname  |  pid  | usename |        client_addr        </span><br><span class="line">----------+-------+---------+---------------------------</span><br><span class="line">          | 24170 | david   | </span><br><span class="line"> postgres | 24244 | david   | fe80::8005:8b22:cd7d:ee39</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure>

<h5 id="psql-client-connect-to-Postgres-server-using-global-address-Stateless-address"><a href="#psql-client-connect-to-Postgres-server-using-global-address-Stateless-address" class="headerlink" title="psql client connect to Postgres server using global address(Stateless address)"></a>psql client connect to Postgres server using global address(Stateless address)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -U david -h 2020:1::db1</span><br><span class="line">psql (14devel)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT datname,pid, usename, client_addr FROM pg_stat_activity where usename&#x3D;&#39;david&#39;;</span><br><span class="line"> datname  |  pid  | usename |         client_addr         </span><br><span class="line">----------+-------+---------+-----------------------------</span><br><span class="line">          | 24131 | david   | </span><br><span class="line"> postgres | 24149 | david   | 2020:1::8dcf:b8be:dbcc:26c6</span><br></pre></td></tr></table></figure>

<h5 id="psql-client-connect-to-Postgres-server-using-global-address-Stateful-address"><a href="#psql-client-connect-to-Postgres-server-using-global-address-Stateful-address" class="headerlink" title="psql client connect to Postgres server using global address(Stateful address)"></a>psql client connect to Postgres server using global address(Stateful address)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -U david -h 2020:2::db1</span><br><span class="line">psql (14devel)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT datname,pid, usename, client_addr FROM pg_stat_activity where usename&#x3D;&#39;david&#39;;</span><br><span class="line"> datname  |  pid  | usename | client_addr  </span><br><span class="line">----------+-------+---------+--------------</span><br><span class="line">          | 24170 | david   | </span><br><span class="line"> postgres | 24235 | david   | 2020:2::1004</span><br></pre></td></tr></table></figure>

<h4 id="5-Typical-errors"><a href="#5-Typical-errors" class="headerlink" title="5. Typical errors"></a>5. Typical errors</h4><h5 id="Using-link-local-to-connect-Postgres-without-the-interface-name"><a href="#Using-link-local-to-connect-Postgres-without-the-interface-name" class="headerlink" title="Using link-local to connect Postgres without the interface name"></a>Using link-local to connect Postgres without the interface name</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -U david -h fe80::1c79:293f:1b6e:c826</span><br><span class="line">psql: error: could not connect to server: could not connect to server: Invalid argument</span><br><span class="line">    Is the server running on host &quot;fe80::1c79:293f:1b6e:c826&quot; and accepting</span><br><span class="line">    TCP&#x2F;IP connections on port 5432?</span><br></pre></td></tr></table></figure>

<h5 id="psql-client-using-a-wrong-global-address-as-source-address"><a href="#psql-client-using-a-wrong-global-address-as-source-address" class="headerlink" title="psql client using a wrong global address as source address"></a>psql client using a wrong global address as source address</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -h 2020:2::db1</span><br><span class="line">psql: error: could not connect to server: FATAL:  no pg_hba.conf entry for host &quot;2020:1::8dcf:b8be:dbcc:26c6&quot;, user &quot;dbtest&quot;, database &quot;postgres&quot;</span><br></pre></td></tr></table></figure>
<p>This is due to multiple IPv6 global addresses available on the same interface. In this case, the application, i.e. <code>psql</code> should have an option to select the preferred IPv6, otherwise, the kernel will pick up the IPv6 global address based on predefined policy and rules. Please check <a href="http://linux-ip.net/html/routing-saddr-selection.html" target="_blank" rel="noopener">Source Address Selection</a> for details. A simple solution is the remove other global IPv6 addresses, and disable the corresponding <code>service</code> i.e. <code>radvd</code> or <code>DHCPv6</code> server.</p>
<h4 id="6-Summary"><a href="#6-Summary" class="headerlink" title="6.    Summary"></a>6.    Summary</h4><p>We demonstrated how to setup a simple IPv6 network with one Postgres server and one psql client. To enable the IPv6 configuration is pretty simple on PostgreSQL side, but some the basic IPv6 knowledge is required.</p>
<p>Ref: [Configuring IPv6 addresses] (<a href="https://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/ch06s02.html" target="_blank" rel="noopener">https://www.tldp.org/HOWTO/Linux+IPv6-HOWTO/ch06s02.html</a>)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/07/10/A-simple-way-to-trace-a-bug-when-you-donot-have-enough-time/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/10/A-simple-way-to-trace-a-bug-when-you-donot-have-enough-time/" class="post-title-link" itemprop="url">A simple way found a bug born in 1997</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-10 01:00:00" itemprop="dateCreated datePublished" datetime="2020-07-10T01:00:00-07:00">2020-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-11 11:53:36" itemprop="dateModified" datetime="2020-07-11T11:53:36-07:00">2020-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Debug/" itemprop="url" rel="index">
                    <span itemprop="name">Debug</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-gdb-step-mult.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>Whenever I tried to study PostgreSQL source code a little deeper, I always wanted to find some tools to help me understand better as I really don’t want to read the code line by line for a particular feature, but at the same time, I really wanted to figure it out quickly. Simply put, I was kind of “lazy” at that movement. Luckily, I found one very simple way to help me when I was studying the <code>Geometric Types</code> in PostgreSQL. This simple method helped me find out a bug exist since 1997. Thanks to Tom Lane who helpped fix it and committed it to Postgresql. The commit is “35d1eefb29d03d5a85f71038679f1f8a14358255” with below comments.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Fix circle_in to accept &quot;(x,y),r&quot; as it&#39;s advertised to do.</span><br><span class="line"></span><br><span class="line">Our documentation describes four allowed input syntaxes for circles,</span><br><span class="line">but the regression tests tried only three ... with predictable</span><br><span class="line">consequences.  Remarkably, this has been wrong since the circle</span><br><span class="line">datatype was added in 1997, but nobody noticed till now.</span><br></pre></td></tr></table></figure>

<p>In this blog, I will use this story to explain how did I figure out this bug using a script in a very simple way.</p>
<h4 id="2-Find-a-bug-born-in-1997"><a href="#2-Find-a-bug-born-in-1997" class="headerlink" title="2. Find a bug born in 1997"></a>2. Find a bug born in 1997</h4><p>A few months ago, I was trying to see what was all the Geometric Types PostgreSQL can support by checking the official <a href="https://www.postgresql.org/docs/current/datatype-geometric.html" target="_blank" rel="noopener">document</a>. In the section <code>8.8.7. Circles</code>, the different ways to insert a circle were described like below. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Circles are represented by a center point and radius. Values of type circle are specified using any of the following syntaxes:</span><br><span class="line"></span><br><span class="line">&lt; ( x , y ) , r &gt;</span><br><span class="line">( ( x , y ) , r )</span><br><span class="line">  ( x , y ) , r</span><br><span class="line">    x , y   , r</span><br></pre></td></tr></table></figure>
<p>I was so suprised that there are some many ways to draw a circle in PostgreSQL, and accidently I had a psql console connected to a server at that moment. So, I decided to try all the methods one by one. However, when I followed the 3rd way to insert a circle, I encountered an error, i.e. <code>invalid input syntax for type circle</code>. Here is the what did at that moment.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_circle(id serial PRIMARY KEY, a circle);</span><br><span class="line">INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br><span class="line"></span><br><span class="line">ERROR:  invalid input syntax for type circle: &quot;( 1 , 1 ) , 5&quot;</span><br><span class="line">LINE 1: INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br></pre></td></tr></table></figure>
<p>The first thoughts came to my mind was that I must have typed something wrong. But after carefully checked each character, I couldn’t find any error. However, I conldn’t believe what I saw on the screen, therefore I called my colleague to help me do a quick check. The result was the same. Then I started to think if I can go a little further to find out the bug before reporting to the community, it might help some. But, the question was how to find the issue out within limited time (I did have a lot of work need to be done in the same day, in other words, “I was busy”. Well, “busy” is actually one of the main reasons I want to discuss about this simple method).</p>
<p>Obviously, I was not so familiar with the data type related circle in PostgreSQL source code, but I did know how to compile PostgreSQL from source code and how to use gdb to run a simple debug (keep in mind, these are all the prerequisite). </p>
<p>I started to compile the source code with gdb enabled like below.<br><code>./configure --enable-cassert --enable-debug CFLAGS=&quot;-ggdb -O0 -g3 -fno-omit-frame-pointer”</code></p>
<p>After the PostgerSQL server restarted, I used gdb to attach to the postgres running in background which connected to my psql console. I set up a breakpoint to the function <code>transformExprRecurse</code> (well, this is another prerequisite). I tried to repeat the circle insert query, and the gdb stopped at <code>transformExprRecurse</code>. Now, I was totally stuck. I didn’t know how to locate the bug, I had no idea what was behind the circle data type, and in which file it was implemented etc.. Then how could I move a litter further?</p>
<p>Well, I did have one thing in my mind that I need to quickly find out the difference between the working data type and the non-working data type. To achieve this, a simple way would be just type a <code>next</code> and then press <code>enter</code>. I started to do it. But after repeated 3 times, I gave it up. I realized that I didn’t know how many times I have to repeat the process and it was not possible for me to capture the difference. Then I started to question myself whether there was a way to automatically type <code>next</code> and then <code>enter</code> until the circle insert query was finished. Thanks to <code>google</code>, yes, I found <a href="https://stackoverflow.com/questions/5812411/gdb-automatic-nexting" target="_blank" rel="noopener">this</a>. I copied and pasted the script and added <code>transformExprRecurse</code> as the default breakpoint. The scpript was ended up like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># file: step_mult.gdb</span><br><span class="line"></span><br><span class="line">set pagination off</span><br><span class="line">set detach-on-fork off</span><br><span class="line">set schedule-multiple on</span><br><span class="line">handle SIGUSR1 noprint nostop</span><br><span class="line">handle SIGUSR2 noprint nostop</span><br><span class="line">macro define __builtin_offsetof(T, F) ((int) &amp;(((T *) 0)-&gt;F))</span><br><span class="line">macro define __extension__</span><br><span class="line">python gdb.events.exited.connect(lambda x: [gdb.execute(&#39;inferior 1&#39;), gdb.post_event(lambda: gdb.execute(&#39;continue&#39;))])</span><br><span class="line"></span><br><span class="line">set logging file gdb.log</span><br><span class="line">set logging on</span><br><span class="line"></span><br><span class="line">break transformExprRecurse</span><br><span class="line"></span><br><span class="line">####</span><br><span class="line">define step_mult</span><br><span class="line">    set $step_mult_max &#x3D; 100000</span><br><span class="line">    if $argc &gt;&#x3D; 1</span><br><span class="line">        set $step_mult_max &#x3D; $arg0</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    set $step_mult_count &#x3D; 0</span><br><span class="line">    while ($step_mult_count &lt; $step_mult_max)</span><br><span class="line">        set $step_mult_count &#x3D; $step_mult_count + 1</span><br><span class="line">        printf &quot;step #%d\n&quot;, $step_mult_count</span><br><span class="line">        step</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>I re-attach the postgres, ran the command <code>source step_mult.gdb</code> within gdb console, and then let the postgres continue to run in the background. I switched to another console and started to insert a circle using the 3rd way again. Postgres stopped at <code>exec_simple_query</code>, then I ran <code>step_mult 10000</code>. After a while, I saw the error message on my psql console again. I changed the log file gdb.log to gdb-2nd.log and repeated the steps, but this time I inserted a circle using the 2nd way. Now, I got two gdb log files which contain all the single step for the working and non-working circle data types.</p>
<p>I used a very nice <a href="https://www.scootersoftware.com/index.php" target="_blank" rel="noopener">Intelligent Comparison tools</a> to compare these two gdb log files and I foud the difference like below. <img src="/images/img/gdb-step-diff.png" alt="diff image">. The big difference I saw was showing in <code>circle_in</code> function within <code>src/backend/utils/adt/geo_ops.c</code>.</p>
<p>Now, I figured out where the data type circle was implemented. To proof that it was the right place to fix this issue, I made a quick dirty fix. Then I performed a test and found the 3rd data type was kind of <code>fixed</code>. </p>
<p>At this point, I was more confident to report this issue to the community with my <code>dirty</code> patch to proof that PostgreSQL doesn’t work with the 3rd way to draw a circle. The entire process took me about an hour, but I think finding out a bug which has stayed in PostgreSQL about 23 years in an hour is not that bad. </p>
<h4 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3.    Summary"></a>3.    Summary</h4><p>PostgreSQL is one of the best open source RDBMS in the world, and there are many other open source projects like it. As a software engineer, you might encounter something like me in your daily work. If you find something fishy but don’t have enough time, then try the way I did. It may surprise you, who knows. From my opinion, this method may be suitable for below sisutations:</p>
<p>1) A feature is working in one use case but it doesn’t work in another very similar use case;<br>2) To find a function execution path in different conditions;<br>… </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/05/15/Build-PostgreSQL-and-Extension-on-Windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/15/Build-PostgreSQL-and-Extension-on-Windows/" class="post-title-link" itemprop="url">Build PostgreSQL and Extension on Windows</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-05-15 01:00:00 / Modified: 15:30:10" itemprop="dateCreated datePublished" datetime="2020-05-15T01:00:00-07:00">2020-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Extension/" itemprop="url" rel="index">
                    <span itemprop="name">Extension</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Extension/Build/" itemprop="url" rel="index">
                    <span itemprop="name">Build</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Extension/Build/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Extension/Build/Windows/VS2019/" itemprop="url" rel="index">
                    <span itemprop="name">VS2019</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/win-fi.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL is an open-source RDMS and running across many platforms including Linux (all recent distributions), Windows, FreeBSD, OpenBSD, NetBSD, Mac OS X, AIX, HP/UX, IRIX, Solaris, Tru64 Unix, and UnixWare. There are many discussions about how to build Postgres and extensions from source code on a Linux-like environment, but sometimes, a developer may want to quickly setup a Windows environment to check a feature for cross-platform support. This blog is going to explain how to build Postgres and extensions from source code on Windows platforms and it was tested on Windows 7, 10 and 2019 Server.</p>
<h4 id="2-Environment-setup"><a href="#2-Environment-setup" class="headerlink" title="2. Environment setup"></a>2. Environment setup</h4><p>This blog refers to the official <a href="https://www.postgresql.org/docs/12/install-windows-full.html" target="_blank" rel="noopener">document</a> and the blog <a href="https://www.2ndquadrant.com/en/blog/compiling-postgresql-extensions-visual-studio-windows" target="_blank" rel="noopener">Compiling PostgreSQL extensions with Visual Studio on Windows</a>, but providing many detailed screenshots on the latest version Visual Studio 2019 for building an extension as a standlone VS2019 project.</p>
<h5 id="3-Install-VS2019-Windows-SDK-and-other-tools"><a href="#3-Install-VS2019-Windows-SDK-and-other-tools" class="headerlink" title="3. Install VS2019, Windows SDK and other tools"></a>3. Install VS2019, Windows SDK and other tools</h5><p>Download the latest <a href="https://visualstudio.microsoft.com/downloads/?utm_medium=post-banner&utm_source=microsoft.com&utm_campaign=channel+banner&utm_content=launch+vs2019" target="_blank" rel="noopener">Visual Studio 2019</a> package. During the installation process, selecting the option <code>Desktop development with C++</code> is enough to build Postgres. This option will install <code>MSVC for VS 2019</code>, <code>Windows 10 SDK</code> and some basic <code>C/C++ building tools</code>. As described in the official document, <a href="https://platform.activestate.com/activestate/activeperl-5.28/auto-fork?utm_source=activestate.com&utm_medium=referral&utm_content=activeperl-5.28-mac&utm_campaign=user-acquisition" target="_blank" rel="noopener">ActiveState Perl</a> is required to run the build and generate scripts, and <a href="https://platform.activestate.com/activestate/activetcl-8.6/auto-fork?utm_source=activestate.com&utm_medium=referral&utm_content=activetcl-8.6&utm_campaign=user-acquisition" target="_blank" rel="noopener">ActiveState TCL</a> is required for building PL/Tcl. If the you build from a released source code <a href="https://www.postgresql.org/ftp/source/v12.3/" target="_blank" rel="noopener">tar file</a>, then install above tools should be enough for the default configuration, however if you build with the source coded cloned from <a href="https://github.com/postgres/postgres.git" target="_blank" rel="noopener">github</a>, then you need to install <code>Bison</code> and <code>Flex</code>, which can be found <a href="http://www.mingw.org/wiki/MSYS" target="_blank" rel="noopener">here</a>.<br>If you prefer to use Linux style commands as much as possible, then you can install <a href="https://github.com/git-for-windows/git/releases/latest" target="_blank" rel="noopener">git bash</a>. After all the tools has been installed, you need to <code>edit the system environment variables</code> to include all the binaries paths, for example, <img src="/images/img/win-env.png" alt="windows environment image"></p>
<h5 id="4-Build-postgres"><a href="#4-Build-postgres" class="headerlink" title="4. Build postgres"></a>4. Build postgres</h5><p>If you have an extension need to be built under the source code tree, then it is time to clone or copy your extension to <code>contrib</code> folder before starting the build. To build Postgres is pretty simple, just turn on VS 2019 terminal i.e. <code>Developer Command Prompt for VS 2019</code> and then navigate to the windows build folder inside the postgres source code, for example, <code>c:\Users\Administrator\Downloads\postgres\src\tools\msvc&gt;</code> and then run <code>build.bat</code>.</p>
<h5 id="5-Regress-test"><a href="#5-Regress-test" class="headerlink" title="5. Regress test"></a>5. Regress test</h5><p>If the build is succeeded, then you can perform a regress test by running <code>vcregress check</code>. To perform a regress test for the extensions, run the command <code>vcregress contribcheck</code>. If you are developing an extension on Windows and you want to speed up the build, then you can build your extension only by running the build script with the extension name, for example, <code>build.bat wal2mongo</code>. However, you can’t run a regress test for each individual extension. This can be worked around by removing all other extension from <code>contrib</code> folder temporally.</p>
<h5 id="6-Build-extension-in-an-independent-project-using-VS-2019"><a href="#6-Build-extension-in-an-independent-project-using-VS-2019" class="headerlink" title="6. Build extension in an independent project using VS 2019"></a>6. Build extension in an independent project using VS 2019</h5><p>Sometimes a developer may want to build an extension within VS2019 IDE. This is a little bit tricky and not even recommended to do it in this way but it is possible. The blog mentioned above has a detailed discussion about this topic. Here, we provide a step by step guide to walk you through the whole process on VS 2019.</p>
<ul>
<li>Start VS 2019 and <code>Create a new project</code></li>
<li>Select <code>Empty Project</code> template, which will create a C/C++ for Windows without any starting files.</li>
<li>Give a name for this extension project, for example <code>wal2mongo</code> (We use <a href="https://github.com/HighgoSoftware/wal2mongo.git" target="_blank" rel="noopener">wal2mongo</a> to demonstrate how to build an extension using VS 2019)</li>
<li>Right click on the project, select <code>Add</code> then <code>New Item...</code></li>
<li>Select <code>C++ File (.cpp)</code> template and name the file as <code>wal2mongo.c</code></li>
<li>Copy the whole content from <a href="https://github.com/HighgoSoftware/wal2mongo/blob/release/wal2mongo.c" target="_blank" rel="noopener">this file</a> to the newly created <code>wal2mongo.c</code> file</li>
<li>Add <code>PGDLLEXPORT</code> after the keyword <code>extern</code>, otherwise MSVC will not export its symbol.<br>the original file,<br><img src="/images/img/win-before.png" alt="before change image"><br>and how it looks like after the changes.<br><img src="/images/img/win-after.png" alt="after change image"></li>
<li>Right click the project, select <code>Properties</code> and then change following in order,<br>1 Click on <code>Configuration Properities</code> -&gt; <code>General</code> -&gt; Configuration Type, then select <code>Dynamic Library (.dll)</code><br><img src="/images/img/win-pro-1.png" alt="vs pro-1 image"><br>2 Click on <code>Configuration Prosperities</code> -&gt; <code>C/C++</code> -&gt; <code>General</code>, add the including paths in the order below<br><img src="/images/img/win-pro-2.png" alt="vs pro-2 image"><br>3 Click on <code>Configuration Prosperities</code> -&gt; <code>C/C++</code> -&gt; <code>Code Generation</code> -&gt; <code>Enable C++ Exceptions</code>, select <code>No</code><br><img src="/images/img/win-pro-3.png" alt="vs pro-3 image"><br>4 <code>Configuration Prosperities</code> -&gt; <code>C/C++</code> -&gt; <code>Advanced</code> -&gt; <code>Compile As</code>, select <code>Compile as C Code(/TC)</code><br><img src="/images/img/win-pro-4.png" alt="vs pro-4 image"><br>5 Click on <code>Configuration Prosperities</code> -&gt; <code>Linker</code> -&gt; <code>General</code> -&gt; <code>Additional Library Directories</code>, enter the lib path where your Postgres libraries are installed<br><img src="/images/img/win-pro-5.png" alt="vs pro-5 image"><br>6 Click on <code>Configuration Prosperities</code> -&gt; <code>Linker</code> -&gt; <code>Input</code> -&gt; <code>Additional Dependencies</code>, add <code>postgres.lib</code><br><img src="/images/img/win-pro-6.png" alt="vs pro-6 image"><br>7 Click on <code>Configuration Prosperities</code> -&gt; <code>Linker</code> -&gt; <code>Manifest File</code> -&gt; <code>Generate Manifest</code>, select <code>No (/MANIFEST:NO)</code><br><img src="/images/img/win-pro-7.png" alt="vs pro-7 image"></li>
<li>Finally, right click on the project and then select build.<br>If everything goes fine, then you should see <code>wal2mongo.dll</code> is created. Copy <code>wal2mongo.dll</code> to the lib folder where the Postgres libraries were installed. Then you should be able to test this extension as normal.</li>
</ul>
<h4 id="7-Summary"><a href="#7-Summary" class="headerlink" title="7. Summary"></a>7. Summary</h4><p>In this blog, we discussed how to build postgres and extension on Windows, especially to build an extension within VS2019. </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/04/17/Replicate-multiple-PostgreSQL-servers-to-a-single-MongoDB-server-using-logical-decoding-output-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/17/Replicate-multiple-PostgreSQL-servers-to-a-single-MongoDB-server-using-logical-decoding-output-plugin/" class="post-title-link" itemprop="url">Replicate multiple PostgreSQL servers to a single MongoDB server using logical decoding output plugin</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-04-17 04:00:00 / Modified: 14:39:05" itemprop="dateCreated datePublished" datetime="2020-04-17T04:00:00-07:00">2020-04-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/" itemprop="url" rel="index">
                    <span itemprop="name">Replication</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/" itemprop="url" rel="index">
                    <span itemprop="name">Logical</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/Decoding/" itemprop="url" rel="index">
                    <span itemprop="name">Decoding</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/Decoding/Plugin/" itemprop="url" rel="index">
                    <span itemprop="name">Plugin</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/Decoding/Plugin/MongoDB/" itemprop="url" rel="index">
                    <span itemprop="name">MongoDB</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/Decoding/Plugin/MongoDB/Docker/" itemprop="url" rel="index">
                    <span itemprop="name">Docker</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Replication/Logical/Decoding/Plugin/MongoDB/Docker/Compose/" itemprop="url" rel="index">
                    <span itemprop="name">Compose</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/w2m-docker-fi.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>“Postgres, is a free and open-source relational database management system (RDBMS) emphasizing extensibility and SQL compliance.” This is the highlight of PostgreSQL in a sentence from Wikipedia. Yes, the extensibility of PostgreSQL is extremely useful when you have some special requirements. This blog will discuss how to use logical decoding output plugin to replicate multiple PostgreSQL servers to a single MongoDB server and the environment setup using docker compose for a quick Proof of Concept.</p>
<h4 id="2-Logical-decoding-output-plugin"><a href="#2-Logical-decoding-output-plugin" class="headerlink" title="2. Logical decoding output plugin"></a>2. Logical decoding output plugin</h4><p>Start from version 9.5, PostgreSQL provides a solution to allow users to write their own decoding logic to reformat the output before sending it to the subscriber through a wal sender. This feature is called logical decoding output plugin. With this feature, other applications can get a specific data format from PostgreSQL database easily, and then use their own existing tools or algorithms to continue the data analysis. For example, replicating multiple Postgres servers to a single MongoDB server and then perform the real-time analytics and data visualization in MongoDB. There are many different decoding plugins available at <a href="https://wiki.postgresql.org/wiki/Logical_Decoding_Plugins" target="_blank" rel="noopener">here</a>, however <a href="https://github.com/HighgoSoftware/wal2mongo" target="_blank" rel="noopener"><code>wal2mongo</code></a> is only one can generate a JavaScript format data that can be used by MongoDB directly. You can use it following this blog to practice how data replication can be done from multiple Postgres databases to a MongoDB database using logical decoding output plugin.</p>
<ul>
<li>Logical decoding output plugin framework</li>
</ul>
<p>The logical decoding output plugin framework has a few predefined callback <a href="https://www.postgresql.org/docs/current/logicaldecoding-output-plugin.html" target="_blank" rel="noopener">interfaces</a>. These callbacks are registered in an initialization function named <code>_PG_output_plugin_init</code>, which will be called when the plugin is loaded as a shared library. After hookup with these interfaces by referring to the example <a href="https://www.postgresql.org/docs/current/test-decoding.html" target="_blank" rel="noopener">test_decoding</a>, the output decoding plugin will get notified about the changes that is happening via various callback interfaces. In these callback interfaces, the one will get noticed each time when an insert, update or delete happens is <code>LogicalDecodeChangeCB</code>. Most of the output formatting related logic should be done in a function which is registered to this interface, such as, map a Postgres data type to a MongoDB native data type.<br>Before writing your own logical decoding plugin, two basic things need to be mentioned here: one is the change callback interface is triggered based on each row, i.e. if you have multiple rows changed in one transaction, then you will get multiple times call back; the other is that the callback is triggered only by the row changes that have been safely saved to WAL files. The changes that were rolled back by the transaction will not trigger the callback.</p>
<ul>
<li>wal2mongo decoding plugin</li>
</ul>
<p><code>wal2mongo</code> is a logical decoding plugin, it mainly converts the DML operation such as insert, update and delete into a JavaScript format which later can be imported into MongoDB by using <code>mongo</code> client.</p>
<ul>
<li>Logical decoding data changes flow<br><img src="/images/img/w2m-flow-chart.png" alt="flow chart image"><br>The diagram above shows the data changes flow. We can use <code>psql</code> client to simulate the Application and perform database operation such as create table, insert records, update records and then delete records. The Postgres server backend will save the database changes to WAL first and then notify the WAL sender. The WAL sender will read the changes from WAL and get the output decoded by <code>wal2mongo</code> and then send the changes to the connected subscriber, i.e <code>pg_recvlogical</code> in this blog. <code>pg_recvlogical</code> will save the output as a JavaScript file, then later it will be imported to MongoDB using <code>mongo</code> client.</li>
</ul>
<p>To exercise this, we need to change <code>wal_level</code> to <code>logical</code> and make sure <code>max_wal_senders</code> is at least <code>2</code>, then restart Postgres server after the changes.</p>
<ul>
<li>Example of <code>wal2mongo</code> output</li>
</ul>
<p><code>wal2mongo</code> is designed to replicate the data changes from Postgres to MongoDB, not like a Postgres standby which need to replicate everything. Therefore, the focus is on the mostly used DML operation such as INSERT, UPDATE and DELETE. The diagram below shows the steps inclduing create a table, insert some records, do some update, and then perform a delete and how the data output looks like. Here, you have to change the table replica identity to full, otherwise, you won’t be able to replicate the UPDATE correctly.<br><img src="/images/img/w2m-sequence-chart.png" alt="seq chart image"></p>
<h4 id="2-Automatic-the-environment-setup-using-docker-compose"><a href="#2-Automatic-the-environment-setup-using-docker-compose" class="headerlink" title="2. Automatic the environment setup using docker compose"></a>2. Automatic the environment setup using docker compose</h4><p>Setup an environment like the one mentioned above to test a logical output plugin may take some time, especially when a user just wants to give a quickly try. I will introduce an easy way using docker to do the work. A Docker environment can be very useful when you want to practice a new technology which requires a complicated setup, or multiple machines to be available. It also help when you need such an environment from time to time, especially when you need it to be available “immediately” and then discard it after you finished your work.<br>To achieve such an environment with multiple Postgres servers and one MongoDB server, I built two docker images: one is a dedicated postgres with wal2mongo installed, and the other one is a dedicated mongod with the <code>pg_recvlogical</code> tools installed. Here is a cluster environment running on a sinlge physical machine using the files available at <a href="">here</a>.<br><img src="/images/img/w2m-docker-diagram.png" alt="docker image"></p>
<ul>
<li>Dockerfile for postgres<br>This Dockerfile is to build a docker image with the latest PostgreSQL 12.2 offical release and the <code>wal2mongo</code> installed.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:centos7</span><br><span class="line">MAINTAINER The CentOS Project &lt;cloud-ops@centos.org&gt;</span><br><span class="line"></span><br><span class="line">RUN yum -y install https:&#x2F;&#x2F;download.postgresql.org&#x2F;pub&#x2F;repos&#x2F;yum&#x2F;reporpms&#x2F;EL-7-x86_64&#x2F;pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line">RUN yum -y update; yum -y install sudo epel-release yum-utils net-tools which \</span><br><span class="line">		postgresql12-server postgresql12 \</span><br><span class="line">		git gcc make clang zlib-devel readline-devel postgresql12-devel; yum clean all</span><br><span class="line"></span><br><span class="line">RUN usermod -aG wheel postgres</span><br><span class="line">RUN echo &quot;export PATH&#x3D;&#x2F;usr&#x2F;pgsql-12&#x2F;bin:$PATH&quot; | tee -a &#x2F;var&#x2F;lib&#x2F;pgsql&#x2F;.bashrc</span><br><span class="line">RUN echo &quot;postgres ALL&#x3D;(root) NOPASSWD:ALL&quot; &gt; &#x2F;etc&#x2F;sudoers.d&#x2F;postgres &amp;&amp; chmod 0440 &#x2F;etc&#x2F;sudoers.d&#x2F;postgres</span><br><span class="line"></span><br><span class="line">USER postgres</span><br><span class="line">RUN eval &quot;sudo -E env &quot;PATH&#x3D;$PATH&quot; USE_PGXS&#x3D;1 make CLANG&#x3D;&#x2F;usr&#x2F;bin&#x2F;clang with_llvm&#x3D;no install&quot;</span><br><span class="line"></span><br><span class="line">VOLUME  [&quot;&#x2F;var&#x2F;log&#x2F;pgsql&quot;, &quot;&#x2F;var&#x2F;lib&#x2F;pgsql&quot;]</span><br><span class="line">EXPOSE 5432</span><br><span class="line"></span><br><span class="line">COPY run.sh .</span><br><span class="line">CMD [&quot;&#x2F;run.sh&quot;]</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>What inside the run.sh script is just a simple postgres start command. The way I used it here is to avoid rebuild the image when you want to start the container in different ways.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">&#x2F;usr&#x2F;pgsql-12&#x2F;bin&#x2F;pg_ctl -D &#x2F;var&#x2F;lib&#x2F;pgsql&#x2F;12&#x2F;data -l &#x2F;var&#x2F;log&#x2F;pgsql&#x2F;logfile start</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Dockfile for mongod<br>The dockerfile for mongod has the offical MongoDB 4.25 release and pg_recvlogical 12.2 installed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:centos7</span><br><span class="line">MAINTAINER The CentOS Project &lt;cloud-ops@centos.org&gt;</span><br><span class="line"></span><br><span class="line">COPY mongodb.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">RUN yum -y install mongodb-org-4.2.5 mongodb-org-server-4.2.5 	\</span><br><span class="line">		mongodb-org-shell-4.2.5 mongodb-org-mongos-4.2.5 		\</span><br><span class="line">		mongodb-org-tools-4.2.5 postgresql12-contrib; yum clean all</span><br><span class="line">RUN mkdir -p &#x2F;data&#x2F;db</span><br><span class="line"></span><br><span class="line">RUN usermod -aG wheel mongod</span><br><span class="line">RUN echo &quot;mongod ALL&#x3D;(root) NOPASSWD:ALL&quot; &gt; &#x2F;etc&#x2F;sudoers.d&#x2F;mongod &amp;&amp; \</span><br><span class="line">		chmod 0440 &#x2F;etc&#x2F;sudoers.d&#x2F;mongod</span><br><span class="line">RUN echo &quot;export PATH&#x3D;&#x2F;usr&#x2F;pgsql-12&#x2F;bin:$PATH&quot; | tee -a &#x2F;root&#x2F;.bashrc</span><br><span class="line">VOLUME  [&quot;&#x2F;data&#x2F;db&quot;, &quot;&#x2F;var&#x2F;log&#x2F;mongodb&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 27017</span><br><span class="line">ENTRYPOINT [&quot;&#x2F;usr&#x2F;bin&#x2F;mongod&quot;, &quot;--bind_ip_all&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Service compose file<br>The service docker compose file is to help setup two Postgres servers and one MongodDB servere, and make sure they are be able to communicate using hostname.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.0&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mongo:</span><br><span class="line">    restart: always</span><br><span class="line">    image: &quot;mongod:4.2.5&quot;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;27017:27017&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;data&#x2F;mgdata:&#x2F;data&#x2F;db</span><br><span class="line">      - .&#x2F;scripts&#x2F;p2m.sh:&#x2F;p2m.sh</span><br><span class="line"></span><br><span class="line">  pg1:</span><br><span class="line">    restart: always</span><br><span class="line">    image: &quot;postgres:12.2&quot;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;data&#x2F;pg1data:&#x2F;var&#x2F;lib&#x2F;pgsql&#x2F;12&#x2F;data</span><br><span class="line">      - .&#x2F;scripts&#x2F;data_gen.sh:&#x2F;data_gen.sh</span><br><span class="line"></span><br><span class="line">  pg2:</span><br><span class="line">    restart: always</span><br><span class="line">    image: &quot;postgres:12.2&quot;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5432&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;data&#x2F;pg2data:&#x2F;var&#x2F;lib&#x2F;pgsql&#x2F;12&#x2F;data</span><br><span class="line">      - .&#x2F;scripts&#x2F;data_gen.sh:&#x2F;data_gen.sh</span><br></pre></td></tr></table></figure>
<p>You can easily extend the Postgres servers by adding more instances to this service docker compose file.</p>
</li>
</ul>
<p>To build the containers, run command <code>docker-compose -f service-compose.yml up -d</code>. After a while, you should see two Postgres servers and one MongoDB server are running like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED              STATUS              PORTS                      NAMES</span><br><span class="line">935a3d339e71        mongod:4.2.5          &quot;&#x2F;usr&#x2F;bin&#x2F;mongod --b…&quot;   About a minute ago   Up About a minute   0.0.0.0:27017-&gt;27017&#x2F;tcp   pg2mongo_mongo_1</span><br><span class="line">d9497be07ce5        postgres:12.2         &quot;&#x2F;run.sh&quot;                About a minute ago   Up About a minute   0.0.0.0:54322-&gt;5432&#x2F;tcp    pg2mongo_pg2_1</span><br><span class="line">50eb555b5719        postgres:12.2         &quot;&#x2F;run.sh&quot;                About a minute ago   Up 38 seconds       0.0.0.0:54321-&gt;5432&#x2F;tcp    pg2mongo_pg1_1</span><br></pre></td></tr></table></figure>

<p>To setup the logical replication slot on each postgres server, and connect to each slot using <code>pg_recvlogical</code> then pipe the data changes to <code>mongo</code> client and feed the changes to MongoDB automaticlly, run a command like this <code>docker exec -it pg2mongo_mongo_1 bash /p2m.sh 1 2</code>. Where the <code>p2m.sh</code> is a simple demo script to allow you using <code>pg_recvlogical</code> to create slot, and connect to the slot then dump the message to a internal pipe. Then the <code>mongo</code> client will read the pipe and import the changes to MongoDB. You can check it by log into the mongod container and type a <code>ps -ef</code> to see the running services.</p>
<ul>
<li><p>Generate database changes<br>To simulate the data changes, you can use <code>pgbench</code>. There are two ways to do it: one is to log into each postgres instance and type the pgbench command; the other way is to map a local script to all postgres instances, then run the script from your host machine. For example <code>docker exec -it pg2mongo_pg1_1 bash /data_gen.sh</code></p>
</li>
<li><p>Verify the data changes<br>To verify the data changes, you can log into the mongod container, and then use the mongo cient to check the data changes imported automatically. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; use mycluster_postgres_w2m_slot2;</span><br><span class="line">switched to db mycluster_postgres_w2m_slot2</span><br><span class="line">&gt; db.pgbench_accounts.count();</span><br><span class="line">10028</span><br></pre></td></tr></table></figure>
</li>
<li><p>Modify the output plugin and reinstall it<br>You can log into any postgres server and find out the source code and make some changes, then recompile, install it and run a regression test, etc. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it pg2mongo_pg1_1 bash</span><br><span class="line">bash-4.2$ cd &#x2F;var&#x2F;lib&#x2F;pgsql&#x2F;sources&#x2F;wal2mongo&#x2F;</span><br><span class="line">...</span><br><span class="line">bash-4.2$ USE_PGXS&#x3D;1 make clean CLANG&#x3D;&#x2F;usr&#x2F;bin&#x2F;clang with_llvm&#x3D;no</span><br><span class="line">...</span><br><span class="line">bash-4.2$ USE_PGXS&#x3D;1 make CLANG&#x3D;&#x2F;usr&#x2F;bin&#x2F;clang with_llvm&#x3D;no</span><br><span class="line">...</span><br><span class="line">bash-4.2$ USE_PGXS&#x3D;1 make installcheck-force  CLANG&#x3D;&#x2F;usr&#x2F;bin&#x2F;clang with_llvm&#x3D;no</span><br><span class="line">...</span><br><span class="line">bash-4.2$ sudo -E env &quot;PATH&#x3D;$PATH&quot; USE_PGXS&#x3D;1 make CLANG&#x3D;&#x2F;usr&#x2F;bin&#x2F;clang with_llvm&#x3D;no install</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="3-logical-decoding-output-plugin-limitations"><a href="#3-logical-decoding-output-plugin-limitations" class="headerlink" title="3. logical decoding output plugin limitations"></a>3. logical decoding output plugin limitations</h4><p>The logical decoding output plugin is pretty useful feature, but still has some limitations. For example,</p>
<ul>
<li>Only physical relation tables can trigger logical decoding callback, views and sequences cannot trigger</li>
<li>The tables must have primary key and replica identity need to be set properly</li>
<li>Database schemas are not be able to be replicated</li>
<li>No large objects can be replicated<br>…</li>
</ul>
<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>In this blog, we discussed how to use the logical decoding output plugin to replicate multiple PostgreSQL servers to a single MongoDB server, and provide a docker environment setup to perform a quick Proof Of Concept.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/03/15/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/15/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-3/" class="post-title-link" itemprop="url">PostgreSQL GSSAPI Authentication with Kerberos part-3: the status of authentication, encryption and user principal</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-15 04:00:00" itemprop="dateCreated datePublished" datetime="2020-03-15T04:00:00-07:00">2020-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-18 13:24:16" itemprop="dateModified" datetime="2020-03-18T13:24:16-07:00">2020-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/" itemprop="url" rel="index">
                    <span itemprop="name">Kerberos</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/" itemprop="url" rel="index">
                    <span itemprop="name">GSSAPI</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/" itemprop="url" rel="index">
                    <span itemprop="name">Authentication</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">Ubuntu</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-part3.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>In previous two blogs, we explained how to setup Kerberos, and how to configure PostgreSQL to support GSSAPI user authentication. This blog will be focusing on how to check GSSAPI authentication, encryption and user principal information when given different connection options.</p>
<h4 id="2-pg-stat-gssapi-view"><a href="#2-pg-stat-gssapi-view" class="headerlink" title="2. pg_stat_gssapi view"></a>2. pg_stat_gssapi view</h4><p>According to the official <a href="https://www.postgresql.org/docs/current/gssapi-auth.html" target="_blank" rel="noopener">PostgreSQL document</a>, “<em>PostgreSQL supports GSSAPI for use as either an encrypted, authenticated layer, or for authentication only.</em>“ To check the authentication, encryption and user principal, we need to use <code>pg_stat_gssapi</code> view, which is a dynamic statistics views containing one row per backend and showing the information about GSSAPI authentication and encryption used on this connection.</p>
<p>Before start the test below, make sure the <code>PostgreSQL server</code> and the <code>psql client</code> has the option <code>--with-gssap</code> enabled during build time.</p>
<h4 id="3-Authentication-and-Encryption-status"><a href="#3-Authentication-and-Encryption-status" class="headerlink" title="3. Authentication and Encryption status"></a>3. Authentication and Encryption status</h4><ul>
<li><strong>Scenario 1:</strong></li>
</ul>
<p>Both authentication and encryption are enabled when the host-based authentication is configured with <code>hostgssenc</code> and <code>gss</code> in <code>pg_hba.conf</code><br>Set below user authentication rule to <code>pg_hba.conf</code> and disable all other rules. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostgssenc  postgres  postgres  192.168.0.102&#x2F;32  gss include_realm&#x3D;0 krb_realm&#x3D;HIGHGO.CA</span><br></pre></td></tr></table></figure>

<p>Initiate the user <code>postgres</code> credential cache using <code>kinit</code>, and then connect to PostgreSQL server with user <code>postgres</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql (12.2)</span><br><span class="line">GSSAPI-encrypted connection</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT pid, gss_authenticated, encrypted, principal from pg_stat_gssapi where pid &#x3D; pg_backend_pid();</span><br><span class="line"> pid  | gss_authenticated | encrypted |     principal      </span><br><span class="line">------+-------------------+-----------+--------------------</span><br><span class="line"> 2274 | t                 | t         | postgres@HIGHGO.CA</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>From the result, we can see this connection is encrypted and the user is authenticated with principal <code>postgres@HIGHGO.CA</code>.</p>
<ul>
<li><strong>Scenario 2:</strong></li>
</ul>
<p>The encryption will be disabled, but user authentication is still enabled when the host-based authentication is configured with <code>hostnogssenc</code> and <code>gss</code> in <code>pg_hba.conf</code><br>Set below user authentication rule to <code>pg_hba.conf</code> and disable all other rules. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnogssenc  postgres  postgres  192.168.0.102&#x2F;32  gss include_realm&#x3D;0 krb_realm&#x3D;HIGHGO.CA</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql (12.2)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT pid, gss_authenticated, encrypted, principal from pg_stat_gssapi where pid &#x3D; pg_backend_pid();</span><br><span class="line"> pid  | gss_authenticated | encrypted |     principal      </span><br><span class="line">------+-------------------+-----------+--------------------</span><br><span class="line"> 2291 | t                 | f         | postgres@HIGHGO.CA</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>The result tells no encryption, but user has been authenticated using principal <code>postgres@HIGHGO.CA</code></p>
<ul>
<li><strong>Scenario 3:</strong></li>
</ul>
<p>Both encryption and authentication are all enabled when the host-based authentication is configured with <code>host</code> and <code>gss</code> in <code>pg_hba.conf</code>.<br>Set below user authentication rule to <code>pg_hba.conf</code> and disable all other rules. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host  postgres  postgres  192.168.0.102&#x2F;32  gss include_realm&#x3D;0 krb_realm&#x3D;HIGHGO.CA</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql (12.2)</span><br><span class="line">GSSAPI-encrypted connection</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT pid, gss_authenticated, encrypted, principal from pg_stat_gssapi where pid &#x3D; pg_backend_pid();</span><br><span class="line"> pid  | gss_authenticated | encrypted |     principal      </span><br><span class="line">------+-------------------+-----------+--------------------</span><br><span class="line"> 2309 | t                 | t         | postgres@HIGHGO.CA</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>This result is the same as the first one, meaning, <code>host</code> is equivalent to <code>hostgssenc</code> when <code>gss</code> is specified.</p>
<ul>
<li><strong>Scenario 4:</strong></li>
</ul>
<p>The authentication will be disabled, but encryption is still on when the host-based authentication is configured with <code>host</code> and <code>trust</code> in <code>pg_hba.conf</code>.<br>Set below user authentication rule to <code>pg_hba.conf</code> and disable all other rules. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host  postgres  postgres  192.168.0.102&#x2F;32  trust</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql (12.2)</span><br><span class="line">GSSAPI-encrypted connection</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT pid, gss_authenticated, encrypted, principal from pg_stat_gssapi where pid &#x3D; pg_backend_pid();</span><br><span class="line"> pid  | gss_authenticated | encrypted | principal </span><br><span class="line">------+-------------------+-----------+-----------</span><br><span class="line"> 2322 | f                 | t         | </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>This result tells that the encryption will be always on when <code>--with-gssapi</code> is enabled during build time, unless <code>hostnogssenc</code> is specified in the host-based authentication file.</p>
<ul>
<li><strong>Scenario 5:</strong></li>
</ul>
<p>Both authentication and encryption will be disabled when the host-based authentication is configured with <code>host</code> and <code>trust</code> in <code>pg_hba.conf</code>, and the client <code>psql</code> requests a non-gssenc mode connection, i.e. <code>gssencmode=disable</code>.<br>Set below user authentication rule to <code>pg_hba.conf</code> and disable all other rules. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host  postgres  postgres  192.168.0.102&#x2F;32  trust</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ psql -h pg.highgo.ca -U postgres -d &quot;dbname&#x3D;postgres gssencmode&#x3D;disable&quot;</span><br><span class="line">psql (12.2)</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT pid, gss_authenticated, encrypted, principal from pg_stat_gssapi where pid &#x3D; pg_backend_pid();</span><br><span class="line"> pid  | gss_authenticated | encrypted | principal </span><br><span class="line">------+-------------------+-----------+-----------</span><br><span class="line"> 2328 | f                 | f         | </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>You can also achieve the same result by setting the environment <code>PGGSSENCMODE=disable</code> from the client side. For example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PGGSSENCMODE&#x3D;disable psql -h pg.highgo.ca -U postgres -d postgres</span><br></pre></td></tr></table></figure>

<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>In this blog, we discussed how to check authentication, encryption and user principal in 5 different scenarios. As you can see once <code>--with-gssapi</code> is enabled in PostgreSQL, the encryption will always be turned on unless you specify <code>hostnogssenc</code> in the host-based authentication file, or manually disable gssenc mode from a client side. Knowing the difference might help you when working the security related environment setup using GSSAPI.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/03/12/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/12/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-2/" class="post-title-link" itemprop="url">PostgreSQL GSSAPI Authentication with Kerberos part-2: PostgreSQL Configuration</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-12 04:00:00" itemprop="dateCreated datePublished" datetime="2020-03-12T04:00:00-07:00">2020-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-18 13:24:32" itemprop="dateModified" datetime="2020-03-18T13:24:32-07:00">2020-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/" itemprop="url" rel="index">
                    <span itemprop="name">Kerberos</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/" itemprop="url" rel="index">
                    <span itemprop="name">GSSAPI</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/" itemprop="url" rel="index">
                    <span itemprop="name">Authentication</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">Ubuntu</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-part2.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>In previous <a href="https://idrawone.github.io/2020/03/11/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-1/">blog</a>, we have setup Kerberos, added all required principals and verified each principal. This blog will explain all the necessary configuration, i.e. <code>postgresql.conf</code>, <code>pg_hba.conf</code> and <code>pg_ident.conf</code>, in PostgreSQL for user authentication using GSSAPI with Kerberos.</p>
<h4 id="2-Build-PostgreSQL-with-GSSAPI"><a href="#2-Build-PostgreSQL-with-GSSAPI" class="headerlink" title="2. Build PostgreSQL with GSSAPI"></a>2. Build PostgreSQL with GSSAPI</h4><p>The official <a href="https://www.postgresql.org/download/linux/ubuntu/" target="_blank" rel="noopener">PostgreSQL release for Ubuntu</a> has GSSAPI enabled for user authentication with Kerberos, however if you want to build it from source code, you can simply enable it by giving the option <code>--with-gssapi</code> in configure process like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;configure --with-gssapi --prefix&#x3D;&#x2F;home&#x2F;postgres&#x2F;pgapp</span><br></pre></td></tr></table></figure>
<p>There is another option <code>--with-krb-srvnam</code>, PostgreSQL uses the default name of the Kerberos service principal. According to Postgres official document, “<em>There’s usually no reason to change this unless you have a Windows environment, in which case it must be set to upper case POSTGRES</em>“. In this blog, we keep it as default, and no extra configuration required for it. After enabled <code>--with-gssapi</code> option, you can build, install, initialize database, change configuration and start database service as normal. The commands used in this blog are list below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br><span class="line">export PATH&#x3D;&#x2F;home&#x2F;postgres&#x2F;pgapp&#x2F;bin:$PATH</span><br><span class="line">export PGDATA&#x3D;&#x2F;home&#x2F;postgres&#x2F;pgdata&#x2F;data </span><br><span class="line">initdb -D $PGDATA</span><br></pre></td></tr></table></figure>

<h4 id="3-Keytab-file"><a href="#3-Keytab-file" class="headerlink" title="3. Keytab file"></a>3. Keytab file</h4><p>If you have followed the previous blog “part-1: how to setup Kerberos on Ubuntu”, then you should already have the keytab file. Now, copy the keytab file to Service Server (Postgres Server) and put it to a folder with appropriate permissions to the user owning the Postgres process. For example, user <code>postgres</code> and folder <code>/home/postgres/pgdata/data</code> in this blog. The instance principal extracted from KDC server can be verified using ktutil on Service Server. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ ktutil </span><br><span class="line">ktutil:  list</span><br><span class="line">slot KVNO Principal</span><br><span class="line">---- ---- ---------------------------------------------------------------------</span><br><span class="line">ktutil:  read_kt postgres.keytab </span><br><span class="line">ktutil:  list</span><br><span class="line">slot KVNO Principal</span><br><span class="line">---- ---- ---------------------------------------------------------------------</span><br><span class="line">   1    1          postgres&#x2F;pg.highgo.ca@HIGHGO.CA</span><br><span class="line">ktutil:</span><br></pre></td></tr></table></figure>
<p><code>postgres/pg.highgo.ca@HIGHGO.CA</code> is the principal we defined in previous blog in the format of <code>primary/instance@REALM</code>. In this example, <code>postgres</code> is the service, <code>/pg.highgo.ca</code> is the instance using the hostname.</p>
<h4 id="4-PostgreSQL-Configuration"><a href="#4-PostgreSQL-Configuration" class="headerlink" title="4. PostgreSQL Configuration"></a>4. PostgreSQL Configuration</h4><p>Once keytab file has been set properly, we can configure the keytab file location in postgresql.conf like below.<br><code>krb_server_keyfile = &#39;/home/postgres/pgdata/data/postgres.keytab&#39;</code>.  </p>
<p>Other than the keytab, we also need Postgres Server to allow connection from the network by change the listen_addresses.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses &#x3D; &#39;*&#39;</span><br></pre></td></tr></table></figure>
<p>This is the minimum changes in postgresql.conf required for GSSAPI user authentication with Kerberos. </p>
<h4 id="5-PostgreSQL-Client-Authentication"><a href="#5-PostgreSQL-Client-Authentication" class="headerlink" title="5. PostgreSQL Client Authentication"></a>5. PostgreSQL Client Authentication</h4><p><code>pg_hba.conf</code> is the file used to control clients authentication in PostgreSQL, where <code>hba</code> stands for host-based authentication. A default <code>pg_hba.conf</code> file is installed when the data directory is initialized by initdb. For details please refer to the <a href="(https://www.postgresql.org/docs/current/view-pg-hba-file-rules.html">rules</a> defined for this file, which provides a summary of the contents of the client authentication configuration file. The basic rule is that “<em>The first record with a matching connection type, client address, requested database, and user name is used to perform authentication. There is no <code>fall-through</code> or <code>backup</code>: if one record is chosen and the authentication fails, subsequent records are not considered. If no record matches, access is denied</em>.” In this blog, we will be focusing on GSSAPI releated users authentication using two key words, i.e. <code>hostgssenc</code> and <code>hostnogssenc</code> for the tests. For now, just put below two lines started with <code>hostgssenc</code> after IPv4 local connections.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># IPv4 local connections:</span><br><span class="line">host    all             all             127.0.0.1&#x2F;32            trust </span><br><span class="line">hostgssenc postgres     david           192.168.0.0&#x2F;24          gss include_realm&#x3D;0</span><br><span class="line">hostgssenc postgres     postgres        192.168.0.0&#x2F;24          gss include_realm&#x3D;0</span><br></pre></td></tr></table></figure>
<p>Here is how we define the user authentication for using GSSAPI according to <a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html" target="_blank" rel="noopener">PostgreSQL document</a>.</p>
<ul>
<li><code>hostgssenc</code> is used to match a TCP connection made with GSSAPI encryption.</li>
<li><code>postgres</code> is the database name. </li>
<li><code>david</code> and <code>postgres</code> are the users allowed to connect to the database. </li>
<li><code>192.168.0.0/24</code> is the network for this particular setup.</li>
<li><code>gss include_realm=0</code> means the authentication method <code>gss</code> is used with the option <code>include_realm=0</code> which indeicates the realm name from the authenticated user principal will be stripped off before being passed through the user name mapping.</li>
</ul>
<h4 id="6-PostgreSQL-User-Name-Maps"><a href="#6-PostgreSQL-User-Name-Maps" class="headerlink" title="6. PostgreSQL User Name Maps"></a>6. PostgreSQL User Name Maps</h4><p><a href="https://www.postgresql.org/docs/current/auth-username-maps.html" target="_blank" rel="noopener">pg_indent.conf</a> is used to map the users. The mapping can be used when user want to use email like user name e.g. <code>postgres@highgo.ca</code> to log in the database. For example, <code>postgres@highgo.ca</code> could be mapped to just <code>postgres</code>. According to <a href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html" target="_blank" rel="noopener">PostgreSQL document</a>, if <code>hostgssenc</code> is used, then only three authentication options are allowed: <code>gss</code>, <code>reject</code>, and <code>trust</code>. When <code>gss</code> is selected as the authentication option, then you can use below three option to specify the <code>gss</code> in further details.</p>
<ul>
<li><strong>include_realm:</strong> default set to <code>1</code>, if <code>0</code> is specified as above example, then realm name from the authenticated user principal is stripped off.</li>
<li><strong>map:</strong> is the mapping between system and database user names. The mapping supports regular expression when system user started with <code>/</code>. For example, <code>mymap   /^(.*)@mydomain\.com$      \1</code> is to remove the domain part for users from system user names. </li>
<li><strong>krb_realm:</strong> is used to match user principal names. If this parameter is set, only users of that realm will be accepted.<br>For example,<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostgssenc  postgres  postgres  192.168.0.0&#x2F;24  gss include_realm&#x3D;1 map&#x3D;mymap krb_realm&#x3D;HIGHGO.CA</span><br></pre></td></tr></table></figure>
Where, <code>gss include_realm=1 map=mymap krb_realm=HIGHGO.CA</code> is saying, match a TCP connection with GSS encryption enabled and map system user using <code>mymap</code> defined in <code>pg_ident.conf</code> for user from reamlm <code>HIGHGO.CA</code> only.</li>
</ul>
<h4 id="7-User-Authentication"><a href="#7-User-Authentication" class="headerlink" title="7. User Authentication"></a>7. User Authentication</h4><p>Now, we have one database admin user <code>postgres</code> setup on PostgreSQL server, let’s restrict this <code>postgres</code> user has to connect to Postgre server using GSSAPI user authentication with Kerberos.</p>
<h5 id="7-1-database-admin-user-local-authentication"><a href="#7-1-database-admin-user-local-authentication" class="headerlink" title="7.1. database admin user local authentication"></a>7.1. database admin user local authentication</h5><p>Disable all other user authentication <code>in pg_hba.conf</code>, set user authentication to allow <code>gss</code> with <code>include_realm=0</code> only, then restart Postgres server. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostgssenc  postgres  postgres  192.168.0.0&#x2F;24  gss include_realm&#x3D;0</span><br></pre></td></tr></table></figure>
<p>From Postgres server terminal, run <code>kdestroy -A</code> to clean all cached credentials, then run <code>klist</code> to check.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line">klist: No credentials cache found (filename: &#x2F;tmp&#x2F;krb5cc_1001)</span><br></pre></td></tr></table></figure>
<p>No credentials cached yet, then run <code>kinit postgres</code> to initial the user authentication.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kinit postgres</span><br><span class="line">Password for postgres@HIGHGO.CA:</span><br></pre></td></tr></table></figure>
<p>Now, check the cached credentials again,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1001</span><br><span class="line">Default principal: postgres@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-15 14:17:07  2020-03-16 00:17:07  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:17:04</span><br></pre></td></tr></table></figure>
<p>After the credentials has been cached, let’s try to log in use database admin user <code>postgres</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql (12.2)</span><br><span class="line">GSSAPI-encrypted connection</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# \q</span><br></pre></td></tr></table></figure>
<p>As the message <code>GSSAPI-encrypted connection</code> above indicates the connection is encrypted. Let’s check the cached credentials again,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1001</span><br><span class="line">Default principal: postgres@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-15 14:17:07  2020-03-16 00:17:07  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:17:04</span><br><span class="line">2020-03-15 14:21:21  2020-03-16 00:17:07  postgres&#x2F;pg.highgo.ca@</span><br><span class="line">	renew until 2020-03-16 14:17:04</span><br><span class="line">2020-03-15 14:21:21  2020-03-16 00:17:07  postgres&#x2F;pg.highgo.ca@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:17:04</span><br></pre></td></tr></table></figure>
<p>We can see the credentials for service principal <code>postgres/pg.highgo.ca</code> has been cached.<br><img src="/images/img/gssapi-postgres.png" alt="GSSAPI Postgres"><br>From the above wireshark capture, </p>
<ul>
<li>message 1: AS_REQ is the initial user authentication request triggered by <code>kinit</code>.</li>
<li>message 2: KRB Error is the reply from Authentication Server to ask password for user <code>postgres</code></li>
<li>message 3: AS_REQ is the user authentication request encrypted using <code>postgres</code>‘s password</li>
<li>message 4: AS_REP is the encrypted reply from Authentication Server. Upon now, <code>kini</code> is done, and user <code>postgres</code>‘s credential has been cached.</li>
<li>message 5: TGS_REQ is the request from <code>psql</code> to Ticket Granting Server (TGS) for a service ticket.</li>
<li>message 6: TGS_REP is the reply from Ticket Granting Server which contains a service session key generated by TGS and encrypted using a temporary session key generated by AS for user <code>postgres</code>.</li>
</ul>
<p>Within the service principal expire time, any new log in from the same machine with user <code>postgres</code> will not be required to provide the password. If you use wireshark to monitor the traffic again, you won’t see any <code>KRB5</code> message between KDC and Postgres Server.</p>
<h5 id="7-2-database-admin-user-remote-authentication"><a href="#7-2-database-admin-user-remote-authentication" class="headerlink" title="7.2. database admin user remote authentication"></a>7.2. database admin user remote authentication</h5><p>Now, let’s run the same test from the Client machine to observer the authentication messages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ kdestroy -A</span><br><span class="line">$ klist</span><br><span class="line">klist: No credentials cache found (filename: &#x2F;tmp&#x2F;krb5cc_1000)</span><br><span class="line"></span><br><span class="line">$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1000</span><br><span class="line">Default principal: postgres@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-15 14:57:53  2020-03-16 00:57:53  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:57:50</span><br><span class="line"></span><br><span class="line">$ psql -d postgres -U postgres -h pg.highgo.ca</span><br><span class="line">psql (12.2)</span><br><span class="line">GSSAPI-encrypted connection</span><br><span class="line">Type &quot;help&quot; for help.</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# \q</span><br><span class="line"></span><br><span class="line">$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1000</span><br><span class="line">Default principal: postgres@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-15 14:57:53  2020-03-16 00:57:53  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:57:50</span><br><span class="line">2020-03-15 14:58:00  2020-03-16 00:57:53  postgres&#x2F;pg.highgo.ca@</span><br><span class="line">	renew until 2020-03-16 14:57:50</span><br><span class="line">2020-03-15 14:58:00  2020-03-16 00:57:53  postgres&#x2F;pg.highgo.ca@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-16 14:57:50</span><br></pre></td></tr></table></figure>

<p><img src="/images/img/gssapi-postgres-client.png" alt="GSSAPI Client"><br>The result is almost the same as authenticate user <code>postgres</code> on PostgreSQL server, but if you look at the wireshark, you will find the PostgreSQL Server, i.e. <code>192.168.0.102</code> didn’t involve in the entire user authentication process. In other words, PostgreSQL Server only rely on the keytab file extracted from KDC server.</p>
<p>If you want to use a different user to log into database, then you need create the user on PostgreSQL server as database user, and create the principal for this user on KDC server. Create corresponding user authentication in <code>pg_hba.conf</code> file and restart PostgreSQL server. Then you should be able to use the new user to log in database from either Client machine or PostgreSQL server machine.</p>
<h4 id="8-Common-errors"><a href="#8-Common-errors" class="headerlink" title="8. Common errors"></a>8. Common errors</h4><p>Some common errors may happen during the PostgreSQL user authentication with Kerberos. Here is a short list.</p>
<ul>
<li><p>Try to connect before the user credentials has been cached</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql: error: could not connect to server: FATAL:  no pg_hba.conf entry for host &quot;192.168.0.103&quot;, user &quot;postgres&quot;, database &quot;postgres&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>User doesn’t exist in KDC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -h pg.highgo.ca -U jack</span><br><span class="line">psql: error: could not connect to server: FATAL:  no pg_hba.conf entry for host &quot;192.168.0.103&quot;, user &quot;jack&quot;, database &quot;postgres&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Service principal is expired</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d postgres -h pg.highgo.ca -U postgres</span><br><span class="line">psql: error: could not connect to server: could not initiate GSSAPI security context: Unspecified GSS failure.  Minor code may provide more information</span><br><span class="line">could not initiate GSSAPI security context: Ticket expired</span><br><span class="line">FATAL:  no pg_hba.conf entry for host &quot;192.168.0.103&quot;, user &quot;postgres&quot;, database &quot;postgres&quot;</span><br></pre></td></tr></table></figure>
<h4 id="9-Summary"><a href="#9-Summary" class="headerlink" title="9. Summary"></a>9. Summary</h4><p>In this blog, we explained how to enable GSSAPI from source code and the keytab file, discussed those three key configuration files, i.e. “PostgreSQL Configuration”, “PostgreSQL Client Authentication” and “PostgreSQL Users Mapping”, and we also demonstrated user authentication from different hosts with Kerberos. In next blog, we will discuss how to check authentication and encryption status for different connection requests.</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/03/11/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/11/PostgreSQL-GSSAPI-Authentication-with-Kerberos-part-1/" class="post-title-link" itemprop="url">PostgreSQL GSSAPI Authentication with Kerberos part-1: how to setup Kerberos on Ubuntu</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-11 06:00:00" itemprop="dateCreated datePublished" datetime="2020-03-11T06:00:00-07:00">2020-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-17 18:13:18" itemprop="dateModified" datetime="2020-03-17T18:13:18-07:00">2020-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/" itemprop="url" rel="index">
                    <span itemprop="name">Kerberos</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/" itemprop="url" rel="index">
                    <span itemprop="name">GSSAPI</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/" itemprop="url" rel="index">
                    <span itemprop="name">Authentication</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">Ubuntu</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kerberos/GSSAPI/Authentication/Ubuntu/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-part1.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL supports many secure ways to authenticate users, and one typical way is to use GSSAPI with Kerberos. However, when I was trying to investigate one issue which is related with GSSAPI in PostgreSQL, I couldn’t find a tutorial that I can follow to setup the environment easily. After some effort spent on Kerberos environment setup, I decided to write a blog to share what I have learned.</p>
<p>Since PostgreSQL GSSAPI user authentication does involve many background knowledge, I separate this blog into 3 parts: </p>
<ul>
<li>part-1 will be focusing on the basic concepts used in Kerberos, Servers/Clients/Services/Users setup, and environment verification;</li>
<li>part-2 will discuss all related configuration files required on PostgreSQL for using GSSAPI user authentication;</li>
<li>part-3 will explain how to check GSSAPI authentication, encryption and user principal information for different connection options to have a better understanding about GSSAPI on PostgreSQL.</li>
</ul>
<h4 id="2-Basic-Concepts-for-Kerberos"><a href="#2-Basic-Concepts-for-Kerberos" class="headerlink" title="2. Basic Concepts for Kerberos"></a>2. Basic Concepts for Kerberos</h4><p>Kerberos is a network authentication protocol, which is designed to allow users to prove their identities over a non-secure network in a secure manner. This protocol is an industry-standard protocol for secure authentication with the messages designed to against spying and replay attacks. It has been built into a wide range of software such as, Chrome, Firefox, OpenSSH, Putty, OpenLDAP, Thunderbird and PostgreSQL etc. There are some open source implementations available such as, <a href="https://github.com/krb5/krb5.git" target="_blank" rel="noopener">krb5</a> implemented by MIT used by most of the Unix-like Operating Systems, and <a href="https://github.com/heimdal/heimdal" target="_blank" rel="noopener">heimdal</a> used by OSX. Before dive into any detailed environment setup, some key concepts used in Kerberos need to be explained here.</p>
<p><strong>Realm</strong>: Realm is equivalent to a domain or a group that all the users and servers belong to. It is required during Kerberos installation. For example, <code>HIGHGO.CA</code>, will be used as the Realm in this blog (change it according to your needs).</p>
<p><strong>Principal</strong>: any users and services are defined as a principal in Kerberos. For example, <code>david</code>, <code>postgres</code>, <code>postgres/pg.highgo.ca</code> etc.</p>
<p><strong>Instance</strong>: Kerberos uses Instance to manage service principals and especially for administrative principals. For example, <code>root/admin</code> where <code>root</code> is the principal and <code>/admin</code> is the instance.</p>
<p><strong>SS</strong>: <strong>S</strong>ervice <strong>S</strong>erver provides the services. For example, <code>pg.highgo.ca</code> is a server provide PostgreSQL database access service.</p>
<p><strong>KDC</strong>: <strong>K</strong>ey <strong>D</strong>istribution <strong>C</strong>enter contains one database of all principals and two components:</p>
<ul>
<li><strong>AS</strong>: <strong>A</strong>uthentication <strong>S</strong>erver is responsible for the initial authentication request from users triggered by <code>kinit</code>.</li>
<li><strong>TGS</strong>: <strong>T</strong>icket <strong>G</strong>ranting <strong>S</strong>erver assigns the requested resource on a Service Server to the users. In this blog, both <strong>AS</strong> and <strong>TGS</strong> are all deployed on the same <strong>KDC</strong> server, i.e. <code>kdc.highgo.ca</code>.</li>
</ul>
<p><strong>TGT</strong>: <strong>T</strong>icket <strong>G</strong>ranting <strong>T</strong>icket is a message used to confirm the identity of the principals and to deliver session keys which is used for future secured communication among user, TGS, and SS.</p>
<p><strong>Keytab</strong>: a file extracted from the KDC principal database and contains the encryption key for a service or host. For example, <code>postgres.keytab</code> is the keytab file and will be used on PostgreSQL server, i.e. <code>hg.highgo.ca</code>.</p>
<p><strong>Client</strong>: a workstation needs to access a Service Server. For example, <code>psql</code> running on a Client machine and want to connect to PostgreSQL server.</p>
<h4 id="3-Kerberos-environment-setup"><a href="#3-Kerberos-environment-setup" class="headerlink" title="3. Kerberos environment setup"></a>3. Kerberos environment setup</h4><p><img src="/images/img/gssapi-diagram.png" alt="GSSAPI Diagram"><br>When PostgreSQL authenticates a user with Kerberos, the overall processes in above diagram can be interpreted in below order. </p>
<ul>
<li><strong>Client</strong> initiates the authentication process, <strong>AS</strong> sends Client a <em>temporary session key</em> (<em>grey key</em>) encrypted with Client’s key (<em>blue key</em>); </li>
<li><strong>Client</strong> uses the <em>temporary session key</em> to request services, <strong>TGS</strong> grants the services and sends two copies of the <em>communication session keys</em> (<em>yellow key</em>): one encrypted using <em>temporary session key</em> and another encrypted using Service Server’s key (<em>green key</em>); </li>
<li><strong>Client</strong> forwards the <em>communication session key</em>  to <strong>Service Server(PG)</strong> to confirm the user authentication. If it succeeded then both Client and Service Server will use the <em>communication session key</em> for the rest of the communication. </li>
</ul>
<p>The realm, hostnames, and IP addresses used in this diagram are list below.</p>
<ul>
<li><strong>Realm:</strong> HIGHGO.CA</li>
<li><strong>KDC (AS+TGS):</strong> kdc.highgo.ca (192.168.0.101)</li>
<li><strong>Service Server (Postgres Server):</strong> pg.highgo.ca (192.168.0.102)</li>
<li><strong>Client (psql):</strong> client (192.168.0.103)</li>
</ul>
<p>In the following sections, we will discuss the setup in details. Here is the list of all the steps.</p>
<ol>
<li>setup hostname and IP addresses for each machine</li>
<li>install Kerberos server packages on KDC server machine</li>
<li>add admin principal to KDC server</li>
<li>install Kerberos client packages on Client and Service server machine</li>
<li>add Service server principal to KDC server</li>
<li>add Client principal to KDC server</li>
<li>verify principal on Service server machine</li>
<li>verify principal on Client machine</li>
</ol>
<h5 id="3-1-Hostname-and-IP-addresses"><a href="#3-1-Hostname-and-IP-addresses" class="headerlink" title="3.1. Hostname and IP addresses"></a>3.1. Hostname and IP addresses</h5><p>Because Kerberos protocol has a timestamp involved, all three machines need to have the clock to be synchronized at all the time. This can be done by setup an NTP client pointing some NTP servers in a production environment, but for simple, you can set all three machines in the same time zone with Internet connected. If you don’t have a DNS server ready or if you don’t want to use DNS, then you can manually set up the hostname by performing below commands on a Unix-like machine.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim &#x2F;etc&#x2F;hostname</span><br></pre></td></tr></table></figure>
<p>Set <code>kdc</code>, <code>pg</code> and <code>client</code> accordingly to KDC, Service Server and Client machines</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim &#x2F;etc&#x2F;hosts</span><br></pre></td></tr></table></figure>
<p>Set below information to <code>/etc/hosts</code> for all three machines (change the hostname and IP addresses to fit your environment). </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.101	kdc.highgo.ca		kdc</span><br><span class="line">192.168.0.102	pg.highgo.ca		pg</span><br><span class="line">192.168.0.103	client.highgo.ca	client</span><br></pre></td></tr></table></figure>
<p>After the setup for all three machines are done, restart all three machines.</p>
<h5 id="3-2-KDC-server-installation"><a href="#3-2-KDC-server-installation" class="headerlink" title="3.2. KDC server installation"></a>3.2. KDC server installation</h5><p>To setup Kerberos on KDC machine, two packages, i.e. <code>krb5-kdc</code> and <code>krb5-admin-server</code> need to be installed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install krb5-kdc krb5-admin-server</span><br></pre></td></tr></table></figure>
<p>During the installation, the Kerberos will first ask for configuration of the realm. If you have the hosts setup already following about steps, then the realm will automatically show up, then simply click OK.<br><img src="/images/img/gssapi-realm.png" alt="Kerberos Realm"></p>
<p>Then it will ask to configure the Kerberos server, in our case, enter <code>kdc.highgo.ca</code><br><img src="/images/img/gssapi-kerberos-server.png" alt="Kerberos Server"></p>
<p>And then ask for the administrative server, in our case, again, <code>kdc.highgo.ca</code><br><img src="/images/img/gssapi-admin-server.png" alt="Kerberos Admin Server"></p>
<p>In the last step, it will remind you to use <code>krb5_newrealm</code> to setup the realm. Simply click OK.<br><img src="/images/img/gssapi-kerberos-ok.png" alt="Kerberos OK"></p>
<p>Now, let’s run the <code>krb5_newrealm</code> with sudo to set up the master key for KDC database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo krb5_newrealm</span><br><span class="line">Enter KDC database master key: </span><br><span class="line">Re-enter KDC database master key to verify:</span><br></pre></td></tr></table></figure>

<p>Before start the Kerberos configuration, here are some basic kerberos tools need to know.</p>
<ul>
<li>kadmin.local: KDC database administration tool used manage principal and policy.</li>
<li>kinit: used to obtain and cache Kerberos ticket-granting ticket.</li>
<li>klist: used to list principal and tickets held in a credentials cache, or the keys held in a keytab file.</li>
<li>ktutil: used to read, write, or edit entries in a keytab.</li>
<li>…</li>
</ul>
<h5 id="3-3-Admin-Principal-setup"><a href="#3-3-Admin-Principal-setup" class="headerlink" title="3.3. Admin Principal setup"></a>3.3. Admin Principal setup</h5><p>Once KDC server has been installed, we need to create an admin user to manage principals, and it is recommended to use a different username. In our case, <code>root/admin</code>. Below are the commands used for the setup.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kadmin.local</span><br><span class="line">Authenticating as principal root&#x2F;admin@HIGHGO.CA with password.</span><br><span class="line">kadmin.local:  addprinc root&#x2F;admin</span><br><span class="line">WARNING: no policy specified for root&#x2F;admin@HIGHGO.CA; defaulting to no policy</span><br><span class="line">Enter password for principal &quot;root&#x2F;admin@HIGHGO.CA&quot;: </span><br><span class="line">Re-enter password for principal &quot;root&#x2F;admin@HIGHGO.CA&quot;: </span><br><span class="line">Principal &quot;root&#x2F;admin@HIGHGO.CA&quot; created.</span><br><span class="line">kadmin.local:  exit</span><br></pre></td></tr></table></figure>
<p>You can check the principal <code>root/admin</code> by running <code>listprincs root/admin</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local:  listprincs root&#x2F;admin</span><br><span class="line">root&#x2F;admin@HIGHGO.CA</span><br></pre></td></tr></table></figure>

<p>Next, we need to assign the appropriate access control list to the admin user in the Kerberos configuration file <code>/etc/krb5kdc/kadm5.acl</code> which is used to manage access rights to the Kerberos database.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim &#x2F;etc&#x2F;krb5kdc&#x2F;kadm5.acl</span><br><span class="line">root&#x2F;admin@HIGHGO.CA    *</span><br></pre></td></tr></table></figure>
<p>The above configuration gives all privileges to admin principal <code>root/admin</code>.</p>
<p>Now, finally it is time to restart Kerberos service.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart krb5-admin-server.service</span><br></pre></td></tr></table></figure>

<p>Once Kerberos service is running again, we can perform a quick test. First, try <code>klist</code> to see if any credentials cache exists, then try to see if <code>root/admin</code> can be authenticated. If no error, then try to use <code>klist</code> again to list the principal cached. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line">klist: No credentials cache found (filename: &#x2F;tmp&#x2F;krb5cc_1000)</span><br></pre></td></tr></table></figure>
<p>The “No credentials cache found” tells us there is no principal has been authenticated yet. Let’s run <code>kinit root/admin</code> to see if we can get it authenticated.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kinit root&#x2F;admin</span><br><span class="line">Password for root&#x2F;admin@HIGHGO.CA:</span><br></pre></td></tr></table></figure>
<p>If no error during root principal init, then run <code>klist</code> again.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1000</span><br><span class="line">Default principal: root&#x2F;admin@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-12 17:18:53  2020-03-13 03:18:53  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-13 17:18:51</span><br></pre></td></tr></table></figure>
<p>If the credentials cache is found, then the KDC administrative principal setup is done.</p>
<h5 id="3-4-Service-Server-and-Client-installation"><a href="#3-4-Service-Server-and-Client-installation" class="headerlink" title="3.4. Service Server and Client installation"></a>3.4. Service Server and Client installation</h5><p>For Service Server and Client, we only need to install the client/user related packages. Run below commands on both Service Server and Client machines.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install krb5-user libpam-krb5 libpam-ccreds auth-client-config</span><br></pre></td></tr></table></figure>
<p>Same as KDC Server setup, it will ask for Realm, Kerberos server and Administrative server. Enter exactly the same information used for KDC Server and then click OK. After the installation is done, we should have below information configured in <code>/etc/krb5.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[realms]</span><br><span class="line">	HIGHGO.CA &#x3D; &#123;</span><br><span class="line">		kdc &#x3D; kdc.highgo.ca</span><br><span class="line">		admin_server &#x3D; kdc.highgo.ca</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>Now, back to KDC Server side to add principals for Service Server and Client.</p>
<h5 id="3-5-Add-principal-for-Service-Server"><a href="#3-5-Add-principal-for-Service-Server" class="headerlink" title="3.5. Add principal for Service Server"></a>3.5. Add principal for Service Server</h5><ul>
<li><p>Add a principal <code>postgres</code> which is the database user and the Linux login user.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kadmin.local</span><br><span class="line">kadmin.local:  addprinc postgres</span><br><span class="line">WARNING: no policy specified for postgres@HIGHGO.CA; defaulting to no policy</span><br><span class="line">Enter password for principal &quot;postgres@HIGHGO.CA&quot;: </span><br><span class="line">Re-enter password for principal &quot;postgres@HIGHGO.CA&quot;: </span><br><span class="line">Principal &quot;postgres@HIGHGO.CA&quot; created.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add a principal <code>postgres/pg.highgo.ca</code> as a principle instance for Service server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local:  addprinc postgres&#x2F;pg.highgo.ca</span><br><span class="line">WARNING: no policy specified for postgres&#x2F;pg.highgo.ca@HIGHGO.CA; defaulting to no policy</span><br><span class="line">Enter password for principal &quot;postgres&#x2F;pg.highgo.ca@HIGHGO.CA&quot;: </span><br><span class="line">Re-enter password for principal &quot;postgres&#x2F;pg.highgo.ca@HIGHGO.CA&quot;: </span><br><span class="line">Principal &quot;postgres&#x2F;pg.highgo.ca@HIGHGO.CA&quot; created.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract the service principal from KDC principal database to a keytab file, which will be used to configure PostgreSQL Server. The file should be saved to current folder when run below commands.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ktutil </span><br><span class="line">ktutil:  add_entry -password -p postgres&#x2F;pg.highgo.ca@HIGHGO.CA -k 1 -e aes256-cts-hmac-sha1-96</span><br><span class="line">Password for postgres&#x2F;pg.highgo.ca@HIGHGO.CA: </span><br><span class="line">ktutil:  wkt postgres.keytab</span><br><span class="line">ktutil:  exit</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="3-6-Add-principal-for-Client"><a href="#3-6-Add-principal-for-Client" class="headerlink" title="3.6. Add principal for Client"></a>3.6. Add principal for Client</h5><ul>
<li>add a principal <code>david</code> for Client, this is the login user for Clinet OS, and later will be used to log into database<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local:  addprinc david</span><br><span class="line">WARNING: no policy specified for david@HIGHGO.CA; defaulting to no policy</span><br><span class="line">Enter password for principal &quot;david@HIGHGO.CA&quot;: </span><br><span class="line">Re-enter password for principal &quot;david@HIGHGO.CA&quot;: </span><br><span class="line">Principal &quot;david@HIGHGO.CA&quot; created.</span><br></pre></td></tr></table></figure></li>
<li>check all the principals using <code>listprincs</code> to confirm <code>david@HIGHGO.CA</code>, <code>postgres@HIGHGO.CA</code> and <code>postgres/pg.highgo.ca@HIGHGO.CA</code> are all successfully created.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kadmin.local:  listprincs </span><br><span class="line">K&#x2F;M@HIGHGO.CA</span><br><span class="line">david@HIGHGO.CA</span><br><span class="line">kadmin&#x2F;admin@HIGHGO.CA</span><br><span class="line">kadmin&#x2F;changepw@HIGHGO.CA</span><br><span class="line">kadmin&#x2F;kdc.highgo.ca@HIGHGO.CA</span><br><span class="line">kiprop&#x2F;kdc.highgo.ca@HIGHGO.CA</span><br><span class="line">krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">postgres&#x2F;pg.highgo.ca@HIGHGO.CA</span><br><span class="line">postgres@HIGHGO.CA</span><br><span class="line">root&#x2F;admin@HIGHGO.CA</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="3-7-Verify-principal-on-Service-Server"><a href="#3-7-Verify-principal-on-Service-Server" class="headerlink" title="3.7. Verify principal on Service Server"></a>3.7. Verify principal on Service Server</h5><p>After the above principals have been created from KDC Server, let’s back to Service Server to verify the principal using klist and kinit.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ klist</span><br><span class="line">klist: No credentials cache found (filename: &#x2F;tmp&#x2F;krb5cc_1001)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ kinit postgres&#x2F;pg.highgo.ca</span><br><span class="line">Password for postgres&#x2F;pg.highgo.ca@HIGHGO.CA:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">postgres@pg:~$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1001</span><br><span class="line">Default principal: postgres&#x2F;pg.highgo.ca@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-12 18:25:23  2020-03-13 04:25:23  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-13 18:25:20</span><br></pre></td></tr></table></figure>

<h5 id="3-8-Verify-principal-on-Client"><a href="#3-8-Verify-principal-on-Client" class="headerlink" title="3.8. Verify principal on Client"></a>3.8. Verify principal on Client</h5><p>Now, back to Client machine to verify the principal using klist and kinit.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">david@client:~$ klist</span><br><span class="line">klist: No credentials cache found (filename: &#x2F;tmp&#x2F;krb5cc_1000)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">david@client:~$ kinit david</span><br><span class="line">Password for david@HIGHGO.CA:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">david@client:~$ klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_1000</span><br><span class="line">Default principal: david@HIGHGO.CA</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">2020-03-12 18:21:41  2020-03-13 04:21:41  krbtgt&#x2F;HIGHGO.CA@HIGHGO.CA</span><br><span class="line">	renew until 2020-03-13 18:21:38</span><br></pre></td></tr></table></figure>
<p>If the principals verification are all success on both Service Server and Client machines, then we are ready to configure PostgreSQL and prepare GSSAPI user authentication with Kerberos.</p>
<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>In this blog, we explained the basic concepts used in Kerberos, performed a step by step setup on Ubuntu, added all the required principals to KDC, and also verified each principal which will be used in next two blogs.</p>
<p><em><strong>Reference:</strong></em></p>
<ol>
<li><a href="https://help.ubuntu.com/lts/serverguide/kerberos.html" target="_blank" rel="noopener">Kerberos on ubuntu</a></li>
<li><a href="https://simple.wikipedia.org/wiki/Kerberos_(protocol)" target="_blank" rel="noopener">Kerberos wiki</a></li>
<li><a href="https://www.postgresql.org/docs/current/gssapi-auth.html" target="_blank" rel="noopener">PostgreSQL GSSAPI Authentication</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2019/12/31/How-to-create-debug-and-test-an-extension-written-in-C-for-PostgreSQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/31/How-to-create-debug-and-test-an-extension-written-in-C-for-PostgreSQL/" class="post-title-link" itemprop="url">How to create, debug and test an extension written in C for PostgreSQL</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-31 00:00:00" itemprop="dateCreated datePublished" datetime="2019-12-31T00:00:00-08:00">2019-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-19 12:54:43" itemprop="dateModified" datetime="2020-01-19T12:54:43-08:00">2020-01-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres/" itemprop="url" rel="index">
                    <span itemprop="name">Postgres</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres/Eclipse/" itemprop="url" rel="index">
                    <span itemprop="name">Eclipse</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres/Eclipse/Test/" itemprop="url" rel="index">
                    <span itemprop="name">Test</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres/Eclipse/Test/Debug/" itemprop="url" rel="index">
                    <span itemprop="name">Debug</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Postgres/Eclipse/Test/Debug/Extension/" itemprop="url" rel="index">
                    <span itemprop="name">Extension</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL is one of the most popular free open-source relational database management systems in the world. Other than complies to SQL standard, PostgreSQL also provides a great extensibility which allows users to define their own extensions. With such a great feature, PostgreSQL is not only a database but also an application development platform. In this tutorial, we will go through the entire process about creating an extension, running test against this extension, and debugging the extneson using Eclipse.</p>
<h4 id="2-Create-an-extension"><a href="#2-Create-an-extension" class="headerlink" title="2. Create an extension"></a>2. Create an extension</h4><p>To create an extension in PostgreSQL, you need at least two files: <code>control</code> file and <code>SQL script</code> file. The <code>control</code> file uses a naming convention <code>extension_name.control</code>. let‘s create an extension call <code>get_sum</code>, then the confile file should contain the basic information like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat get_sum.control </span><br><span class="line"># get_sum postgresql extension</span><br><span class="line">comment &#x3D; &#39;simple sum of two integers for postgres extension using c&#39;</span><br><span class="line">default_version &#x3D; &#39;0.0.1&#39;</span><br><span class="line">module_pathname &#x3D; &#39;$libdir&#x2F;get_sum&#39;</span><br><span class="line">relocatable &#x3D; false</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>comment</code> comments about this extension</p>
</li>
<li><p><code>default_version</code> the version of this extension which is also part of the SQL script file</p>
</li>
<li><p><code>module_pathname</code> specifies the shared library path for this extension</p>
</li>
</ul>
<p>The <code>SQL script</code> file must be named as <code>extension_name--version.sql</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cat get_sum--0.0.1.sql </span><br><span class="line">--complain if script is sourced in psql, rather than via CREATE EXTENSION</span><br><span class="line">\echo Use &quot;CREATE EXTENSION get_sum&quot; to load this file. \quit</span><br><span class="line"> </span><br><span class="line">CREATE OR REPLACE FUNCTION get_sum(int, int) RETURNS int</span><br><span class="line">AS &#39;$libdir&#x2F;get_sum&#39;</span><br><span class="line">LANGUAGE C IMMUTABLE STRICT;</span><br></pre></td></tr></table></figure>
<p>The second line is to avoid loading this SQL script using <code>psql</code>, and the rest declares the <code>get_sum</code> function will be created in shared library using c language.</p>
<p>Typically, an extension not only defines new objects, but also adds new logic to deal with those new objects. To boost the performance, you should write the logic in C code with a <code>Makefile</code>.  PostgreSQL provides a build infrastructure for extension called <code>PGXS</code>, which uses a global variable <code>USE_PGXS</code> to include the global <code>PGXS</code> makefiles. One typical <code>Makefile</code> example found in PostgreSQL is something like below. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MODULE_big &#x3D; dblink</span><br><span class="line">… … </span><br><span class="line"></span><br><span class="line">ifdef USE_PGXS</span><br><span class="line">PG_CONFIG &#x3D; pg_config</span><br><span class="line">PGXS :&#x3D; $(shell $(PG_CONFIG) --pgxs)</span><br><span class="line">include $(PGXS)</span><br><span class="line">else</span><br><span class="line">SHLIB_PREREQS &#x3D; submake-libpq</span><br><span class="line">subdir &#x3D; contrib&#x2F;dblink</span><br><span class="line">top_builddir &#x3D; ..&#x2F;..</span><br><span class="line">include $(top_builddir)&#x2F;src&#x2F;Makefile.global</span><br><span class="line">include $(top_srcdir)&#x2F;contrib&#x2F;contrib-global.mk</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>With <code>PGXS</code> build infrastructure, you can build your extension by simply typing <code>make</code> If you put your extension under the <code>contrib</code> folder within PostgreSQL source tree, or you have to  specify the <code>PG_CONFIG</code> to tell the <code>make</code> command where to find out the <code>pg_config</code> If you put your extension somewhere else.</p>
<p>In the latest PostgreSQL official document, the assumption that an extension should be under the PostgreSQL source tree has been removed. The reason is that there are more and more extension coming from the Internet, and it is not easy to manage so many extensions within PostgreSQL source tree. Let’s follow the latest instruction to build our <code>Makefile</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat Makefile </span><br><span class="line">MODULES &#x3D; get_sum</span><br><span class="line">EXTENSION &#x3D; get_sum 	# the extersion&#39;s name</span><br><span class="line">DATA &#x3D; get_sum--0.0.1.sql	# script file to install</span><br><span class="line">REGRESS &#x3D; get_sum_test  	# the test script file</span><br><span class="line"> </span><br><span class="line"># for posgres build</span><br><span class="line">PG_CONFIG &#x3D; pg_config</span><br><span class="line">PGXS :&#x3D; $(shell $(PG_CONFIG) --pgxs)</span><br><span class="line">include $(PGXS)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>MODUELS</code> specifies the shared object can be used in psql</p>
</li>
<li><p><code>EXTENSION</code> specifies the extension name</p>
</li>
<li><p><code>DATA</code> specifies the SQL scripts</p>
</li>
<li><p><code>REGRESS</code> specifies the regression test script file</p>
</li>
</ul>
<p>The rest is following the latest recommendation from postgreSQL official <a href="https://www.postgresql.org/docs/current/extend-pgxs.html" target="_blank" rel="noopener">website</a>. In other words, we should always provide the <code>PG_CONFIG</code> when building or testing the extension.  </p>
<p>Once the <code>Makefile</code> is set, you need to create a C file. In this tutorial, we build a simple <code>get_sum</code> function to explain how to add a C file into the extension.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat get_sum.c</span><br><span class="line">#include &quot;postgres.h&quot;</span><br><span class="line">#include &quot;fmgr.h&quot;</span><br><span class="line"></span><br><span class="line">PG_MODULE_MAGIC;</span><br><span class="line"></span><br><span class="line">PG_FUNCTION_INFO_V1(get_sum);</span><br><span class="line"></span><br><span class="line">Datum</span><br><span class="line">get_sum(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">    bool isnull, isnull2;</span><br><span class="line"></span><br><span class="line">    isnull &#x3D; PG_ARGISNULL(0);</span><br><span class="line">    isnull2 &#x3D; PG_ARGISNULL(1);</span><br><span class="line">    if (isnull || isnull2)</span><br><span class="line">      ereport( ERROR,</span><br><span class="line">               ( errcode(ERRCODE_FEATURE_NOT_SUPPORTED),</span><br><span class="line">               errmsg(&quot;two and only two integer values are required as input&quot;)));</span><br><span class="line"></span><br><span class="line">    int32 a &#x3D; PG_GETARG_INT32(0);</span><br><span class="line">    int32 b &#x3D; PG_GETARG_INT32(1);</span><br><span class="line">    int32 sum;</span><br><span class="line"></span><br><span class="line">    sum &#x3D; a + b;</span><br><span class="line"></span><br><span class="line">    PG_RETURN_INT32(sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, the header file <code>postgres.h</code> includes most of the basic stuff needed for interfacing with Postgres. It should be included in every C-File when declares Postgres functions. The header file <code>fmgr.h</code> needs to be included in order to use <code>PG_GETARG_XXX</code>, <code>PG_RETURN_XXX</code> and  <code>PG_ARGISNULL</code> macros. The details about the macros are defined <a href="https://www.postgresql.org/docs/current/xfunc-c.html" target="_blank" rel="noopener">here</a>. This extension function is declared as <code>get_sum</code> with two integers as input parameters, and the result is the sum of these two input parameters.</p>
<h4 id="3-Test-an-extension"><a href="#3-Test-an-extension" class="headerlink" title="3. Test an extension"></a>3. Test an extension</h4><p>In order to verify this extension, we need to follow PostgreSQL regression test framework to add some test cases. First, we need to create a folder named as <code>sql</code>, which contains the SQL test scripts need to be run.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cat sql&#x2F;get_sum_test.sql </span><br><span class="line">CREATE EXTENSION get_sum;</span><br><span class="line">SELECT get_sum(1::INT, 1::INT);</span><br><span class="line">SELECT get_sum(101::INT, 202::INT);</span><br><span class="line">SELECT get_sum(0::INT, 0::INT);</span><br><span class="line">SELECT get_sum(-1::INT, 0::INT);</span><br><span class="line">SELECT get_sum(-1::INT, -1::INT);</span><br><span class="line">SELECT get_sum(-101::INT, -202::INT);</span><br><span class="line">SELECT get_sum(NULL::INT, 11::INT);</span><br><span class="line">SELECT get_sum(-1::INT, NULL::INT);</span><br><span class="line">SELECT get_sum(0::INT, 2147483647::INT);</span><br><span class="line">SELECT get_sum(-2147483648::INT, 0::INT);</span><br><span class="line">SELECT get_sum(2147483647::INT, 2147483647::INT);</span><br><span class="line">SELECT get_sum(-2147483648::INT, -2147483648::INT);</span><br><span class="line">SELECT get_sum(-2147483648::INT, 2147483647::INT);</span><br><span class="line">SELECT get_sum(2147483647::INT, -2147483648::INT);</span><br><span class="line">SELECT get_sum(111111111111111::INT, 222222222222222::INT);</span><br></pre></td></tr></table></figure>
<p>Then we need to create another folder called <code>expected</code>, as the name indicated, it holds the expected output corresponding to the test SQL script. To build the expected output, as <a href="https://www.postgresql.org/docs/current/extend-pgxs.html" target="_blank" rel="noopener">recommended</a> by postgresSQL: run the test once, a results folder will be generated with the test results named as script_name.out, check the result to see if it is what you expected, then simply copy this result file to <code>expected</code> folder. If you run the test again, the regress test framework will compare a new test results output against the file in <code>expected</code> folder, if any difference found, then a .diff file will be created. Now, let’s run a test.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd crontrib&#x2F;get_sum&#x2F;</span><br><span class="line">make PGUSER&#x3D;postgres PG_CONFIG&#x3D;~&#x2F;eclipse-workspace&#x2F;postgres&#x2F;bin&#x2F;pg_config install</span><br></pre></td></tr></table></figure>
<p>Build and install the extension including shared library, contorl and SQL script files, then run installcheck to test the extension function using the SQL test scripts.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make PGUSER&#x3D;postgres PG_CONFIG&#x3D;~&#x2F;eclipse-workspace&#x2F;postgres&#x2F;bin&#x2F;pg_config installcheck</span><br></pre></td></tr></table></figure>

<p>If the extension function works properly, then you should see the message like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;david&#x2F;eclipse-workspace&#x2F;postgres&#x2F;lib&#x2F;pgxs&#x2F;src&#x2F;makefiles&#x2F;..&#x2F;..&#x2F;src&#x2F;test&#x2F;regress&#x2F;pg_regress --inputdir&#x3D;.&#x2F; --bindir&#x3D;&#39;&#x2F;home&#x2F;david&#x2F;eclipse-workspace&#x2F;postgres&#x2F;bin&#39; --dbname&#x3D;contrib_regression get_sum_test  	</span><br><span class="line">(using postmaster on Unix socket, default port)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; dropping database &quot;contrib_regression&quot; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">DROP DATABASE</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; creating database &quot;contrib_regression&quot; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">CREATE DATABASE</span><br><span class="line">ALTER DATABASE</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; running regression test queries        &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">test get_sum_test                 ... ok           24 ms</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> All 1 tests passed. </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>


<h4 id="4-Debug-an-extension"><a href="#4-Debug-an-extension" class="headerlink" title="4. Debug an extension"></a>4. Debug an extension</h4><p>This <code>get_sum</code> is a very simple example to show the basic when creating a new extension from scratch. In reality, the extension will be way complicated, and you might need to keep debugging the extension until it works as designed. If you follow <a href="https://idrawone.github.io/postgresql/eclipse/debug/2019/12/30/How-to-build-PostgreSQL-source-code-using-Eclipse-on-Ubuntu-18.04.html">my previous post</a>, then we can use Eclipse to debug this extension. </p>
<p>First, turn on a Linux terminal and start the <code>postgers</code> services, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pg_ctl -D $HOME&#x2F;pg12data&#x2F;data&#x2F; -l logfile start</span><br></pre></td></tr></table></figure>

<p>And then start a <code>psql</code> connection,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ psql -U postgres</span><br><span class="line">psql (12.1)</span><br><span class="line">Type &quot;help&quot; for help.</span><br></pre></td></tr></table></figure>

<p>Now, create the extension for <code>get_sum</code>,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# CREATE EXTENSION get_sum;</span><br><span class="line">CREATE EXTENSION</span><br></pre></td></tr></table></figure>

<p>Turn on another terminal, run <code>ps -ef |grep postgres</code> to find out the pid of the <code>postgres</code> which is dealing with requests coming from current <code>psql</code> connection.</p>
<p>Switch back to the <code>Eclipse</code>, right click on project, select <code>Debug As</code>, then select <code>Debug Configurations…</code>. Fill in the information as shown below then click <code>Debug</code>.</p>
<p><img src="/images/img/attach-postgres.png" alt="GitHub Logo"></p>
<p>A window will pop up like below for you to choose the right progres to attach.<br><img src="/images/img/find-postgres-server2.png" alt="GitHub Logo"></p>
<p>Switch to the <code>psql</code> terminal, then type a query to use this extension, for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# select get_sum(111, 222);</span><br></pre></td></tr></table></figure>

<p>The terminal should be frozen immediately. Switch back to <code>Eclipse</code>, and you should see the <code>postgres</code> stopped inside <code>get_sum</code> c function. If you type <code>bt</code> from the <code>Debugger Console</code>, then the <code>backtrace</code> should show up like below and you can dig into it to see how the extension is eventually called.<br><img src="/images/img/debugger-console-bt2.png" alt="GitHub Logo"></p>
<p>Now, you can try to print out the input variables and the result before and after, and compare with the <code>psql</code> console input and output. If anything goes wrong, you use Elipse to find out the issue and fix the extension code from there. </p>
<p>Below is the Eclipse debugging message,<br><img src="/images/img/eclipse-step-in.png" alt="GitHub Logo"></p>
<p>This is the <code>psql</code> console screenshot,<br><img src="/images/img/psql-console-get-sum.png" alt="GitHub Logo"></p>
<p>All the source code used in this tutorial is available <a href="https://github.com/idrawone/get_sum.git" target="_blank" rel="noopener">here</a></p>
<h4 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h4><p>In this blog, we discussed how to create an extension from scratch within <code>PGXS</code> build infrastrature, how to create some test cases to test the extension, and we also covered the procedure of debugging an extension using Eclipse. </p>
<p><em><strong>Reference:</strong></em></p>
<p><a href="https://www.highgo.ca/2019/10/01/a-guide-to-create-user-defined-extension-modules-to-postgres/" target="_blank" rel="noopener">1. A Guide to Create User-Defined Extension Modules to Postgres</a></p>
<p><a href="https://idrawone.github.io/postgresql/eclipse/debug/2019/12/30/How-to-build-PostgreSQL-source-code-using-Eclipse-on-Ubuntu-18.04.html">2. How to build and debug PostgreSQL 12 using latest Eclipse IDE on Ubuntu 18.04</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="David Zhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">David Zhang</p>
  <div class="site-description" itemprop="description">knowledge is power</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
