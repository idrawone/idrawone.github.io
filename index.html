<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://idrawone.github.io').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="knowledge is power">
<meta property="og:type" content="website">
<meta property="og:title" content="David&#39;s Blog">
<meta property="og:url" content="https://idrawone.github.io/index.html">
<meta property="og:site_name" content="David&#39;s Blog">
<meta property="og:description" content="knowledge is power">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="David Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://idrawone.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>David's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="David's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">David's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">knowledge is power</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">21</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2022/02/28/acquire-a-lightweight-lock-in-deep/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/28/acquire-a-lightweight-lock-in-deep/" class="post-title-link" itemprop="url">Acquire a Lightweight lock in deep</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-02-28 00:00:00 / Modified: 14:05:03" itemprop="dateCreated datePublished" datetime="2022-02-28T00:00:00-08:00">2022-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Lightweight-lock/" itemprop="url" rel="index">
                    <span itemprop="name">Lightweight lock</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Lightweight-lock/performance/" itemprop="url" rel="index">
                    <span itemprop="name">performance</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Lightweight-lock/performance/shared/" itemprop="url" rel="index">
                    <span itemprop="name">shared</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Lightweight-lock/performance/shared/exclusive/" itemprop="url" rel="index">
                    <span itemprop="name">exclusive</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-lwlock.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>Recently, I was working on an internal issue related with buffer manager in PostgreSQL, and I saw a typical use of the Lightweight lock in buffer manager like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1   INIT_BUFFERTAG(newTag, smgr_rnode.node, forkNum, blockNum);</span><br><span class="line">2   newHash &#x3D; BufTableHashCode(&amp;newTag);</span><br><span class="line">3   newPartitionLock &#x3D; BufMappingPartitionLock(newHash);</span><br><span class="line">4   LWLockAcquire(newPartitionLock, LW_SHARED);</span><br><span class="line">5   buf_id &#x3D; BufTableLookup(&amp;newTag, newHash);</span><br><span class="line">6   LWLockRelease(newPartitionLock);</span><br></pre></td></tr></table></figure>

<p>Basically, when the buffer manger needs to access a buffer block using buffer tag, it will have to acquire a lightweight lock in either shared or exclusive mode, then find the buffer block and then release the lightweight lock.</p>
<p>Since the buffer manager is shared among multiple backends and a buffer block is accessed very often, this snippet has to be designed to protect the data consistency for read and write and no impact on performance.</p>
<p>This blog will explain how this snippet works in PostgreSQL and emphasize a little bit more on the lightweight lock acquire.</p>
<h4 id="2-how-to-use-snapshot-public-functions"><a href="#2-how-to-use-snapshot-public-functions" class="headerlink" title="2. how to use snapshot public functions"></a>2. how to use snapshot public functions</h4><p>Now, let’s go through the snippet above line by line.<br>The first line simply uses a Macro to initialize a buffer tag using those five numbers. Here, <code>INIT_BUFFERTAG</code> is a macro defines like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#define INIT_BUFFERTAG(a,xx_rnode,xx_forkNum,xx_blockNum) \</span><br><span class="line">( \</span><br><span class="line">    (a).rnode &#x3D; (xx_rnode), \</span><br><span class="line">    (a).forkNum &#x3D; (xx_forkNum), \</span><br><span class="line">    (a).blockNum &#x3D; (xx_blockNum) \</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>After the macro call, the newTag has been assigned with those five numbers, i.e., table space number, database number, relation number, fork number (data, fsm or visibility map etc), and the block number (each block is 8k) within the actual file;</p>
<p>The second line <code>newHash = BufTableHashCode(&amp;newTag);</code> generates a hash number based on the buffer tag. Where, The function <code>BufTableHashCode</code> computes the hash code associated with given buffer tag in the global shared buffer hash table, and return a unsigned integer.</p>
<p>The third line retrieves a partition lock within the locks pool used an unsigned integer hash number mod the total number of partition locks (default 128).<br>Again, the function BufMappingPartitionLock is a predefined macro and is showing below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define BufMappingPartitionLock(hashcode) \</span><br><span class="line">    (&amp;MainLWLockArray[BUFFER_MAPPING_LWLOCK_OFFSET + \</span><br><span class="line">        BufTableHashPartition(hashcode)].lock)</span><br></pre></td></tr></table></figure>

<p>It will return a lock in <code>MainLWLockArray</code> lightweight locks array. Where the <code>BUFFER_MAPPING_LWLOCK_OFFSET</code> is number of dedicated lightweight locks defined in <code>lwlocknames.txt</code> file. The number of partition lightweight locks are 128 locks located after these dedicated locks defined in these main lightweight locks array. Here, the macro <code>BufTableHashPartition</code> is to make sure it always returns a lock in the partition locks pool for any given hash number.</p>
<p>The fourth line to is to acquire the lightweight lock with a very efficient algorithm. This <code>LWLockAcquire</code> will help return a lightweight lock in the specified mode, i.e., shared (for read only operation) or exclusive (for write operation). This function returns <code>true</code> if the lock was available immediately, <code>false</code> if it has to sleep and wait.<br>Inside this <code>LWLockAcquire</code>, there are many considerations, but I want to emphasize one smart c implementation in the function <code>LWLockAttemptLock</code>, and I believe you can use this similar idea as a design pattern to design other CPU and Memory sensitive logic in your applications.<br>As you can see below is the key implementation of this shared and exclusive lock.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if (mode &#x3D;&#x3D; LW_EXCLUSIVE)</span><br><span class="line">&#123;</span><br><span class="line">    lock_free &#x3D; (old_state &amp; LW_LOCK_MASK) &#x3D;&#x3D; 0;</span><br><span class="line">    if (lock_free)</span><br><span class="line">        desired_state +&#x3D; LW_VAL_EXCLUSIVE;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    lock_free &#x3D; (old_state &amp; LW_VAL_EXCLUSIVE) &#x3D;&#x3D; 0;</span><br><span class="line">    if (lock_free)</span><br><span class="line">        desired_state +&#x3D; LW_VAL_SHARED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This implementation involves three macros: <code>LW_LOCK_MASK</code>, <code>LW_VAL_EXCLUSIVE</code> and <code>LW_VAL_SHARED</code>, where <code>LW_LOCK_MASK</code> is a consistent number, i.e., <code>0xFFFFFF</code>, used in bit operation. If any lower 24 bits has a one, then it means the lock is held in either shared or exclusive mode. In other words, someone is still reading the data, if you want the update the data, please wait. If the all lower 24 bits are zeros, then it will be assigned to a big number <code>LW_VAL_EXCLUSIVE</code>, i.e., <code>0x800000</code>, which indicates the lock is used as exclusive. If you want to acquire this lock in shared mode, then as long as the lock is not held by someone in exclusive mode and it is not held more than <code>0x7FFFFF</code>, then you can acquire one shared lock and the number of usages will be simple increase by one, i.e., <code>LW_VAL_SHARED</code>. Of course, how many shared locks can be held at the same time is limited by other parameters.</p>
<p>Here is the definition of these three macros.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define LW_LOCK_MASK                ((uint32) ((1 &lt;&lt; 25)-1))</span><br><span class="line">#define LW_VAL_EXCLUSIVE            ((uint32) 1 &lt;&lt; 24)</span><br><span class="line">#define LW_VAL_SHARED               1</span><br></pre></td></tr></table></figure>

<p>The fifth line looks up the buffer id using the given buffer tag and hash code.<br>Once you have acquired the lock, work on the operations immediately depends on your application, but keep in mind the lightweight lock is designed to be held only in a short period. </p>
<p>The sixth line release the lock back to the partition lock pool.<br>After you finished your operations either read or write, then use this LWLockRelease function to release the lock as soon as you can, so you don’t block other processes too long especially if there is a write operation need to acquire this lock in exclusive mode. </p>
<h4 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3. Summary"></a>3. Summary</h4><p>In this blog, we discussed a typical snippet which uses a lightweight lock in PostgreSQL, and explained one of the most efficient piece of code implemented for Lightweight lock in PostgreSQL, i.e., LWLockAcquire. I hope this can help when you want to achieve a similar result in your own design.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2022/01/28/transaction-id-and-snapshot-information-functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/28/transaction-id-and-snapshot-information-functions/" class="post-title-link" itemprop="url">Transaction ID and Snapshot information functions</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-01-28 00:00:00 / Modified: 15:54:23" itemprop="dateCreated datePublished" datetime="2022-01-28T00:00:00-08:00">2022-01-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/transaction-id/" itemprop="url" rel="index">
                    <span itemprop="name">transaction id</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/transaction-id/snapshot/" itemprop="url" rel="index">
                    <span itemprop="name">snapshot</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/transaction-id/snapshot/public-function/" itemprop="url" rel="index">
                    <span itemprop="name">public function</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-snapshot.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>I recently investigated one internal issue which was related with snapshot and found there were some changes on transaction id and snapshot information functions in PostgreSQL. Here, I am trying to share what I have learned. </p>
<p>Before PostgreSQL 13, all transaction id and snapshot related public functions were named as txid_xxx_yyy, such as,<br>txid_current(), which returns the current toplevel transaction ID.<br>txid_current_if_assigned(), which is similar to txid_current() but doesn’t assign a new xid if there isn’t one.<br>txid_current_snapshot(), which returns current snapshot in txid format with only top-transaction XIDs.<br>txid_status(), which reports the status of a recent transaction ID.</p>
<p>Started from PostgreSQL 13, the naming convention of these snapshot public functions txid_xxx_yyy has been changed to something like, pg_xxx_xact_yyy correspondingly. For example, txid_current() is replaced by pg_current_xact_id(), and txid_current_if_assigned() has been renamed to pg_current_xact_id_if_assigned(), etc.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">commit 4c04be9b05ad2ec5acd27c3417bf075c13cab134 (HEAD -&gt; xid8funcs)</span><br><span class="line">Author: Thomas Munro &lt;tmunro@postgresql.org&gt;</span><br><span class="line">Date:   Tue Apr 7 11:33:56 2020 +1200</span><br><span class="line"></span><br><span class="line">    Introduce xid8-based functions to replace txid_XXX.</span><br><span class="line">    </span><br><span class="line">    The txid_XXX family of fmgr functions exposes 64 bit transaction IDs to</span><br><span class="line">    users as int8.  Now that we have an SQL type xid8 for FullTransactionId,</span><br><span class="line">    define a new set of functions including pg_current_xact_id() and</span><br><span class="line">    pg_current_snapshot() based on that.  Keep the old functions around too,</span><br><span class="line">    for now.</span><br><span class="line">    </span><br><span class="line">    It&#39;s a bit sneaky to use the same C functions for both, but since the</span><br><span class="line">    binary representation is identical except for the signedness of the</span><br><span class="line">    type, and since older functions are the ones using the wrong signedness,</span><br><span class="line">    and since we&#39;ll presumably drop the older ones after a reasonable period</span><br><span class="line">    of time, it seems reasonable to switch to FullTransactionId internally</span><br><span class="line">    and share the code for both.</span><br></pre></td></tr></table></figure>

<p>Introduce xid8-based functions to replace txid_XXX.</p>
<p>An official documentation regarding these functions can be found at <a href="https://www.postgresql.org/docs/14/functions-info.html" target="_blank" rel="noopener">Transaction ID and Snapshot Information Functions</a> at Table 9.76. Transaction ID and Snapshot Information Functions.</p>
<h4 id="2-how-to-use-snapshot-public-functions"><a href="#2-how-to-use-snapshot-public-functions" class="headerlink" title="2. how to use snapshot public functions"></a>2. how to use snapshot public functions</h4><p>Since PostgreSQL has provided us so many public functions for end users to check the transaction id and snapshot information in details, sometimes, we need to know how to use these funtions in a simple query to have better understanding of the ongoing transactions, visibilities, and snapshots. Here, I have some simple examples to share.</p>
<p>first, let’s create a simple table like below,<br>postgres=# create table tbl01 (a int, b text);<br>CREATE TABLE</p>
<p>to find out the current transaction id, you can simply do <code>select pg_current_xact_id();</code> in a psql console,<br>postgres=# select pg_current_xact_id();<br> pg_current_xact_id </p>
<hr>
<pre><code>734</code></pre><p>(1 row)<br>Here, the number 734 is the current transaction id. Each time, when you run such a query, the transaction id will increase by one.</p>
<p>postgres=# select pg_current_xact_id();<br> pg_current_xact_id </p>
<hr>
<pre><code>735</code></pre><p>(1 row)</p>
<p>If you want to know the current transaction id, then use function <code>pg_current_xact_id_if_assigned()</code>. Obversely, as the document indicated, if you are not within a transaction, this function won’t return any transaction id.<br>postgres=# select pg_current_xact_id_if_assigned();<br> pg_current_xact_id_if_assigned </p>
<hr>
<p>(1 row)</p>
<p>However, if start a transaction with begin, followed a simple insert query like below, and then run the function <code>pg_current_xact_id_if_assigned()</code> again, you should be able to find out your current transaction id.<br>postgres=# begin ;<br>BEGIN<br>postgres=<em># insert into tbl01 values(1,’hello world’);<br>INSERT 0 1<br>postgres=</em># select pg_current_xact_id_if_assigned();<br> pg_current_xact_id_if_assigned </p>
<hr>
<pre><code>736</code></pre><p>(1 row)</p>
<p>The function <code>pg_current_snapshot()</code> will return current top level snapshot in a format like, <code>xmin:xmax:xid1,xid2</code>. For example,<br>postgres=*#  select pg_current_snapshot();<br> pg_current_snapshot </p>
<hr>
<p> 736:736:<br>(1 row<br>In this case, the PostgreSQL server has only one ongoing transaction which is 736.   </p>
<p>One of the use cases for end user is that a user may want to check the tuples visibilities using pg_current_snapshot and pg_current_xact_id_if_assigned. For example, start two psql consoles with begin and followed by one simple insert operation, then check the current transaction id and current snapshots.</p>
<p>postgres=*# select pg_current_xact_id_if_assigned();<br> pg_current_xact_id_if_assigned </p>
<hr>
<pre><code>736</code></pre><p>(1 row)</p>
<p>postgres=*#  select pg_current_snapshot();<br> pg_current_snapshot </p>
<hr>
<p> 736:739:737<br>(1 row)<br>In the first console, it tells that the current transactions id is 736, and there is another ongoing transaction 737 and any tuples update made by transaction 737 is not visibile to this console yet.</p>
<p>postgres=*# select pg_current_xact_id_if_assigned();<br> pg_current_xact_id_if_assigned </p>
<hr>
<pre><code>737</code></pre><p>(1 row)</p>
<p>postgres=*# select pg_current_snapshot();<br> pg_current_snapshot </p>
<hr>
<p> 736:739:736<br>(1 row)</p>
<p>If you check the assigned transaction id and current snapshot in the second console, it will tell you a similar information. With these two public fucntions and plus an extension pageinspect, it can help debug the tuple visibilities issue.</p>
<h4 id="3-Summary"><a href="#3-Summary" class="headerlink" title="3. Summary"></a>3. Summary</h4><p>In this blog, we discussed the changes made for those transaction id and snapshot public functions, and shared a few simple queries about how to use these snapshots related public funtions. It might be useful if you want to have a better understanding of the ongoing transactions and snapshots.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/11/26/how-to-run-a-specific-regression-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/26/how-to-run-a-specific-regression-test/" class="post-title-link" itemprop="url">How to run a specific regression test</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-11-26 00:00:00 / Modified: 16:26:44" itemprop="dateCreated datePublished" datetime="2021-11-26T00:00:00-08:00">2021-11-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/regression-TAP/" itemprop="url" rel="index">
                    <span itemprop="name">regression TAP</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/regression-TAP/test/" itemprop="url" rel="index">
                    <span itemprop="name">test</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-tap-test.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>I have been working on an internal project based on PostgreSQL for a while, and from time to time, I need to run some specific test cases to verify my changes. Here, I want to shared a tip to run a specific regression TAP test quickly, especially, when you are focusing on a particular bug and you know which test case can help verify the fix. A details document about the regression test can be found at <a href="https://www.postgresql.org/docs/14/regress-run.html" target="_blank" rel="noopener">Running the Tests</a>.</p>
<h4 id="2-Regression-test"><a href="#2-Regression-test" class="headerlink" title="2. Regression test"></a>2. Regression test</h4><p>PostgreSQL provides a comprehensive set of regression tests to verify the SQL implementation embedded in PostgreSQL as well as the extended capabilities of PostgreSQL. Whenever you make some changes, you should run these existing test cases to make sure your change doesn’t break any existing features. Other than these regression tests, there are some special features using a test framework call TAP test. For example, <code>kerberos</code>, <code>ssl</code>, <code>recovery</code> etc.</p>
<p>If you want to run these tests, you have to make sure the option <code>--enable-tap-tests</code> has been configured. for example,<br><code>./configure --prefix=$HOME/pgapp --enable-tap-tests --enable-debug CFLAGS=&quot;-g3 -O0 -fno-omit-frame-pointer&quot;</code></p>
<p>You can run the TAP test using either <code>make check</code> or <code>make installcheck</code>, but compared with those non-TAP tests, the different is that these TAP tests will always start a test server even you run <code>make installcheck</code>. Because of this different, some tests may take a longer time than you expected, and even worse, if some test cases failed in the middle then the entire test will stop, and your test cases may never get the chance to run. For example, I changed somethings related to the recovery features, and those changes suppose to be tested by test cases <code>021_row_visibility.pl</code> and <code>025_stuck_on_old_timeline.pl</code>, but whenever I run <code>make check</code> or <code>make installcheck</code>, it ends up with something like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">t&#x2F;001_stream_rep.pl .................. ok     </span><br><span class="line">t&#x2F;002_archiving.pl ................... ok   </span><br><span class="line">t&#x2F;003_recovery_targets.pl ............ ok   </span><br><span class="line">t&#x2F;004_timeline_switch.pl ............. ok   </span><br><span class="line">t&#x2F;005_replay_delay.pl ................ ok   </span><br><span class="line">t&#x2F;006_logical_decoding.pl ............ ok     </span><br><span class="line">t&#x2F;007_sync_rep.pl .................... ok     </span><br><span class="line">t&#x2F;008_fsm_truncation.pl .............. ok   </span><br><span class="line">t&#x2F;009_twophase.pl .................... ok     </span><br><span class="line">t&#x2F;010_logical_decoding_timelines.pl .. ok     </span><br><span class="line">t&#x2F;011_crash_recovery.pl .............. ok   </span><br><span class="line">t&#x2F;012_subtransactions.pl ............. ok     </span><br><span class="line">t&#x2F;013_crash_restart.pl ............... ok     </span><br><span class="line">t&#x2F;014_unlogged_reinit.pl ............. ok     </span><br><span class="line">t&#x2F;015_promotion_pages.pl ............. ok   </span><br><span class="line">t&#x2F;016_min_consistency.pl ............. ok   </span><br><span class="line">t&#x2F;017_shm.pl ......................... ok   </span><br><span class="line">t&#x2F;018_wal_optimize.pl ................ ok     </span><br><span class="line">t&#x2F;019_replslot_limit.pl .............. 11&#x2F;20 Bailout called.  Further testing stopped:  pg_ctl start failed</span><br><span class="line">FAILED--Further testing stopped: pg_ctl start failed</span><br><span class="line">Makefile:23: recipe for target &#39;check&#39; failed</span><br><span class="line">make: *** [check] Error 255</span><br></pre></td></tr></table></figure>
<p>Now, <code>019_replslot_limit.pl</code> always failed in the middle, but those test cases to verify my changes haven’t got the chance to run yet.</p>
<h4 id="3-How-to-run-a-specific-test"><a href="#3-How-to-run-a-specific-test" class="headerlink" title="3. How to run a specific test?"></a>3. How to run a specific test?</h4><p>To run a specific test cases, the key is to use a variable <code>PROVE_TESTS</code> provided by PostgreSQL. Details can be found at <a href="https://www.postgresql.org/docs/14/regress-tap.html" target="_blank" rel="noopener">TAP Tests</a>. This <code>PROVE_TESTS</code> variable allow to define a whitespace separated list of paths to run the specified subset of tests instead of the default t/*.pl. For example: in above case, you can run <code>make check PROVE_TESTS=&#39;t/021_row_visibility.pl t/025_stuck_on_old_timeline.pl&#39;</code>. It will run these two test cases directly. The output is something like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">recovery$ make check PROVE_TESTS&#x3D;&#39;t&#x2F;021_row_visibility.pl t&#x2F;025_stuck_on_old_timeline.pl&#39; </span><br><span class="line">make -C ..&#x2F;..&#x2F;..&#x2F;src&#x2F;backend generated-headers</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#39;</span><br><span class="line">make -C catalog distprep generated-header-symlinks</span><br><span class="line">make[2]: Entering directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#x2F;catalog&#39;</span><br><span class="line">make[2]: Nothing to be done for &#39;distprep&#39;.</span><br><span class="line">make[2]: Nothing to be done for &#39;generated-header-symlinks&#39;.</span><br><span class="line">make[2]: Leaving directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#x2F;catalog&#39;</span><br><span class="line">make -C utils distprep generated-header-symlinks</span><br><span class="line">make[2]: Entering directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#x2F;utils&#39;</span><br><span class="line">make[2]: Nothing to be done for &#39;distprep&#39;.</span><br><span class="line">make[2]: Nothing to be done for &#39;generated-header-symlinks&#39;.</span><br><span class="line">make[2]: Leaving directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#x2F;utils&#39;</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;backend&#39;</span><br><span class="line">rm -rf &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#39;&#x2F;tmp_install</span><br><span class="line">&#x2F;bin&#x2F;mkdir -p &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#39;&#x2F;tmp_install&#x2F;log</span><br><span class="line">make -C &#39;..&#x2F;..&#x2F;..&#39; DESTDIR&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#39;&#x2F;tmp_install install &gt;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#39;&#x2F;tmp_install&#x2F;log&#x2F;install.log 2&gt;&amp;1</span><br><span class="line">make -j1  checkprep &gt;&gt;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#39;&#x2F;tmp_install&#x2F;log&#x2F;install.log 2&gt;&amp;1</span><br><span class="line">rm -rf &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39;&#x2F;tmp_check</span><br><span class="line">&#x2F;bin&#x2F;mkdir -p &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39;&#x2F;tmp_check</span><br><span class="line">cd . &amp;&amp; TESTDIR&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39; PATH&#x3D;&quot;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;tmp_install&#x2F;home&#x2F;sandbox&#x2F;pgapp&#x2F;bin:$PATH&quot; LD_LIBRARY_PATH&#x3D;&quot;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;tmp_install&#x2F;home&#x2F;sandbox&#x2F;pgapp&#x2F;lib:$LD_LIBRARY_PATH&quot;  PGPORT&#x3D;&#39;65432&#39; PG_REGRESS&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#x2F;..&#x2F;..&#x2F;..&#x2F;src&#x2F;test&#x2F;regress&#x2F;pg_regress&#39; &#x2F;usr&#x2F;bin&#x2F;prove -I ..&#x2F;..&#x2F;..&#x2F;src&#x2F;test&#x2F;perl&#x2F; -I .  t&#x2F;021_row_visibility.pl t&#x2F;025_stuck_on_old_timeline.pl</span><br><span class="line">t&#x2F;021_row_visibility.pl ......... ok     </span><br><span class="line">t&#x2F;025_stuck_on_old_timeline.pl .. ok   </span><br><span class="line">All tests successful.</span><br><span class="line">Files&#x3D;2, Tests&#x3D;11, 13 wallclock secs ( 0.01 usr  0.00 sys +  1.73 cusr  4.03 csys &#x3D;  5.77 CPU)</span><br><span class="line">Result: PASS</span><br></pre></td></tr></table></figure>

<p>Of course, if you know the makefile very well, you can also do it on your own way. For example, by looking at the output, you can simply do in below steps to achieve the same results.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -rf &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39;&#x2F;tmp_check</span><br><span class="line"></span><br><span class="line">mkdir -p &#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39;&#x2F;tmp_check</span><br><span class="line"></span><br><span class="line">recovery$ cd . &amp;&amp; TESTDIR&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#39; PATH&#x3D;&quot;&#x2F;home&#x2F;sandbox&#x2F;pgapp&#x2F;bin:$PATH&quot; PGPORT&#x3D;&#39;65432&#39; top_builddir&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#x2F;..&#x2F;..&#x2F;..&#39; PG_REGRESS&#x3D;&#39;&#x2F;home&#x2F;sandbox&#x2F;sharedsm&#x2F;src&#x2F;test&#x2F;recovery&#x2F;..&#x2F;..&#x2F;..&#x2F;src&#x2F;test&#x2F;regress&#x2F;pg_regress&#39; &#x2F;usr&#x2F;bin&#x2F;prove -I ..&#x2F;..&#x2F;..&#x2F;src&#x2F;test&#x2F;perl&#x2F; -I .  t&#x2F;021_row_visibility.pl </span><br><span class="line">t&#x2F;021_row_visibility.pl .. ok     </span><br><span class="line">All tests successful.</span><br><span class="line">Files&#x3D;1, Tests&#x3D;10,  5 wallclock secs ( 0.02 usr  0.00 sys +  0.81 cusr  1.42 csys &#x3D;  2.25 CPU)</span><br><span class="line">Result: PASS</span><br></pre></td></tr></table></figure>


<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>In this blog, I explained how to run a specific test case by using variable <code>PROVE_TESTS</code> for TAP test. You can also run the test manually to skip some tests either take too much time or may failed in the middle and block your test cases. </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/10/15/what-is-backup-label/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/15/what-is-backup-label/" class="post-title-link" itemprop="url">Backup Label in PostgreSQL</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-10-15 01:00:00 / Modified: 15:35:50" itemprop="dateCreated datePublished" datetime="2021-10-15T01:00:00-07:00">2021-10-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/basebackup/" itemprop="url" rel="index">
                    <span itemprop="name">basebackup</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/basebackup/label/" itemprop="url" rel="index">
                    <span itemprop="name">label</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/basebackup/label/start/" itemprop="url" rel="index">
                    <span itemprop="name">start</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/basebackup/label/start/stop/" itemprop="url" rel="index">
                    <span itemprop="name">stop</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/basebackup/label/start/stop/tools/" itemprop="url" rel="index">
                    <span itemprop="name">tools</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-backup-label.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>When I was working on some backup and recovery related features for a project based on Postgres, I noticed that there is file called <code>backup_label</code>. By quickly google search, you can find some very nice blogs or books which discussed this topic, such as, <a href="https://www.interdb.jp/pg/pgsql10.html" target="_blank" rel="noopener">The Internals of PostgreSQL</a>, one of my favourite books. In this blog, I am going to talk it a little more based on my experience.</p>
<h4 id="2-What-is-backup-label"><a href="#2-What-is-backup-label" class="headerlink" title="2. What is backup_label?"></a>2. What is backup_label?</h4><p>The <code>backup_label</code> is a file created in $PGDATA folder when there is an <code>exclusive backup</code> triggered by <code>pg_start_backup()</code> and the backup is in progress. This <code>backup_label</code> file will be removed once the <code>pg_stop_backup()</code> is executed. Here, the <code>exclusive backup</code> is one of the backup methods introduced to Postgres early, and as the name indicated, it does not support multiple backup activities at the same time. Because of this limitation, a frontend backup tool <code>pg_basebackup</code> is added to the Postgres later. This <code>pg_basebackup</code> client does allow multiple backup activities performed at the same time. Therefore, this kind of backup is called as <code>non-exclusive backup</code>. Both backup methods use the <code>backup_label</code> but in a different way.</p>
<p>In exclusive basebackup, the <code>backup_label</code> will be generated automatically on the source server side. To see how this file looks like, you can run a command like, <code>select pg_start_backup(&#39;first backup&#39;);</code> from a psql console. Then you should be able to find a <code>backup_label</code> file in $PGDATA folder with the content like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">START WAL LOCATION: 0&#x2F;6000028 (file 000000010000000000000006)</span><br><span class="line">CHECKPOINT LOCATION: 0&#x2F;6000060</span><br><span class="line">BACKUP METHOD: pg_start_backup</span><br><span class="line">BACKUP FROM: master</span><br><span class="line">START TIME: 2021-10-15 13:30:03 PDT</span><br><span class="line">LABEL: first backup</span><br><span class="line">START TIMELINE: 1</span><br></pre></td></tr></table></figure>


<h4 id="3-How-does-it-work"><a href="#3-How-does-it-work" class="headerlink" title="3. How does it work?"></a>3. How does it work?</h4><p>In exclusive backup mode, the Postgres source server will generate this file when <code>pg_sart_backup()</code> is executed, and removed after <code>pg_stop_backup()</code>, however, in non-executive backup mode, such as using <code>pg_basebackup</code> client to perform a base backup, the <code>backup_label</code> is only streamed to the client side but not physical saved to the source Postgres server. </p>
<p>As you can see in above <code>baseup_label</code> file, it contains a similar checkpoint information compared to pg_controldata file. If a backup is used in recovery with this backup_label file present, then Postgres will use the checkpoint in backup_label to start the REDO process. The reason is that there could be multiple checkpoints happening during the backup process. After the recovery process is done, this <code>backup_label</code> file will be renamed as <code>backup_label.old</code> to indelicate the recovery finished properly. In simple words, with the <code>backup_label</code> file, the database has a consistent checkpoint to recover from a proper archive.</p>
<h4 id="4-Does-it-impact-any-frontend-tool"><a href="#4-Does-it-impact-any-frontend-tool" class="headerlink" title="4. Does it impact any frontend tool?"></a>4. Does it impact any frontend tool?</h4><p>The answer is <code>yes</code>. Some frontend tools will perform differently if a <code>backup_label</code> file is present. For example, if <code>pg_ctl</code> sees a <code>backup_label</code> file during smart shutdown process, it will wait for it to be removed by providing a waring message to the end user with something like,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARNING: online backup mode is active</span><br><span class="line">Shutdown will not complete until pg_stop_backup() is called</span><br></pre></td></tr></table></figure>
<p>Another example is the frontend tool <code>pg_rewind</code> which creates a <code>backup_label</code> to force a recovery to start from the last common checkpoint. </p>
<h4 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h4><p>In this blog, I explained the <code>backup_label</code> file in Postgres. I believe the end users won’t pay attention to it most of the time, but if you do encounter some issues related with <code>backup_label</code> then I hope this blog can give you some clues.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/09/17/a-quick-test-for-postgres-fdw-batch-insertion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/17/a-quick-test-for-postgres-fdw-batch-insertion/" class="post-title-link" itemprop="url">A quick test for postgres_fdw batch insertion</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-17 01:00:00 / Modified: 16:20:32" itemprop="dateCreated datePublished" datetime="2021-09-17T01:00:00-07:00">2021-09-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/" itemprop="url" rel="index">
                    <span itemprop="name">foreign data wrapper</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/" itemprop="url" rel="index">
                    <span itemprop="name">fdw</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/bulk/" itemprop="url" rel="index">
                    <span itemprop="name">bulk</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/bulk/batch/" itemprop="url" rel="index">
                    <span itemprop="name">batch</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/bulk/batch/insert/" itemprop="url" rel="index">
                    <span itemprop="name">insert</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi_bulk_insertion.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>In my previous <a href="https://www.highgo.ca/2021/08/20/how-batch-insertion-was-done-in-postgres_fdw/" target="_blank" rel="noopener">blog</a>, I briefly walked through how the bulk/batch insertion was done for postgres_fdw in PG14. In this blog, I am going to run some basic tests to compare the performance for before and after the batch insertion was introduced in postgres_fdw, so that we can have a general idea about whether this feature makes any difference.</p>
<h4 id="2-PG-Servers-Setup"><a href="#2-PG-Servers-Setup" class="headerlink" title="2. PG Servers Setup"></a>2. PG Servers Setup</h4><p>The key of the blog is to see if there is any difference for batch insertion. To make the testing simple, here is how I set up a simple environment. </p>
<p>As this bulk/batch insertion was introduced for PG14, so we need to switch to the stable PG14 branch, i.e. REL_14_STABLE. After checked out the source code, simply run the commands: <code>configure, make and make install</code>. Here are the commands used in this blog.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;$HOME&#x2F;sandbox&#x2F;postgres&#x2F;pgapp --enable-tap-tests --enable-debug CFLAGS&#x3D;&quot;-g3 -O0&quot;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd contrib&#x2F;postgres_fdw&#x2F;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">export PGDATA&#x3D;$HOME&#x2F;sandbox&#x2F;postgres&#x2F;pgdata</span><br><span class="line">initdb -D $PGDATA</span><br><span class="line">pg_ctl -D $PGDATA -l logfile start</span><br></pre></td></tr></table></figure>

<p>In order to test Foreign Data Wrapper, we need to start another PG Server. To make it easy, I simply start a PG Server on a Foreign data cluster and change the default port to a different one, for example, <code>5433</code>. Below are the commands used to setup Foreign Server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FPGDATA&#x3D;$HOME&#x2F;sandbox&#x2F;postgres&#x2F;pgdata2</span><br><span class="line">initdb -D $FPGDATA</span><br></pre></td></tr></table></figure>

<p>After the Foreign data cluster has been initialized, change the port to 5433, then start the Foreign PG Server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim $FPGDATA&#x2F;postgresql.conf </span><br><span class="line">pg_ctl -D $FPGDATA -l logfile-f start</span><br></pre></td></tr></table></figure>


<h4 id="3-Foreign-Tables-Setup"><a href="#3-Foreign-Tables-Setup" class="headerlink" title="3. Foreign Tables Setup"></a>3. Foreign Tables Setup</h4><p>Now, we can setup the basic Foreign Data Wrapper testing environment like below.</p>
<p>On the Local PG Server:</p>
<h5 id="3-1-Create-a-Foreign-Server-using-default-batch-settings"><a href="#3-1-Create-a-Foreign-Server-using-default-batch-settings" class="headerlink" title="3.1. Create a Foreign Server using default batch settings"></a>3.1. Create a Foreign Server using default batch settings</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create server fs foreign data wrapper postgres_fdw options (dbname &#39;postgres&#39;, host &#39;127.0.0.1&#39;, port &#39;5433&#39;);</span><br><span class="line">CREATE SERVER</span><br></pre></td></tr></table></figure>

<h5 id="3-2-Create-the-user-mapping"><a href="#3-2-Create-the-user-mapping" class="headerlink" title="3.2. Create the user mapping"></a>3.2. Create the user mapping</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create user mapping for david server fs options( user &#39;david&#39;);</span><br><span class="line">CREATE USER MAPPING</span><br></pre></td></tr></table></figure>

<h5 id="3-3-Create-Foreign-Tables-on-Local-PG-Server"><a href="#3-3-Create-Foreign-Tables-on-Local-PG-Server" class="headerlink" title="3.3. Create Foreign Tables on Local PG Server"></a>3.3. Create Foreign Tables on Local PG Server</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create foreign table ft (id int, test text) server fs options(table_name &#39;t&#39;);</span><br><span class="line">CREATE FOREIGN TABLE</span><br></pre></td></tr></table></figure>
<p>By default, the batch insertion size has been set to 1 as you can see from the source code.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Determine batch size for a given foreign table. The option specified for</span><br><span class="line"> * a table has precedence.</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int</span><br><span class="line">get_batch_size_option(Relation rel)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    &#x2F;* we use 1 by default, which means &quot;no batching&quot; *&#x2F;</span><br><span class="line">    int         batch_size &#x3D; 1;</span><br></pre></td></tr></table></figure>

<p>Now, repeate the process to create another two Foreign Tables with different batch size correspondingly, i.e. 10 and 100.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create foreign table ft_batch10 (id int, test text) server fs options(batch_size &#39;10&#39;, table_name &#39;t10&#39;);</span><br><span class="line">CREATE FOREIGN TABLE</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create foreign table ft_batch100 (id int, test text) server fs options(batch_size &#39;100&#39;, table_name &#39;t100&#39;);</span><br><span class="line">CREATE FOREIGN TABLE</span><br></pre></td></tr></table></figure>


<h5 id="3-4-Create-Tables-on-Foreign-Server"><a href="#3-4-Create-Tables-on-Foreign-Server" class="headerlink" title="3.4. Create Tables on Foreign Server"></a>3.4. Create Tables on Foreign Server</h5><p>On the Foreign PG Server side, create corresponding tables like below. Notes, you need to make the table names match the ones used in Local PG Server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">psql -d postgres -p 5433</span><br><span class="line">postgres&#x3D;# create table t (id int, test text);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create table t10 (id int, test text);</span><br><span class="line">CREATE TABLE</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# create table t100 (id int, test text);</span><br><span class="line">CREATE TABLE</span><br></pre></td></tr></table></figure>

<h4 id="4-Run-the-tests"><a href="#4-Run-the-tests" class="headerlink" title="4. Run the tests"></a>4. Run the tests</h4><p>Now, enable the timeing on Local PG Server, and simply run the commands below, and then record the timing for comparison.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# \timing </span><br><span class="line">Timing is on.</span><br><span class="line"></span><br><span class="line">insert into ft values(generate_series(1,1000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft;</span><br><span class="line">delete from ft ;</span><br><span class="line">insert into ft values(generate_series(1,1000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft;</span><br><span class="line">delete from ft ;</span><br><span class="line">insert into ft values(generate_series(1,100000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft;</span><br><span class="line">delete from ft ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into ft_batch10 values(generate_series(1,1000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch10;</span><br><span class="line">delete from ft_batch10 ;</span><br><span class="line">insert into ft_batch10 values(generate_series(1,1000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch10;</span><br><span class="line">delete from ft_batch10 ;</span><br><span class="line">insert into ft_batch10 values(generate_series(1,100000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch10;</span><br><span class="line">delete from ft_batch10 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into ft_batch100 values(generate_series(1,1000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch100;</span><br><span class="line">delete from ft_batch100 ;</span><br><span class="line">insert into ft_batch100 values(generate_series(1,1000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch100;</span><br><span class="line">delete from ft_batch100 ;</span><br><span class="line">insert into ft_batch100 values(generate_series(1,100000000),&#39;hello, world&#39;);</span><br><span class="line">select count(*) from ft_batch100;</span><br><span class="line">delete from ft_batch100 ;</span><br></pre></td></tr></table></figure>


<h4 id="5-Check-the-results"><a href="#5-Check-the-results" class="headerlink" title="5. Check the results"></a>5. Check the results</h4><p>Here are results from about tests.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1                               10                          100                         </span><br><span class="line">55.634 ms                       9.996 ms                    25.545 ms </span><br><span class="line">32155.960 ms (00:32.156)        5927.090 ms (00:05.927)     4754.158 ms (00:04.754) </span><br><span class="line">3237972.881 ms (53:57.973)      623204.920 ms (10:23.205)   332998.911 ms (05:32.999)</span><br></pre></td></tr></table></figure>


<h4 id="6-Summary"><a href="#6-Summary" class="headerlink" title="6. Summary"></a>6. Summary</h4><p>In this blog, we simply run some basic tests to see if there is any performance improvement in postgres_fdw for the batch/bulk insertion. The results are very impressive: for 1k insertion, batch size 10 and 100 are 5 and 2 times and faster relatively; for 1 million insertion, batch size 10 and 100 are 5.5 and 6.5 times faser; for 100 millions insertion, batch size 10 and 100 are 5 and 9.5 times better.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/08/20/a-new-feature-walk-through-on-postgres-fdw-from-commits/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/20/a-new-feature-walk-through-on-postgres-fdw-from-commits/" class="post-title-link" itemprop="url">How batch insertion was done in postgres_fdw</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-08-20 01:00:00 / Modified: 16:10:46" itemprop="dateCreated datePublished" datetime="2021-08-20T01:00:00-07:00">2021-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/" itemprop="url" rel="index">
                    <span itemprop="name">foreign data wrapper</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/" itemprop="url" rel="index">
                    <span itemprop="name">fdw</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/bulk/" itemprop="url" rel="index">
                    <span itemprop="name">bulk</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/foreign-data-wrapper/fdw/bulk/insert/" itemprop="url" rel="index">
                    <span itemprop="name">insert</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi_bulk_insertion.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>postgres_fdw has been existing in PostgreSQL for many years, and it was one of the most popular interfaces used in many extensions. such as the <a href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers" target="_blank" rel="noopener">PostgreSQL foreign data wrappers wiki page</a>, and <a href="https://pgxn.org/tag/fdw/" target="_blank" rel="noopener">PostgreSQL Extension Network/PGXN</a>. However, I had not touched this postgres_fdw in deep until I got a task about combing multiple columns from multiple tables using this amazing Foreign Data Wrapper interface. After some hack, I was be able to combine multiple columns from multiple tables into one table based on postgres_fdw, but I was just curious about how many enhancements has been done recently. After a simple git pull, I found actually there are some new features was introduced in PG14, such as Asynchronous Execution, Bulk Inserts, Truncate as well as some network connection related enhancement. In this blog, I will take a detail look at one of the enhancements, i.e. Bulk insertion, to see how it was implemented.</p>
<h4 id="2-A-detail-looks-at-bulk-insertion"><a href="#2-A-detail-looks-at-bulk-insertion" class="headerlink" title="2. A detail looks at bulk insertion"></a>2. A detail looks at bulk insertion</h4><p>I haven’t performed any benchmark test for bulk inserts in postgres_fdw to compare before and after yet, but you can find a very nice blog <a href="https://www.percona.com/blog/2021/05/27/new-features-in-postgresql-14-bulk-inserts-for-foreign-data-wrappers/" target="_blank" rel="noopener">here</a> as your reference, if I have time I will definitely run some benchmark test on a production server. For now, let’s take a look to see how it was implemented.</p>
<p>The first commit was done early 2021, and here is the details information about this features.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">commit b663a4136331de6c7364226e3dbf7c88bfee7145</span><br><span class="line">Author: Tomas Vondra &lt;tomas.vondra@postgresql.org&gt;</span><br><span class="line">Date:   Wed Jan 20 23:05:46 2021 +0100</span><br><span class="line"></span><br><span class="line">    Implement support for bulk inserts in postgres_fdw</span><br><span class="line">    </span><br><span class="line">    Extends the FDW API to allow batching inserts into foreign tables. That</span><br><span class="line">    is usually much more efficient than inserting individual rows, due to</span><br><span class="line">    high latency for each round-trip to the foreign server.</span><br><span class="line">    </span><br><span class="line">    It was possible to implement something similar in the regular FDW API,</span><br><span class="line">    but it was inconvenient and there were issues with reporting the number</span><br><span class="line">    of actually inserted rows etc. This extends the FDW API with two new</span><br><span class="line">    functions:</span><br><span class="line">    </span><br><span class="line">    * GetForeignModifyBatchSize - allows the FDW picking optimal batch size</span><br><span class="line">    </span><br><span class="line">    * ExecForeignBatchInsert - inserts a batch of rows at once</span><br><span class="line">    </span><br><span class="line">    Currently, only INSERT queries support batching. Support for DELETE and</span><br><span class="line">    UPDATE may be added in the future.</span><br><span class="line">    </span><br><span class="line">    This also implements batching for postgres_fdw. The batch size may be</span><br><span class="line">    specified using &quot;batch_size&quot; option both at the server and table level.</span><br><span class="line">    </span><br><span class="line">    The initial patch version was written by me, but it was rewritten and</span><br><span class="line">    improved in many ways by Takayuki Tsunakawa.</span><br><span class="line">    </span><br><span class="line">    Author: Takayuki Tsunakawa</span><br><span class="line">    Reviewed-by: Tomas Vondra, Amit Langote</span><br><span class="line">    Discussion: https:&#x2F;&#x2F;postgr.es&#x2F;m&#x2F;20200628151002.7x5laxwpgvkyiu3q@development</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">As the author commented, two major functions, i.e. &#96;postgresGetForeignModifyBatchSize&#96; and &#96;postgresExecForeignBatchInsert&#96; were introduced to postgres_fdw to hook up with the extended FDW API. The extended FDW API can be found in &#96;src&#x2F;include&#x2F;foreign&#x2F;fdwapi.h&#96;.</span><br><span class="line"></span><br><span class="line">The corresponding implementation was done in &#96;contrib&#x2F;postgres_fdw&#x2F;postgres_fdw.c&#96;. </span><br><span class="line">Single row insertion</span><br></pre></td></tr></table></figure>
<p>static TupleTableSlot *<br>postgresExecForeignInsert(EState *estate,<br>                          ResultRelInfo *resultRelInfo,<br>                          TupleTableSlot *slot,<br>                          TupleTableSlot *planSlot)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vs. batch rows insertion</span><br></pre></td></tr></table></figure>
<p>static TupleTableSlot **<br>postgresExecForeignBatchInsert(EState <em>estate,<br>                          ResultRelInfo *resultRelInfo,<br>                          TupleTableSlot *</em>slots,<br>                          TupleTableSlot **planSlots,<br>                          int *numSlots)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Function postgresExecForeignBatchInsert support multiple slots, planSlots as well as a new parameter, i.e. numSlots. So that it can insert multiple rows in one round communication to save the network communication overhead.</span><br></pre></td></tr></table></figure>
<p>static int<br>postgresGetForeignModifyBatchSize(ResultRelInfo *resultRelInfo)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The function basically allows to retrieve the number of row remote server will support in bulk insertion. Here, as the function has a note, if there is trigger defined for remote table with AFTER ROW or with RETURNING required, the bulk insertion is not allowed, otherwise the rule will be broken on remote server side.</span><br><span class="line"></span><br><span class="line">Other than these two major new functions, there are some update in other functions, such as, &#96;execute_foreign_modify&#96;, which will build the bulk insertion query when it received insert operation, something like below.</span><br></pre></td></tr></table></figure>
<pre><code>if (operation == CMD_INSERT &amp;&amp; fmstate-&gt;num_slots != *numSlots)</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and another important change is &#96;convert_prep_stmt_params&#96; which has a loop to build the number of rows that server can accept.</span><br></pre></td></tr></table></figure>
<pre><code>for (i = 0; i &lt; numSlots; i++)</code></pre><pre><code>
Then rest of the changes are mainly to support the bulk insertion features, such as parse the `batch_size` in option. Another new function, `rebuildInsertSql` in `deparse.c` is used in `execute_foreign_modify` to build the actual number of rows before sending the query to remote server.


#### 3. Limitation

As it was mentioned in the commit message, only insertion is supported for bulk operations, delete and update are not supported yet. Hopefully, these bulk operations and interfaces can be added soon. So that, there will be even more extensions using FDW interface in the future.



#### 4. Summary
In this blog, we discussed a key performance improvement in postgres_fdw, i.e. bulk insertion and take a detail look at the source code level. I hope it can help when someone want to add a new feature to postgres_fdw or any continue improvement on bulk insertion.


_**Reference:**_
1. [F.35. postgres_fdw](https://www.postgresql.org/docs/14/postgres-fdw.html)
2. [Faster Bulk Insertion to Foreign Tables - Introduction to PostgreSQL 14 Committed Features](http://postgres-road.blogspot.com/2021/03/faster-bulk-insertion-to-foreign-tables.html)
3. [New Features in PostgreSQL 14: Bulk Inserts for Foreign Data Wrappers](https://www.percona.com/blog/2021/05/27/new-features-in-postgresql-14-bulk-inserts-for-foreign-data-wrappers/)
</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/07/23/the-amazing-buffer-tag-in-PG/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/23/the-amazing-buffer-tag-in-PG/" class="post-title-link" itemprop="url">The Amazing Buffer Tag in PostgreSQL</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-07-23 01:00:00 / Modified: 14:49:52" itemprop="dateCreated datePublished" datetime="2021-07-23T01:00:00-07:00">2021-07-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/buffer-tag/" itemprop="url" rel="index">
                    <span itemprop="name">buffer tag</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/buffer-tag/hashtable/" itemprop="url" rel="index">
                    <span itemprop="name">hashtable</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/buffer-tag/hashtable/lookup/" itemprop="url" rel="index">
                    <span itemprop="name">lookup</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi_buffer_tag.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>I was working on the PostgreSQL storage related features recently, and I found PostgreSQL has designed an amazing storage addressing mechanism, i.e. Buffer Tag. In this blog, I want to share with you my understanding about the Buffer Tag and some potential usage of it.</p>
<h4 id="2-Buffer-Tag"><a href="#2-Buffer-Tag" class="headerlink" title="2. Buffer Tag"></a>2. Buffer Tag</h4><p>I was always curious to know how PostgreSQl can find out the tuple data blocks so quickly when the first time I started to use PostgreSQL in an IoT project, but I never got the chance to look it into details even though I knew PostgreSQL is an very well organized open-source project. Until I recently got a task which needs to solve some storage related issue in PostgreSQL. There is very detailed explanation about how Buffer Manger works in an online PostgreSQL books for developers <a href="https://www.interdb.jp/pg/index.html" target="_blank" rel="noopener">The Internals of PostgreSQL</a>, one of the best PostgreSQL books I would recommend to the beginner of PostgreSQL development to read.</p>
<p>Buffer Tag, in simple words, is just five numbers. Why it is five numbers? First, all the objects including the storage files are managed by Object Identifiers, i.e. OID. For example, when user creates a table, the table name is mapped to an OID; when user creates a database, the name is mapped to an OID; when the corresponding data need to be persistent on disk, the files is also named using OID. Secondly, when a table requires more pages to store more tuples, then each page for the same table is managed by the page number in sequence. For example, when PostgreSQL needs to estimate the table size before decide what kind of scan should be used to find out the tuple faster, it need to know the number of blocks information. Thirdly, it is easy to understand that data tuples are the major user data need to be stored, but in order to better manage these data tuples, PostgreSQL needs others information, such as visibility to manage the status of these data tuples, and free space to optimize files usage. So this ends up with five numbers, i.e. Tablespace, Database, Table, ForkNumber, BlockNumber. </p>
<p>Given these five numbers, PostgreSQL can always find out where the data tuples are stored, which file is used, and what size the table is etc. </p>
<h4 id="3-How-Buffer-Tag-is-used"><a href="#3-How-Buffer-Tag-is-used" class="headerlink" title="3. How Buffer Tag is used"></a>3. How Buffer Tag is used</h4><p>Now, we have the buffer tag, five numbers, but how it is used in PosggreSQL. One typical use case of buffer tag is to help buffer manager to manage the location of memory blocks in the buffer pool/array. In this case, a hash table was introduced to resolve the mapping between buffer tag and the location of memory block in buffer pool/array. Here is a picture to show relationship among buffer tag, hashtable, buffer descriptor, and buffer pool/array.</p>
<p><img src="/images/img/buffer-tag-mapping.png" alt="Buffer Tag Mapping"></p>
<p>For example, the first green buffer tag {(1663, 13589, 16387), 0, 0} indicates a table space 1663, a database 12709, and a table 16387 with forkNumber 0 (main fork for tuples) which stored in a file at block 0. The buffer tag has a hash value 1536704684 which has been assigned to the memory block 0 managed by buffer manager at this moment. Since buffer descriptor is addressed using the same slot number as memory block in buffer pool/array, so they both share the same slot number 0, in this case.</p>
<p>With the above relationship, PostgreSQL can find out the memory block location or assign buffer slot to a new memory block for particular buffer tag.</p>
<p>The other typical use case of buffer tag is to help the storage manager to manage the corresponding files. In this case, the blockNumber is always to 0 since it doesn’t require multiple blocks to store more data. Here, you can create your use case of buffer tag. For example, use the buf_id as the number of blocks for each database relation instead of using it to indicate the memory block location. Moreover, you can also use the buffer tag plus the hashtable to manage multiple information such as having both buf_id for location of the memory block and adding a new attribute total to manage the number of blocks. You can achieve this by define a different buffer lookup entry. For example, </p>
<p>The original buffer lookup entry using buffer tag to lookup the location of memory block.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* entry for buffer lookup hashtable *&#x2F;</span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">    BufferTag   key;            &#x2F;* Tag of a disk page *&#x2F;</span><br><span class="line">    int         id;             &#x2F;* Associated buffer ID *&#x2F;</span><br><span class="line">&#125; BufferLookupEnt;</span><br></pre></td></tr></table></figure>

<p>Below is an example of buffer lookup entry which can lookup both the location of memory block and the number of blocks used by this particular buffer tag.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">    BufferTag   key;            &#x2F;* Tag of a disk page    *&#x2F;</span><br><span class="line">    int         id;             &#x2F;* Associated buffer ID  *&#x2F;</span><br><span class="line">    int         total;          &#x2F;* the total number of X *&#x2F;</span><br><span class="line">&#125; ESRelLookupEnt;</span><br><span class="line">&#96;</span><br></pre></td></tr></table></figure>

<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>In this blog, we discussed what is Buffer Tag, how it is used in PostgreSQL and some potential usage of Buffer Tag to address the mapping issues between tables to storage files as well as the lookup issues.</p>
<p><em><strong>Reference:</strong></em></p>
<ol>
<li><a href="https://www.interdb.jp/pg/index.html" target="_blank" rel="noopener">The Internals of PostgreSQL</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/03/03/how-to-create-a-system-info-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/03/how-to-create-a-system-info-function/" class="post-title-link" itemprop="url">How to create a system information function in PostgreSQL</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-03-03 00:00:00 / Modified: 15:19:02" itemprop="dateCreated datePublished" datetime="2021-03-03T00:00:00-08:00">2021-03-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/" itemprop="url" rel="index">
                    <span itemprop="name">WAL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/Streaming/" itemprop="url" rel="index">
                    <span itemprop="name">Streaming</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/Streaming/Replication/" itemprop="url" rel="index">
                    <span itemprop="name">Replication</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi_sys_info_fun.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL supports many System Information Functions, such as Session Information Functions, Access Privilege Inquiry Functions, Schema Visibility Inquiry Functions, System Catalog Information Functions, Transaction ID and Snapshot Information Functions, etc. However, you may want build some special functions and integrate them into the PostgreSQL. This blog is going to walk through the steps about how to build your own System Information Functions into PostgreSQL.</p>
<h4 id="2-Analyze-the-requirement"><a href="#2-Analyze-the-requirement" class="headerlink" title="2. Analyze the requirement"></a>2. Analyze the requirement</h4><p>Since there are so many functions built-in PostgreSQL already, you should perform some research and analysis before you decide to create a new one. In this blog, I want to check the transaction id after each savepoints in an ongoing transaction, so that I can perform some visibility check before the whole transaction is committed. For example, I have a query like below, but I can’t figure out the transaction id after each savepoint if I use existing System Information Function .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# CREATE TABLE tbl (data text);</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# BEGIN;</span><br><span class="line">BEGIN</span><br><span class="line">postgres&#x3D;# INSERT INTO tbl VALUES(&#39;HelloWorld-1&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# SELECT txid_current();</span><br><span class="line"> txid_current </span><br><span class="line">--------------</span><br><span class="line">          488</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SAVEPOINT AA;</span><br><span class="line">SAVEPOINT</span><br><span class="line">postgres&#x3D;# INSERT INTO tbl VALUES(&#39;HelloWorld-2&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT txid_current();</span><br><span class="line"> txid_current </span><br><span class="line">--------------</span><br><span class="line">          488</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>
<p>As you can see, I always get the same Transaction ID even after a savepoint using existing txid_current() function. In this case, I decide to create my own system information function to retrieve the information I want.</p>
<h4 id="3-System-Information-Function-template"><a href="#3-System-Information-Function-template" class="headerlink" title="3. System Information Function template"></a>3. System Information Function template</h4><p>To create your own System Information Function, you need to check the System Catalogs to see in which category it can fit. For the case mentioned above, I chose the catalog <a href="https://www.postgresql.org/docs/13/catalog-pg-proc.html" target="_blank" rel="noopener">pg_proc</a> which stores information about functions, procedures, aggregate functions, and window functions. The document <a href="https://www.postgresql.org/docs/11/system-catalog-initial-data.html" target="_blank" rel="noopener">System Catalog Initial Data</a> provides more detailed description and examples about the <code>.dat</code> file format and the rules to define your own OID.</p>
<p>Now, let’s define a function, say <code>current_xid_list();</code>. Below is an example about how the function initial data may look like.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># function to get the top and sub transactions XIDs</span><br><span class="line">&#123; oid &#x3D;&gt; &#39;5566&#39;, descr &#x3D;&gt; &#39;get current transaction list&#39;,</span><br><span class="line">  proname &#x3D;&gt; &#39;current_xid_list&#39;, provolatile &#x3D;&gt; &#39;s&#39;,</span><br><span class="line">  prorettype &#x3D;&gt; &#39;txid_snapshot&#39;, proargtypes &#x3D;&gt; &#39;&#39;,</span><br><span class="line">  prosrc &#x3D;&gt; &#39;current_xid_list&#39; &#125;,</span><br></pre></td></tr></table></figure>

<p>Here, you need to generate your OID which doesn’t create any conflict. In the official PostgreSQL document, <a href="https://www.postgresql.org/docs/13/system-catalog-initial-data.html" target="_blank" rel="noopener">69.2.2. OID Assignment</a>, it descripts how the OIDs are managed and also provides a script <code>src/include/catalog/unused_oids</code> to list the unused OIDs. For example, if you run the script like below, you will get a list of OIDs that are not used by PostgreSQL yet.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ src&#x2F;include&#x2F;catalog&#x2F;unused_oids</span><br><span class="line">4 - 9</span><br><span class="line">210</span><br><span class="line">270 - 273</span><br><span class="line">357</span><br><span class="line">380 - 381</span><br><span class="line">421</span><br><span class="line">560 - 583</span><br><span class="line">606</span><br><span class="line">702 - 704</span><br><span class="line">760 - 763</span><br><span class="line">784 - 789</span><br><span class="line">811 - 816</span><br><span class="line">1177</span><br><span class="line">1179 - 1180</span><br><span class="line">1382 - 1383</span><br><span class="line">1986 - 1987</span><br><span class="line">2023</span><br><span class="line">2030</span><br><span class="line">2121</span><br><span class="line">2137</span><br><span class="line">2228</span><br><span class="line">3432</span><br><span class="line">3434 - 3435</span><br><span class="line">3998</span><br><span class="line">4035</span><br><span class="line">4142</span><br><span class="line">4187 - 4199</span><br><span class="line">4225 - 4299</span><br><span class="line">4388 - 4399</span><br><span class="line">4532 - 4565</span><br><span class="line">4572 - 4999</span><br><span class="line">5022 - 5027</span><br><span class="line">5032 - 5554</span><br><span class="line">5556 - 5999</span><br><span class="line">6015 - 6099</span><br><span class="line">6103</span><br><span class="line">6105</span><br><span class="line">6107 - 6109</span><br><span class="line">6116</span><br><span class="line">6122 - 9999</span><br></pre></td></tr></table></figure>
<p>In my case, I picked the OID 5566 just for easy to remember. However, if you are planning to generate a System Information Function as patch and later submit to PostgreSQL community, then you better follow the rule to minimize the risk of OID collisions with other patches. What the PostgreSQL community recommended is a random OID number between <code>8000—9999</code>. Here how it is described in the official document, <code>When choosing OIDs for a patch that is not expected to be committed immediately, best practice is to use a group of more-or-less consecutive OIDs starting with some random choice in the range 8000—9999.</code> </p>
<p>After this system information initial data definition, we need to define the actual c function which can help to retrieve the information we need. In the case above, there might be a bunch of SAVEPOINTs in one transaction, so we need return a list of those ongoing transaction IDs. Below is an example, which refer to the way that how the function <code>txid_current_snapshot</code> was built.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Same as txid_current_snapshot(), but returns top and sub transactions list</span><br><span class="line"> *</span><br><span class="line"> *      Return current top and sub transactions in TXID format</span><br><span class="line"> *</span><br><span class="line"> * Note that both top-transaction and sub-transaction XIDs are included.</span><br><span class="line"> *&#x2F;</span><br><span class="line">Datum</span><br><span class="line">current_xid_list(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">    TxidSnapshot *snap;</span><br><span class="line">    uint32      nxip,</span><br><span class="line">                i;</span><br><span class="line">    TxidEpoch   state;</span><br><span class="line">    Snapshot    cur;</span><br><span class="line">    xl_xact_assignment *sublist;</span><br><span class="line">    TransactionId curxid &#x3D; GetCurrentTransactionIdIfAny();</span><br><span class="line"></span><br><span class="line">    cur &#x3D; GetActiveSnapshot();</span><br><span class="line">    if (cur &#x3D;&#x3D; NULL)</span><br><span class="line">        elog(ERROR, &quot;no active snapshot set&quot;);</span><br><span class="line"></span><br><span class="line">    load_xid_epoch(&amp;state);</span><br><span class="line"></span><br><span class="line">    StaticAssertStmt(MAX_BACKENDS * 2 &lt;&#x3D; TXID_SNAPSHOT_MAX_NXIP,</span><br><span class="line">                     &quot;possible overflow in txid_current_snapshot()&quot;);</span><br><span class="line"></span><br><span class="line">    &#x2F;* allocate *&#x2F;</span><br><span class="line">    nxip &#x3D; cur-&gt;xcnt;</span><br><span class="line">    snap &#x3D; palloc(TXID_SNAPSHOT_SIZE(nxip));</span><br><span class="line">    sublist &#x3D; palloc(MinSizeOfXactAssignment);</span><br><span class="line"></span><br><span class="line">    &#x2F;* fill *&#x2F;</span><br><span class="line">    GetCurrentSubTransactionIdList(sublist);</span><br><span class="line">    snap-&gt;xmin &#x3D; sublist-&gt;xtop;</span><br><span class="line">    snap-&gt;xmax &#x3D; curxid;</span><br><span class="line">    snap-&gt;nxip &#x3D; sublist-&gt;nsubxacts;</span><br><span class="line">    for (i &#x3D; 0; i &lt; snap-&gt;nxip; i++)</span><br><span class="line">        snap-&gt;xip[i] &#x3D; sublist-&gt;xsub[i];</span><br><span class="line"></span><br><span class="line">    sort_snapshot(snap);</span><br><span class="line"></span><br><span class="line">    &#x2F;* set size after sorting, because it may have removed duplicate xips *&#x2F;</span><br><span class="line">    SET_VARSIZE(snap, TXID_SNAPSHOT_SIZE(snap-&gt;nxip));</span><br><span class="line"></span><br><span class="line">    PG_RETURN_POINTER(snap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the above function, you can define your data format. We decided to define a function which can help retrieve the transaction IDs within current transaction.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * GetCurrentSubTransactionIdList</span><br><span class="line"> *&#x2F;</span><br><span class="line">void</span><br><span class="line">GetCurrentSubTransactionIdList(xl_xact_assignment *list)</span><br><span class="line">&#123;</span><br><span class="line">   TransactionState s &#x3D; CurrentTransactionState;</span><br><span class="line"></span><br><span class="line">   list-&gt;nsubxacts &#x3D; 0;</span><br><span class="line">   list-&gt;xtop &#x3D; GetTopTransactionIdIfAny();</span><br><span class="line"></span><br><span class="line">   for (s &#x3D; CurrentTransactionState; s !&#x3D; NULL; s &#x3D; s-&gt;parent)</span><br><span class="line">   &#123;</span><br><span class="line">       if (s-&gt;state &#x3D;&#x3D; TRANS_ABORT)</span><br><span class="line">           continue;</span><br><span class="line">       if (!FullTransactionIdIsValid(s-&gt;fullTransactionId))</span><br><span class="line">           continue;</span><br><span class="line"></span><br><span class="line">       list-&gt;xsub[list-&gt;nsubxacts++] &#x3D; s-&gt;fullTransactionId.value;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, if you recompile PostgreSQL with above changes (of course, you need to declare the functions in proper files), you should be able to use your own System Information Function to see the difference based on what we has discussed at the beginning.</p>
<h4 id="4-Testing"><a href="#4-Testing" class="headerlink" title="4. Testing"></a>4. Testing</h4><p>Once build success, restart the PostgreSQL server. Now, let’s try the previous SQL query again. As you can see, a different transaction ID <code>489</code> after a checkpoint is showing up.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# INSERT INTO tbl VALUES(&#39;HelloWorld-1&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# SELECT txid_current();</span><br><span class="line"> txid_current </span><br><span class="line">--------------</span><br><span class="line">          488</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SAVEPOINT AA;</span><br><span class="line">SAVEPOINT</span><br><span class="line">postgres&#x3D;# INSERT INTO tbl VALUES(&#39;HelloWorld-2&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT txid_current();</span><br><span class="line"> txid_current </span><br><span class="line">--------------</span><br><span class="line">          488</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# SELECT current_xid_list();</span><br><span class="line"> current_xid_list </span><br><span class="line">------------------</span><br><span class="line"> 488:489:488,489</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>If you add another savepoint, and then compare your newly added function <code>current_xid_list()</code> with existing <code>txid_current()</code>, you can see that <code>current_xid_list()</code> displays not only the top transaction ID, but also all the transaction IDs after each savepoint. </p>
<h4 id="8-Summary"><a href="#8-Summary" class="headerlink" title="8. Summary"></a>8. Summary</h4><p>In this blog, we discussed PostgreSQL System Information Functions, and perform a simple walk-through about how to create your own System Information Function following the official document, and run some simple tests.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2021/02/03/how-to-setup-wal-streaming-replication-for-postgresql13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/03/how-to-setup-wal-streaming-replication-for-postgresql13/" class="post-title-link" itemprop="url">How to setup Postgres 13 WAL streaming replication on Ubuntu 18.04</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-02-03 00:00:00 / Modified: 11:59:44" itemprop="dateCreated datePublished" datetime="2021-02-03T00:00:00-08:00">2021-02-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/" itemprop="url" rel="index">
                    <span itemprop="name">WAL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/Streaming/" itemprop="url" rel="index">
                    <span itemprop="name">Streaming</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/WAL/Streaming/Replication/" itemprop="url" rel="index">
                    <span itemprop="name">Replication</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-wal-streaming.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL supports different type of replications, i.e. logical and physical. There are many tutorials discussed about the replications. This blog is a simply walk-through of the WAL Streaming replication using the latest Postgresql-13 on Ubuntu 18.04.</p>
<h4 id="2-Install-Postgresql-13-from-source-code"><a href="#2-Install-Postgresql-13-from-source-code" class="headerlink" title="2. Install Postgresql-13 from source code"></a>2. Install Postgresql-13 from source code</h4><p>In this blog, we will install Postgresql from the source code, so that this environment can be used for later development. Simply prepare two Ubuntu 18.04 using VirtualBox with below <a href="/images/img/wal-streaming-net.png">Network settings</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Primary: 192.168.0.181</span><br><span class="line">Standby: 192.168.0.182</span><br></pre></td></tr></table></figure>

<p>It is pretty simple to install postgres from source code. Here we checkout the Postgresql-13 stable branch from github.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir sandbox</span><br><span class="line">$ cd sandbox&#x2F;</span><br><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;postgres&#x2F;postgres</span><br><span class="line">$ cd postgres&#x2F;</span><br><span class="line">$ git checkout REL_13_STABLE</span><br></pre></td></tr></table></figure>

<p>Install the basic build environment on Ubuntu 18.04 and then compile and install Postgres by using below commands,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install -y pkg-config build-essential libreadline-dev bison flex</span><br><span class="line">$ .&#x2F;configure --prefix&#x3D;$HOME&#x2F;sandbox&#x2F;postgres --enable-debug CFLAGS&#x3D;&#39;-ggdb -O0&#39;</span><br><span class="line">$ make clean &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>Setup the environment for Postgres database, for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PGDATA&#x3D;$HOME&#x2F;sandbox&#x2F;pgdata</span><br><span class="line">export PATH&#x3D;$HOME&#x2F;sandbox&#x2F;pgapp&#x2F;bin:$PATH</span><br></pre></td></tr></table></figure>


<h4 id="3-Setup-Primary-Server"><a href="#3-Setup-Primary-Server" class="headerlink" title="3. Setup Primary Server"></a>3. Setup Primary Server</h4><p>In order to setup the WAL streaming replication, first, let’s create a new database by running the command below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initdb -D $PGDATA</span><br></pre></td></tr></table></figure>

<p>then we need to add the permission to <code>pg_hba.conf</code> file to enable a Standby server to access a Primary server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host   replication   all   192.168.0.182&#x2F;32   trust</span><br></pre></td></tr></table></figure>

<p>and then update <code>postgresql.conf</code> file to let the Primary server listen on all network interface so that a standby can connect to it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses &#x3D; &#39;*&#39;</span><br><span class="line"></span><br><span class="line">synchronous_standby_names &#x3D; &#39;*&#39;</span><br></pre></td></tr></table></figure>

<p>After all the changes changes, we can start the Primary server,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl -D $PGDATA -l &#x2F;tmp&#x2F;logfile start</span><br></pre></td></tr></table></figure>


<h4 id="4-Setup-Standby-Server"><a href="#4-Setup-Standby-Server" class="headerlink" title="4. Setup Standby Server"></a>4. Setup Standby Server</h4><p>Once the Primary server is up, we need to create a backup base. This can be done on either Primary side or Standby side. Below is the command we can run on Standby server directly.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_basebackup --pgdata&#x3D;$PGDATA --format&#x3D;p --write-recovery-conf --checkpoint&#x3D;fast --label&#x3D;mffb --progress --host&#x3D;192.168.0.181 --port&#x3D;5432 --username&#x3D;vbox1804</span><br></pre></td></tr></table></figure>

<p>At this point, most of the tutorial will discuss about the <code>recovery.conf</code> setup. However, PG has removed <code>recovery.conf</code> file and merged the corresponding configuration to <code>postgresql.conf</code>. Without knowing this, if you simply follow some old tutorials, you may get an error like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FATAL:  using recovery command file &quot;recovery.conf&quot; is not supported</span><br></pre></td></tr></table></figure>

<p>The reason is that the <code>recovery.conf</code> has been removed and the relevant configuration has been merged into <code>postgresql.conf</code>. For details, please check the commit below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">commit 2dedf4d9a899b36d1a8ed29be5efbd1b31a8fe85</span><br><span class="line">Author: Peter Eisentraut &lt;peter_e@gmx.net&gt;</span><br><span class="line">Date:   Sun Nov 25 16:31:16 2018 +0100</span><br><span class="line"></span><br><span class="line">    Integrate recovery.conf into postgresql.conf</span><br><span class="line">    </span><br><span class="line">    recovery.conf settings are now set in postgresql.conf (or other GUC</span><br><span class="line">    sources).  Currently, all the affected settings are PGC_POSTMASTER;</span><br><span class="line">    this could be refined in the future case by case.</span><br><span class="line">    </span><br><span class="line">    Recovery is now initiated by a file recovery.signal.  Standby mode is</span><br><span class="line">    initiated by a file standby.signal.  The standby_mode setting is</span><br><span class="line">    gone.  If a recovery.conf file is found, an error is issued.</span><br><span class="line">    </span><br><span class="line">    The trigger_file setting has been renamed to promote_trigger_file as</span><br><span class="line">    part of the move.</span><br><span class="line">    </span><br><span class="line">    The documentation chapter &quot;Recovery Configuration&quot; has been integrated</span><br><span class="line">    into &quot;Server Configuration&quot;.</span><br><span class="line">    </span><br><span class="line">    pg_basebackup -R now appends settings to postgresql.auto.conf and</span><br><span class="line">    creates a standby.signal file.</span><br><span class="line">    </span><br><span class="line">    Author: Fujii Masao &lt;masao.fujii@gmail.com&gt;</span><br><span class="line">    Author: Simon Riggs &lt;simon@2ndquadrant.com&gt;</span><br><span class="line">    Author: Abhijit Menon-Sen &lt;ams@2ndquadrant.com&gt;</span><br><span class="line">    Author: Sergei Kornilov &lt;sk@zsrv.org&gt;</span><br><span class="line">    Discussion: https:&#x2F;&#x2F;www.postgresql.org&#x2F;message-id&#x2F;flat&#x2F;607741529606767@web3g.yandex.ru&#x2F;</span><br></pre></td></tr></table></figure>


<p>Now, let’s just make a simple change for some basic parameters to Standby Server <code>postgresql.conf</code> file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">primary_conninfo &#x3D; &#39;host&#x3D;192.168.0.181 port&#x3D;5432 user&#x3D;xbox1804 password&#x3D;mypassword&#39; # connection string to sending server</span><br><span class="line">primary_slot_name &#x3D; &#39;standby1_slot&#39;     # replication slot on sending server</span><br></pre></td></tr></table></figure>


<h4 id="5-Create-replication-slot-on-Primary-Server"><a href="#5-Create-replication-slot-on-Primary-Server" class="headerlink" title="5. Create replication slot on Primary Server"></a>5. Create replication slot on Primary Server</h4><p>In order to allow the Standby to connect to Primary, we need to create the corresponding replication slot like below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# select * from pg_create_physical_replication_slot(&#39;standby1_slot&#39;);</span><br><span class="line">   slot_name   | lsn </span><br><span class="line">---------------+-----</span><br><span class="line"> standby1_slot | </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# select slot_name, slot_type, active, wal_status from pg_replication_slots;</span><br><span class="line">   slot_name   | slot_type | active | wal_status </span><br><span class="line">---------------+-----------+--------+------------</span><br><span class="line"> standby1_slot | physical  | f      | </span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>



<h4 id="6-Start-Standby-Server"><a href="#6-Start-Standby-Server" class="headerlink" title="6. Start Standby Server"></a>6. Start Standby Server</h4><p>Once the replication slot has been created i.e. ‘standby1_slot’, let’s start the Standby server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_ctl -D $PGDATA -l &#x2F;tmp&#x2F;logfile start</span><br></pre></td></tr></table></figure>

<p>If the Standby server is setup properly, then you should see below message from the log file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOG:  started streaming WAL from primary at 0&#x2F;3000000 on timeline 1</span><br></pre></td></tr></table></figure>

<p>Now, if you check the replication slot on Primary server again, you should see the replication slot is <code>active</code> and the <code>wal_status</code> has been changed to <code>reserved</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# select slot_name, slot_type, active, wal_status from pg_replication_slots;</span><br><span class="line">   slot_name   | slot_type | active | wal_status </span><br><span class="line">---------------+-----------+--------+------------</span><br><span class="line"> standby1_slot | physical  | t      | reserved</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>



<h4 id="7-Test-WAL-Streaming-replication"><a href="#7-Test-WAL-Streaming-replication" class="headerlink" title="7. Test WAL Streaming replication"></a>7. Test WAL Streaming replication</h4><p>After all the settings has been done properly, we can start a simple test to verify the wal streaming replication setup.<br>First, let’s check if there is any relations on Primary server, for example,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# \d</span><br><span class="line">Did not find any relations.</span><br></pre></td></tr></table></figure>

<p>You can do the same check on Standby server side. After that, let’s create a table on Primary server,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create table tbl1(id int, text varchar(10));</span><br><span class="line">CREATE TABLE</span><br><span class="line">postgres&#x3D;# \d</span><br><span class="line">        List of relations</span><br><span class="line"> Schema | Name | Type  |  Owner   </span><br><span class="line">--------+------+-------+----------</span><br><span class="line"> public | tbl1 | table | vbox1804</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>

<p>Then simply insert one record like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# insert into tbl1 values (1, &#39;helloworld&#39;);</span><br><span class="line">INSERT 0 1</span><br><span class="line">postgres&#x3D;# select * from tbl1;</span><br><span class="line"> id |    text    </span><br><span class="line">----+------------</span><br><span class="line">  1 | helloworld</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>


<p>Now, if you check on the Standby server, you should be able to see the table and a record have been replicated.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# \d</span><br><span class="line">Did not find any relations.</span><br><span class="line">postgres&#x3D;# \d</span><br><span class="line">        List of relations</span><br><span class="line"> Schema | Name | Type  |  Owner   </span><br><span class="line">--------+------+-------+----------</span><br><span class="line"> public | tbl1 | table | vbox1804</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;# select * from tbl1;</span><br><span class="line"> id |    text    </span><br><span class="line">----+------------</span><br><span class="line">  1 | helloworld</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">postgres&#x3D;#</span><br></pre></td></tr></table></figure>



<h4 id="8-Summary"><a href="#8-Summary" class="headerlink" title="8. Summary"></a>8. Summary</h4><p>This blog simply walk-through a very basic WAL streaming replication, if you want to know more about the replication, you can always check it out on <a href="https://www.postgresql.org/docs/13/runtime-config-replication.html" target="_blank" rel="noopener">Postgresql official website</a>.</p>
<p><em><strong>Reference:</strong></em> </p>
<p><a href="https://wiki.postgresql.org/wiki/Binary_Replication_Tutorial" target="_blank" rel="noopener">1. Database World</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://idrawone.github.io/2020/12/14/how-to-dump-a-backtrace-at-runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="David Zhang">
      <meta itemprop="description" content="knowledge is power">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="David's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/14/how-to-dump-a-backtrace-at-runtime/" class="post-title-link" itemprop="url">How to dump out a backtrace at runtime</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-14 00:00:00 / Modified: 15:57:03" itemprop="dateCreated datePublished" datetime="2020-12-14T00:00:00-08:00">2020-12-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/" itemprop="url" rel="index">
                    <span itemprop="name">PostgreSQL</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Debug/" itemprop="url" rel="index">
                    <span itemprop="name">Debug</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PostgreSQL/Debug/Backtrace/" itemprop="url" rel="index">
                    <span itemprop="name">Backtrace</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/img/fi-gdb-backtrace.png" alt="Featured image"></p>
<h4 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1. Overview"></a>1. Overview</h4><p>PostgreSQL is a great open source database developed and maintained by many great software engineers around the world. In each release, there are many features added to this open source database. For example, one feature is very helpful for developer is <code>backtrace_functions</code> introduced in <a href="https://www.postgresql.org/docs/release/13.0/" target="_blank" rel="noopener">PostgreSQL 13</a> , which allows a developer to dump out the <code>backtrace</code> when certain errors happened on the server. In this blog, I am going to explain it in a little bit more detail.</p>
<h4 id="2-What-is-backtrace-functions"><a href="#2-What-is-backtrace-functions" class="headerlink" title="2. What is backtrace_functions?"></a>2. What is <code>backtrace_functions</code>?</h4><p>The <code>backtrace_functions</code> option is an option introduced for developers as it is described <a href="https://www.postgresql.org/docs/13/runtime-config-developer.html" target="_blank" rel="noopener">here</a>. You can specify a list of c function names separated by comma, if an error is raised and matches any c function in the given list, then the backtrace will be logged into the logfile. This is very useful for debugging some specific areas of the source code, especially when the error happens randomly. As the document also mentioned, this option is not available on all platforms, and quality of the backtraces depends on the compilation options. For this reason, all the examples used in this blog were tested on Ubuntu 18.04 with gcc version 7.5.0.</p>
<h4 id="3-How-to-make-it-work"><a href="#3-How-to-make-it-work" class="headerlink" title="3. How to make it work?"></a>3. How to make it work?</h4><p>This feature was first committed in Nov, 2019 as showing below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">commit 71a8a4f6e36547bb060dbcc961ea9b57420f7190</span><br><span class="line">Author: Alvaro Herrera &lt;alvherre@alvh.no-ip.org&gt;</span><br><span class="line">Date:   Fri Nov 8 15:44:20 2019 -0300</span><br><span class="line"></span><br><span class="line">    Add backtrace support for error reporting</span><br></pre></td></tr></table></figure>

<p>To use this feature, you need to add the key word <code>backtrace_functions</code> to <code>postgresql.conf</code> file with the c function names. It can be either a single c function name or a list of c function names separated by comma. In this blog, we use <code>circle_in</code> as an example. Here is what I added to my <code>postgresql.conf</code> file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tail -n1 $PGDATA&#x2F;postgresql.conf</span><br><span class="line">backtrace_functions&#x3D;&#39;circle_in&#39;</span><br></pre></td></tr></table></figure>
<p>After restart the server, use <code>psql</code> connect to the server and enter below SQL queries (The postgresql source code used in this example is based on PostgreSQL13 development branch in March 2020, you can create your own error if you want to test this feature). </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postgres&#x3D;# create temp table src (f1 text);</span><br><span class="line">postgres&#x3D;# INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br><span class="line">ERROR:  invalid input syntax for type circle: &quot;( 1 , 1 ) , 5&quot;</span><br><span class="line">LINE 1: INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br></pre></td></tr></table></figure>
<p>An error is raised, now, if you dump the logfile, <code>$ cat logfile</code> you should see something like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2020-12-14 13:43:22.541 PST [25220] ERROR:  invalid input syntax for type circle: &quot;( 1 , 1 ) , 5&quot; at character 34</span><br><span class="line">2020-12-14 13:43:22.541 PST [25220] BACKTRACE:  </span><br><span class="line">    postgres: david postgres [local] INSERT(circle_in+0x1ca) [0x55bc1cdfaa8a]</span><br><span class="line">    postgres: david postgres [local] INSERT(InputFunctionCall+0x7b) [0x55bc1cec375b]</span><br><span class="line">    postgres: david postgres [local] INSERT(OidInputFunctionCall+0x48) [0x55bc1cec39c8]</span><br><span class="line">    postgres: david postgres [local] INSERT(coerce_type+0x19a) [0x55bc1cb9d72a]</span><br><span class="line">    postgres: david postgres [local] INSERT(coerce_to_target_type+0x9d) [0x55bc1cb9e0ed]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x1c748f) [0x55bc1cba248f]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformExpr+0x14) [0x55bc1cba59f4]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformExpressionList+0x9f) [0x55bc1cbb273f]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformStmt+0x1a47) [0x55bc1cb782d7]</span><br><span class="line">    postgres: david postgres [local] INSERT(parse_analyze+0x4f) [0x55bc1cb7957f]</span><br><span class="line">    postgres: david postgres [local] INSERT(pg_analyze_and_rewrite+0x12) [0x55bc1cd9fd62]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x3c531f) [0x55bc1cda031f]</span><br><span class="line">    postgres: david postgres [local] INSERT(PostgresMain+0x1f04) [0x55bc1cda25b4]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x34c168) [0x55bc1cd27168]</span><br><span class="line">    postgres: david postgres [local] INSERT(PostmasterMain+0xeff) [0x55bc1cd2827f]</span><br><span class="line">    postgres: david postgres [local] INSERT(main+0x4a4) [0x55bc1ca9b4e4]</span><br><span class="line">    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6(__libc_start_main+0xe7) [0x7f6c22eeab97]</span><br><span class="line">    postgres: david postgres [local] INSERT(_start+0x2a) [0x55bc1ca9b5aa]</span><br><span class="line">2020-12-14 13:43:22.541 PST [25220] STATEMENT:  INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br></pre></td></tr></table></figure>
<p>As we can see the error is happening in <code>circle_in</code> function, which is called by function <code>InputFunctionCall</code>, so on and so forth. This is exactly like the backtrace when you are debugging the source code using gdb, but you may also find that some function names are showing up as a hex string, such as <code>0x3c531f</code>. The reason some function names are not showing up is because they are static functions. For these functions, we need to use the <code>addr2line</code> to convert the addresses into file names and line numbers. For example, </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addr2line 0x3c531f -f -e &#96;which postgres&#96;</span><br></pre></td></tr></table></figure>
<p>, where <code>-f</code>  displays the function names as well as file and line number, <code>-e</code> used to specify the name of the executable for which addresses should be translated.</p>
<p>It depends on the compilation parameters, if you compile the postgre with default CFLAG, you may get something like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ addr2line 0x3c531f -f -e &#96;which postgres&#96;</span><br><span class="line">exec_simple_query</span><br><span class="line">postgres.c:?</span><br></pre></td></tr></table></figure>
<p>Where the line number doesn’t show up. To get the line number and file name, let’s add the option <code>-ggdb</code> to <code>CFLAGS</code> and then recompile the source code.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure &#39;--prefix&#x3D;&#x2F;home&#x2F;david&#x2F;pgapp&#39; &#39;CFLAGS&#x3D;-ggdb&#39;</span><br></pre></td></tr></table></figure>

<p>Now, if you repeat the above test, then you should get a similar backtrace like below,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">2020-12-14 13:56:28.780 PST [3459] ERROR:  invalid input syntax for type circle: &quot;( 1 , 1 ) , 5&quot; at character 34</span><br><span class="line">2020-12-14 13:56:28.780 PST [3459] BACKTRACE:  </span><br><span class="line">    postgres: david postgres [local] INSERT(circle_in+0x275) [0x56522b34137f]</span><br><span class="line">    postgres: david postgres [local] INSERT(InputFunctionCall+0xe9) [0x56522b457d39]</span><br><span class="line">    postgres: david postgres [local] INSERT(OidInputFunctionCall+0x4b) [0x56522b45805f]</span><br><span class="line">    postgres: david postgres [local] INSERT(stringTypeDatum+0x5e) [0x56522afe3220]</span><br><span class="line">    postgres: david postgres [local] INSERT(coerce_type+0x312) [0x56522afc055b]</span><br><span class="line">    postgres: david postgres [local] INSERT(coerce_to_target_type+0x95) [0x56522afc017b]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x237e37) [0x56522afcde37]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x232606) [0x56522afc8606]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformExpr+0x3a) [0x56522afc83a2]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformExpressionList+0x133) [0x56522afdee38]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x1ecf87) [0x56522af82f87]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformStmt+0x96) [0x56522af821ac]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x1ec114) [0x56522af82114]</span><br><span class="line">    postgres: david postgres [local] INSERT(transformTopLevelStmt+0x27) [0x56522af8200f]</span><br><span class="line">    postgres: david postgres [local] INSERT(parse_analyze+0x73) [0x56522af81e85]</span><br><span class="line">    postgres: david postgres [local] INSERT(pg_analyze_and_rewrite+0x49) [0x56522b2c1bcb]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x52c2b5) [0x56522b2c22b5]</span><br><span class="line">    postgres: david postgres [local] INSERT(PostgresMain+0x813) [0x56522b2c6895]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x4889d7) [0x56522b21e9d7]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x488111) [0x56522b21e111]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x48469f) [0x56522b21a69f]</span><br><span class="line">    postgres: david postgres [local] INSERT(PostmasterMain+0x1283) [0x56522b219e5a]</span><br><span class="line">    postgres: david postgres [local] INSERT(+0x395c54) [0x56522b12bc54]</span><br><span class="line">    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6(__libc_start_main+0xe7) [0x7f3fc9817b97]</span><br><span class="line">    postgres: david postgres [local] INSERT(_start+0x2a) [0x56522ae4d40a]</span><br><span class="line">2020-12-14 13:56:28.780 PST [3459] STATEMENT:  INSERT INTO tbl_circle(a) VALUES(&#39;( 1 , 1 ) , 5&#39;::circle );</span><br></pre></td></tr></table></figure>
<p>Let’s run the command <code>addr2line</code> with the new hex address string again,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ addr2line 0x52c2b5 -f -e &#96;which postgres&#96;</span><br><span class="line">exec_simple_query</span><br><span class="line">&#x2F;home&#x2F;david&#x2F;postgres&#x2F;src&#x2F;backend&#x2F;tcop&#x2F;postgres.c:1155</span><br></pre></td></tr></table></figure>
<p>Now, we get the function name, file name and the line number.</p>
<h4 id="4-Summary"><a href="#4-Summary" class="headerlink" title="4. Summary"></a>4. Summary</h4><p>This blog simply discussed one very useful option introduced to PostgreSQL 13 for developers. I use this option a lot during my daily development work, and it helps me quickly locate the errors. I also use this feature when someone reports an error which happens randomly. To debug such issue, I simply enable it with the c function names. When the error happens again, then I can get the exactly backtrace. The <code>backtrace_functions</code> does make my work much easier when tracing a bug.</p>
<p><em><strong>Reference:</strong></em> </p>
<p><a href="https://amitdkhan-pg.blogspot.com/2020/07/backtraces-in-postgresql.html" target="_blank" rel="noopener">1. Database World</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="David Zhang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">David Zhang</p>
  <div class="site-description" itemprop="description">knowledge is power</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">categories</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
